<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Investment Manager</title>
    <!-- Add a simple data URI favicon to prevent 404 errors -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ’°</text></svg>">
    <!-- <link rel="stylesheet" href="styles.css"> --> <!-- All styles are now inline -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* Modern Fintech Ã— Crypto-Native Design System */
        

        
        :root {
            /* Dark Mode Foundation */
            --bg-primary: #0a0b0d;
            --bg-secondary: #111318;
            --bg-tertiary: #1a1d24;
            --bg-card: #1e2128;
            --bg-elevated: #252830;
            
            /* Fluorescent Accents */
            --accent-orange: #ff6b35;
            --accent-green: #00d4aa;
            --accent-purple: #8b5cf6;
            --accent-blue: #3b82f6;
            
            /* Text Colors */
            --text-primary: #e2e8f0; /* High contrast white-gray for excellent readability */
            --text-secondary: #94a3b8; /* Improved secondary text contrast */
            --text-muted: #64748b; /* Better muted text contrast */
            --text-highlight: #ffffff; /* Pure white for emphasis */
            --text-success: #00d4aa;
            --text-danger: #ff4757;
            
            /* Borders & Dividers */
            --border-primary: #2d3139;
            --border-secondary: #3d4148;
            --border-accent: #ff6b35;
            
            /* Shadows */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 20px rgba(255, 107, 53, 0.3);
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, var(--accent-orange) 0%, var(--accent-green) 100%);
            --gradient-card: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-elevated) 100%);
            --gradient-success: linear-gradient(135deg, var(--accent-green) 0%, #00b894 100%);
        }

        /* Base Overrides */
        * {
            box-sizing: border-box;
        }

        body {
            background: var(--bg-primary) !important;
            color: var(--text-primary) !important;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif !important;
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        /* App Layout */
        .app {
            background: var(--bg-primary);
            min-height: 100vh;
        }

        /* Manager View */
        .manager-view {
            background: var(--bg-primary) !important;
            color: var(--text-primary) !important;
        }

        .manager-header {
            background: var(--bg-secondary) !important;
            border-bottom: 1px solid var(--border-primary) !important;
            padding: 1rem 2rem !important;
        }

        .manager-header h1 {
            color: var(--text-primary) !important;
            font-size: 1.5rem !important;
            font-weight: 700 !important;
            margin: 0 !important;
        }

        .manager-header .header-stats {
            gap: 2rem !important;
        }

        .manager-header .stat-item {
            color: var(--text-secondary) !important;
        }

        .manager-header .stat-value {
            color: var(--text-primary) !important;
            font-weight: 600 !important;
        }

        /* Navigation */

        /* Cards */
        .card {
            background: var(--gradient-card) !important;
            border: 1px solid var(--border-primary) !important;
            border-radius: 20px !important;
            padding: 2rem !important;
            margin-bottom: 2rem !important;
            box-shadow: var(--shadow-md) !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            position: relative !important;
            overflow: hidden !important;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover {
            border-color: var(--border-accent) !important;
            transform: translateY(-4px) !important;
            box-shadow: var(--shadow-lg) !important;
        }

        .card:hover::before {
            opacity: 1;
        }

        .card h2, .card h3 {
            color: var(--text-primary) !important;
            margin-top: 0 !important;
            margin-bottom: 2rem !important;
            font-weight: 700 !important;
            font-size: 1.5rem !important;
            letter-spacing: -0.025em !important;
        }

        .card h3 {
            font-size: 1.25rem !important;
            margin-bottom: 1.5rem !important;
        }

        /* Summary Dashboard */
        .summary-dashboard {
            background: var(--gradient-card) !important;
            border: 1px solid var(--border-accent) !important;
            border-radius: 24px !important;
            box-shadow: var(--shadow-glow) !important;
            position: relative !important;
            overflow: hidden !important;
        }

        .summary-dashboard::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .summary-metric {
            background: var(--bg-elevated) !important;
            border: 1px solid var(--border-primary) !important;
            border-radius: 16px !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            position: relative !important;
            overflow: hidden !important;
        }

        .summary-metric::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .summary-metric .metric-value {
            color: var(--text-highlight) !important; /* Pure white for numbers */
            font-weight: 700 !important; /* Bold numbers */
            font-size: 2rem !important;
        }

        .summary-metric .metric-label {
            color: var(--text-secondary) !important; /* Light gray for labels */
            font-weight: 500 !important; /* Slightly bolder labels */
            text-transform: uppercase !important;
            letter-spacing: 0.05em !important;
            font-size: 0.875rem !important;
        }

        /* Clickable Metrics */
        .clickable-metric:hover {
            transform: translateY(-6px) !important;
            box-shadow: var(--shadow-lg) !important;
            border-color: var(--accent-orange) !important;
            background: linear-gradient(135deg, var(--bg-elevated) 0%, var(--bg-card) 100%) !important;
        }

        .clickable-metric:hover::before {
            opacity: 1;
        }

        .clickable-metric:hover .metric-value {
            color: var(--text-highlight) !important;
        }

        .clickable-metric .metric-label::after {
            content: " ðŸ‘†";
            opacity: 0;
            transition: opacity 0.2s;
        }

        .clickable-metric:hover .metric-label::after {
            opacity: 1;
        }

        /* Buttons */
        .btn {
            font-family: inherit !important;
            font-weight: 600 !important;
            border-radius: 12px !important;
            padding: 0.875rem 1.75rem !important;
            border: none !important;
            cursor: pointer !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            text-decoration: none !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 0.5rem !important;
            position: relative !important;
            overflow: hidden !important;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }
        
        /* Small button variant for compact UI elements */
        .btn-sm {
            padding: 0.375rem 0.75rem !important;
            font-size: 0.75rem !important;
            border-radius: 8px !important;
            min-height: auto !important;
        }

        .btn-primary {
            background: var(--gradient-primary) !important;
            color: var(--text-highlight) !important;
            box-shadow: var(--shadow-sm) !important;
        }

        .btn-primary:hover {
            transform: translateY(-3px) !important;
            box-shadow: var(--shadow-md) !important;
        }

        .btn-secondary {
            background: var(--bg-elevated) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-secondary) !important;
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary) !important;
            border-color: var(--accent-orange) !important;
            transform: translateY(-3px) !important;
        }

        /* Landing page specific styles */
        .login-screen h1 {
            font-size: clamp(2.5rem, 8vw, 4rem) !important;
        }

        .login-screen .btn:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        .btn-secondary[style*="accent-green"]:hover {
            background: var(--accent-green) !important;
            color: var(--bg-primary) !important;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .login-screen .login-container {
                padding: 2rem 1rem !important;
            }
            
            .login-screen h1 {
                font-size: 2.5rem !important;
            }
            
            .login-screen .btn {
                min-width: 100% !important;
                margin-bottom: 1rem !important;
            }
            
            .login-screen > div[style*="flex"] {
                flex-direction: column !important;
                gap: 1rem !important;
            }
        }

        /* Tables */
        .data-table {
            width: 100% !important;
            border-collapse: collapse !important;
            background: transparent !important;
        }

        .data-table th {
            background: var(--bg-secondary) !important;
            color: var(--text-secondary) !important;
            font-weight: 600 !important;
            padding: 1rem !important;
            text-align: left !important;
            border-bottom: 1px solid var(--border-primary) !important;
            font-size: 0.875rem !important;
            text-transform: uppercase !important;
            letter-spacing: 0.05em !important;
        }

        .data-table td {
            padding: 1rem !important;
            border-bottom: 1px solid var(--border-primary) !important;
            color: var(--text-primary) !important; /* Now uses the updated medium gray color */
            font-weight: 500 !important; /* Slightly bolder for better readability */
        }

        .data-table th {
            color: var(--text-secondary) !important; /* Light gray for headers */
            font-weight: 600 !important;
            padding: 1rem !important;
        }

        .data-table tr:hover td {
            color: var(--text-highlight) !important; /* Pure white on hover */
            background: var(--bg-elevated) !important; /* Subtle background highlight */
        }

        .data-table tr:hover {
            background: var(--bg-secondary) !important;
        }

        .data-table tr[style*="cursor: pointer"]:hover {
            background: var(--bg-tertiary) !important;
            transform: scale(1.01) !important;
            transition: all 0.2s ease !important;
        }

        /* Positive/Negative Values */
        .positive {
            color: var(--text-success) !important;
            font-weight: 600 !important;
        }

        .negative {
            color: var(--text-danger) !important;
            font-weight: 600 !important;
        }

        /* Modals - Hidden by default, shown when active */
        .modal {
            display: none !important;
            position: fixed !important;
            z-index: 1000 !important;
            left: 0 !important;
            top: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0, 0, 0, 0.8) !important;
            backdrop-filter: blur(8px) !important;
        }
        
        .modal.active {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        .modal-content {
            background: var(--gradient-card) !important;
            border: 1px solid var(--border-secondary) !important;
            border-radius: 16px !important;
            box-shadow: var(--shadow-lg) !important;
            animation: modalSlideIn 0.3s ease !important;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal h2 {
            color: var(--text-primary) !important;
        }

        .modal .close {
            color: var(--text-secondary) !important;
            font-size: 1.5rem !important;
        }

        .modal .close:hover {
            color: var(--accent-orange) !important;
        }

        /* Form Elements */
        .form-group label {
            color: var(--text-primary) !important;
            font-weight: 600 !important;
            margin-bottom: 0.5rem !important;
            display: block !important;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            background: var(--bg-secondary) !important;
            border: 1px solid var(--border-primary) !important;
            color: var(--text-primary) !important;
            border-radius: 8px !important;
            padding: 0.75rem !important;
            width: 100% !important;
            transition: all 0.2s ease !important;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none !important;
            border-color: var(--accent-orange) !important;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1) !important;
        }

        /* Autocomplete Styles */
        .autocomplete-container {
            position: relative !important;
        }

        .autocomplete-suggestions {
            position: absolute !important;
            top: 100% !important;
            left: 0 !important;
            right: 0 !important;
            background: var(--bg-secondary) !important;
            border: 1px solid var(--border-primary) !important;
            border-top: none !important;
            border-radius: 0 0 8px 8px !important;
            max-height: 200px !important;
            overflow-y: auto !important;
            z-index: 1000 !important;
            display: none !important;
        }

        .autocomplete-suggestion {
            padding: 0.75rem !important;
            cursor: pointer !important;
            color: var(--text-primary) !important;
            transition: background-color 0.2s ease !important;
            border-bottom: 1px solid var(--border-secondary) !important;
        }

        .autocomplete-suggestion:hover,
        .autocomplete-suggestion.highlighted {
            background: var(--bg-tertiary) !important;
        }

        .autocomplete-suggestion:last-child {
            border-bottom: none !important;
        }



        /* Asset Dropdown */
        .asset-dropdown {
            background: var(--bg-elevated) !important;
            border: 1px solid var(--border-secondary) !important;
            border-radius: 8px !important;
            box-shadow: var(--shadow-lg) !important;
        }

        .asset-result:hover {
            background: var(--bg-tertiary) !important;
        }

        /* Modern Portfolio Styles */
        .portfolio-section {
            max-width: 1200px !important;
            margin: 0 auto !important;
            padding: 2rem !important;
        }

        .portfolio-header {
            display: flex !important;
            align-items: center !important;
            margin-bottom: 2rem !important;
        }

        .portfolio-brand {
            display: flex !important;
            align-items: center !important;
            gap: 1rem !important;
        }

        .brand-circle {
            width: 48px !important;
            height: 48px !important;
            background: var(--accent-green) !important;
            border-radius: 50% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-weight: 700 !important;
            font-size: 1rem !important;
            color: var(--bg-primary) !important;
        }

        .portfolio-title {
            font-size: 2.5rem !important;
            font-weight: 700 !important;
            color: var(--text-highlight) !important;
            margin: 0 !important;
        }

        .portfolio-value-card {
            background: var(--bg-elevated) !important;
            border: 1px solid var(--border-primary) !important;
            border-radius: 16px !important;
            padding: 2rem !important;
            margin-bottom: 2rem !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
        }

        .portfolio-value-content {
            flex: 1 !important;
        }

        .value-label {
            font-size: 0.9rem !important;
            color: var(--text-secondary) !important;
            text-transform: uppercase !important;
            letter-spacing: 0.1em !important;
            margin-bottom: 0.5rem !important;
        }

        .total-value {
            font-size: 3.5rem !important;
            font-weight: 700 !important;
            color: var(--text-highlight) !important;
            margin-bottom: 0.5rem !important;
        }

        .portfolio-change .positive {
            color: var(--accent-green) !important;
            font-weight: 600 !important;
        }

        .portfolio-actions {
            display: flex !important;
            gap: 1rem !important;
        }

        .portfolio-btn {
            padding: 0.75rem 1.5rem !important;
            border-radius: 12px !important;
            font-weight: 600 !important;
            transition: all 0.3s ease !important;
        }
        
        .portfolio-btn:disabled {
            opacity: 0.6 !important;
            cursor: not-allowed !important;
            transform: scale(0.98) !important;
        }

        .assets-section {
            background: var(--bg-elevated) !important;
            border: 1px solid var(--border-primary) !important;
            border-radius: 16px !important;
            overflow: hidden !important;
        }

        .assets-header {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            padding: 1.5rem 2rem !important;
            border-bottom: 1px solid var(--border-primary) !important;
        }

        .assets-title {
            font-size: 1.25rem !important;
            font-weight: 700 !important;
            color: var(--text-primary) !important;
        }

        .assets-count {
            font-size: 0.9rem !important;
            color: var(--text-secondary) !important;
            background: var(--bg-secondary) !important;
            padding: 0.25rem 0.75rem !important;
            border-radius: 12px !important;
        }

        .assets-table-container {
            padding: 0 !important;
        }

        .assets-table-header {
            display: grid !important;
            grid-template-columns: 1.8fr 0.8fr 1fr 0.8fr 0.8fr 0.8fr 1fr 1.2fr 1fr !important;
            gap: 0.8rem !important;
            padding: 1rem 2rem !important;
            border-bottom: 1px solid var(--border-primary) !important;
            background: var(--bg-secondary) !important;
            font-size: 0.8rem !important;
            font-weight: 600 !important;
            color: var(--text-secondary) !important;
            text-transform: uppercase !important;
            letter-spacing: 0.05em !important;
        }

        .assets-table-body {
            padding: 0 !important;
        }

        .asset-row {
            display: grid !important;
            grid-template-columns: 1.8fr 0.8fr 1fr 0.8fr 0.8fr 0.8fr 1fr 1.2fr 1fr !important;
            gap: 0.8rem !important;
            padding: 1.2rem 2rem !important;
            border-bottom: 1px solid var(--border-primary) !important;
            transition: background 0.2s ease !important;
            align-items: center !important;
        }

        .asset-row:hover {
            background: var(--bg-secondary) !important;
        }

        .asset-row:last-child {
            border-bottom: none !important;
        }

        .asset-col-asset {
            display: flex !important;
            align-items: center !important;
        }

        .asset-info {
            display: flex !important;
            align-items: center !important;
            gap: 1rem !important;
        }

        .asset-icon {
            width: 40px !important;
            height: 40px !important;
            border-radius: 50% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            overflow: hidden !important;
            background: var(--bg-secondary) !important;
            border: 1px solid var(--border-primary) !important;
        }

        .asset-icon img {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
            border-radius: 50% !important;
        }

        .asset-icon.fallback {
            background: var(--accent-orange) !important;
            color: white !important;
            font-weight: 700 !important;
            font-size: 1.2rem !important;
        }

        .asset-details {
            display: flex !important;
            flex-direction: column !important;
        }

        .asset-name {
            font-weight: 600 !important;
            color: var(--text-primary) !important;
            font-size: 1rem !important;
        }

        .asset-symbol {
            font-size: 0.85rem !important;
            color: var(--text-secondary) !important;
            text-transform: uppercase !important;
        }

        .asset-col-chain,
        .asset-col-quantity,
        .asset-col-risk,
        .asset-col-location,
        .asset-col-cointype {
            display: flex !important;
            align-items: center !important;
            font-weight: 600 !important;
            color: var(--text-primary) !important;
            justify-content: center !important;
            font-size: 0.85rem !important;
        }

        .asset-col-chain {
            justify-content: center !important;
        }

        .chain-badge {
            background: var(--bg-secondary) !important;
            border: 1px solid var(--border-primary) !important;
            border-radius: 12px !important;
            padding: 4px 8px !important;
            font-size: 0.75rem !important;
            font-weight: 600 !important;
            color: var(--text-secondary) !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
        }

        .chain-badge[data-chain="ethereum"] {
            background: rgba(98, 126, 234, 0.1) !important;
            border-color: rgba(98, 126, 234, 0.3) !important;
            color: #627eea !important;
        }

        .chain-badge[data-chain="solana"] {
            background: rgba(153, 69, 255, 0.1) !important;
            border-color: rgba(153, 69, 255, 0.3) !important;
            color: #9945ff !important;
        }

        .chain-badge[data-chain="hyperliquid"] {
            background: rgba(0, 255, 100, 0.1) !important;
            border-color: rgba(0, 255, 100, 0.3) !important;
            color: #00ff64 !important;
        }

        .asset-col-value {
            color: var(--text-highlight) !important;
            font-weight: 700 !important;
        }

        .asset-col-actions {
            justify-content: flex-start !important;
            gap: 8px !important;
            align-items: center !important;
        }

        .asset-quantity-input {
            background: var(--bg-secondary) !important;
            border: 1px solid var(--border-primary) !important;
            border-radius: 4px !important;
            padding: 4px 8px !important;
            color: var(--text-primary) !important;
            font-size: 0.9rem !important;
            width: 80px !important;
            text-align: right !important;
        }

        .asset-risk-input, .asset-location-input, .asset-cointype-input {
            background: var(--bg-secondary) !important;
            border: 1px solid var(--border-primary) !important;
            border-radius: 4px !important;
            padding: 4px 8px !important;
            color: var(--text-primary) !important;
            font-size: 0.85rem !important;
            width: 100% !important;
        }

        .asset-risk-input:focus, .asset-location-input:focus, .asset-cointype-input:focus {
            outline: none !important;
            border-color: var(--accent-orange) !important;
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1) !important;
        }

        .asset-edit-btn, .asset-save-btn, .asset-cancel-btn, .asset-delete-btn {
            background: none !important;
            border: none !important;
            color: var(--accent-orange) !important;
            cursor: pointer !important;
            font-size: 0.8rem !important;
            padding: 4px 8px !important;
            border-radius: 4px !important;
            transition: all 0.2s !important;
        }

        .asset-edit-btn:hover, .asset-save-btn:hover {
            background: var(--accent-orange) !important;
            color: white !important;
        }

        .asset-cancel-btn {
            color: var(--text-secondary) !important;
        }

        .asset-cancel-btn:hover {
            background: var(--text-secondary) !important;
            color: white !important;
        }

        .asset-delete-btn {
            color: #dc3545 !important;
        }

        .asset-delete-btn:hover {
            background: #dc3545 !important;
            color: white !important;
        }

        /* Responsive Portfolio */
        @media (max-width: 768px) {
            .portfolio-value-card {
                flex-direction: column !important;
                gap: 1.5rem !important;
                text-align: center !important;
            }

            .portfolio-actions {
                justify-content: center !important;
            }

            .assets-table-header,
            .asset-row {
                grid-template-columns: 1fr !important;
                gap: 0.5rem !important;
            }

            .asset-info {
                justify-content: center !important;
            }
        }

        .total-value {
            background: var(--gradient-primary) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
        }

        /* ========================================
           NEW LANDING PAGE DESIGN SYSTEM
           ======================================== */

        /* Login Screen */
        .login-screen {
            background: var(--bg-primary) !important;
        }

        .login-container {
            background: var(--bg-secondary) !important;
            border: 1px solid var(--border-primary) !important;
            border-radius: 16px !important;
            box-shadow: var(--shadow-lg) !important;
        }

        /* Brand Hero */
        .brand-name {
            font-size: 3rem;
            font-weight: 700;
            color: #00ff88; /* Vibrant light green from reference */
            margin: 0 0 0.5rem 0;
            letter-spacing: 0.05em;
        }

        .brand-tagline {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin: 0;
            font-weight: 400;
        }

        /* Login Cards */
        .login-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .login-card:hover {
            border-color: var(--accent-green);
            box-shadow: 0 4px 12px rgba(0, 212, 170, 0.1);
            transform: translateY(-2px);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 1.5rem 0;
        }

        /* Button Hover Effects */
        .manager-btn:hover {
            background: #00cc6a !important; /* Darker green on hover */
            color: #000000 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        }

        .investor-btn:hover {
            background: #ff6b35 !important; /* Darker orange on hover */
            color: #ffffff !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
        }

        /* Primary Investor Login Styling */
        .investor-login-main {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            padding: 2rem;
            margin: 0 auto;
        }

        .investor-login-main h2 {
            color: var(--text-primary);
            margin-bottom: 1.5rem;
        }

        /* Input Field Styling */
        #investorIdInput:focus {
            outline: none;
            border-color: #00ff88 !important;
            box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.1);
        }

        #investorIdInput::placeholder {
            color: var(--text-muted);
            opacity: 0.7;
        }

        /* Manager Access Button Styling */
        .manager-access .manager-btn:hover {
            background: #00cc6a !important; /* Darker green on hover */
            color: #000000 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .login-container {
                max-width: 90% !important;
                padding: 2rem 1.5rem !important;
            }
            
            .brand-name {
                font-size: 2.5rem !important;
            }

            .investor-login-main {
                padding: 1.5rem !important;
            }

            .manager-access {
                position: static !important;
                text-align: center !important;
                margin-top: 2rem !important;
            }

            .manager-access .manager-btn {
                width: 100% !important;
                max-width: 200px !important;
            }
        }

        @media (max-width: 480px) {
            .login-screen {
                padding: 1rem !important;
            }

            .brand-name {
                font-size: 2rem !important;
            }

            .investor-login-main h2 {
                font-size: 1.25rem !important;
            }
        }

        .login-card {
            background: var(--gradient-card) !important;
            border: 1px solid var(--border-primary) !important;
            border-radius: 12px !important;
            transition: all 0.3s ease !important;
        }

        .login-card:hover {
            border-color: var(--accent-orange) !important;
            transform: translateY(-4px) !important;
            box-shadow: var(--shadow-glow) !important;
        }

        .login-card h3 {
            color: var(--text-primary) !important;
        }

        .login-card p {
            color: var(--text-secondary) !important;
        }

        /* Tab Content - Hide by default, show when active */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Better contrast for specific elements */
        .portfolio-value-display .total-value {
            color: var(--text-highlight) !important;
        }

        .portfolio-value-display .last-updated {
            color: var(--text-secondary) !important;
        }

        /* Table improvements */
        .data-table td strong {
            color: var(--text-primary) !important; /* Use same readable color as other text */
            font-weight: 600 !important; /* Keep it bold for emphasis */
        }

        /* Empty state improvements */
        .data-table td[colspan] {
            color: var(--text-secondary) !important;
        }



        /* Modal improvements */
        .modal h2 {
            color: var(--text-highlight) !important;
        }

        /* Asset dropdown improvements */
        .asset-result div:first-child {
            color: var(--text-primary) !important;
        }

        .asset-result div:last-child {
            color: var(--text-secondary) !important;
        }

        .asset-result:hover div:first-child {
            color: var(--text-highlight) !important;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-secondary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-orange);
        }

        /* ========================================
           WAGMI DESIGN SYSTEM - FOUNDATION
           ======================================== */

        :root {
            /* Color Palette */
            --primary-orange: #ff6b35;
            --primary-green: #00d4aa;
            --secondary-purple: #8b5cf6;
            --secondary-blue: #3b82f6;
            
            /* Neutral Colors */
            --neutral-dark: #1a1d23;
            --neutral-surface: #2d3139;
            --neutral-border: #3f3f46;
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            
            /* Status Colors */
            --status-success: #10b981;
            --status-error: #ef4444;
            --status-warning: #f59e0b;
            
            /* Typography */
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-size-xl: 2rem;
            --font-size-l: 1.5rem;
            --font-size-body: 1rem;
            --font-size-caption: 0.875rem;
            --font-weight-normal: 400;
            --font-weight-semibold: 600;
            --line-height: 1.6;
            
            /* Spacing */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            --space-10: 40px;
            --space-12: 48px;
            
            /* Border Radius */
            --radius-button: 8px;
            --radius-card: 16px;
            --radius-modal: 20px;
            
            /* Shadows */
            --shadow-card: 0 4px 12px rgba(0,0,0,0.2);
            --shadow-modal: 0 8px 20px rgba(0,0,0,0.25);
            
            /* Animations */
            --transition-fast: 150ms ease-in-out;
            --transition-normal: 300ms ease-in-out;
            --transition-slow: 400ms ease-in-out;
            --easing: cubic-bezier(0.4,0,0.2,1);
        }

        /* Base Typography */
        body {
            font-family: var(--font-family);
            font-size: var(--font-size-body);
            font-weight: var(--font-weight-normal);
            line-height: var(--line-height);
            color: var(--text-primary);
            background-color: var(--neutral-dark);
            margin: 0;
            padding: 0;
        }

        /* Headings */
        h1, h2, h3, h4, h5, h6 {
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
            margin: 0 0 var(--space-4) 0;
        }

        h1 { font-size: var(--font-size-xl); }
        h2 { font-size: var(--font-size-l); }
        h3 { font-size: var(--font-size-body); }

        /* Base Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-button);
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-body);
            transition: all var(--transition-fast);
            cursor: pointer;
            border: none;
            text-decoration: none;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--primary-green);
            color: white;
            border: 1px solid var(--primary-green);
        }

        .btn-primary:hover {
            background: #00b894;
            border-color: #00b894;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--primary-orange);
            color: white;
            border: 1px solid var(--primary-orange);
        }

        .btn-secondary:hover {
            background: #e55a2b;
            border-color: #e55a2b;
            transform: translateY(-1px);
        }

        .btn-outline {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--neutral-border);
        }

        .btn-outline:hover {
            background: var(--neutral-surface);
            border-color: var(--text-secondary);
        }

        /* Base Card Styles */
        .card {
            background: var(--neutral-surface);
            border: 1px solid var(--neutral-border);
            border-radius: var(--radius-card);
            padding: var(--space-6);
            box-shadow: var(--shadow-card);
            transition: all var(--transition-normal);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        /* Base Input Styles */
        .form-input {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            border: 1px solid var(--neutral-border);
            border-radius: var(--radius-button);
            background: var(--neutral-surface);
            color: var(--text-primary);
            font-size: var(--font-size-body);
            font-family: inherit;
            transition: all var(--transition-fast);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        /* Base Table Styles */
        .table {
            width: 100%;
            border-collapse: collapse;
            background: var(--neutral-surface);
            border-radius: var(--radius-card);
            overflow: hidden;
            box-shadow: var(--shadow-card);
        }

        .table th {
            background: var(--neutral-dark);
            color: var(--text-primary);
            font-weight: var(--font-weight-semibold);
            padding: var(--space-4);
            text-align: left;
            border-bottom: 1px solid var(--neutral-border);
        }

        .table td {
            padding: var(--space-4);
            border-bottom: 1px solid var(--neutral-border);
            color: var(--text-primary);
        }

        .table tbody tr:hover {
            background: rgba(0, 212, 170, 0.05);
        }

        /* Conditional Formatting */
        .positive {
            color: var(--primary-green);
        }

        .negative {
            color: var(--status-error);
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-muted { color: var(--text-muted); }
        .text-secondary { color: var(--text-secondary); }

        .mb-1 { margin-bottom: var(--space-1); }
        .mb-2 { margin-bottom: var(--space-2); }
        .mb-3 { margin-bottom: var(--space-3); }
        .mb-4 { margin-bottom: var(--space-4); }
        .mb-6 { margin-bottom: var(--space-6); }

        .mt-1 { margin-top: var(--space-1); }
        .mt-2 { margin-top: var(--space-2); }
        .mt-3 { margin-top: var(--space-3); }
        .mt-4 { margin-top: var(--space-4); }
        .mt-6 { margin-top: var(--space-6); }

        .p-1 { padding: var(--space-1); }
        .p-2 { padding: var(--space-2); }
        .p-3 { padding: var(--space-3); }
        .p-4 { padding: var(--space-4); }
        .p-6 { padding: var(--space-6); }

        /* KPI Ribbon Component */
        .kpi-ribbon {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-8);
            padding: var(--space-6);
            background: var(--neutral-surface);
            border: 1px solid var(--neutral-border);
            border-radius: var(--radius-card);
            box-shadow: var(--shadow-card);
        }

        .kpi-metric {
            text-align: center;
        }

        .kpi-label {
            font-size: var(--font-size-caption);
            color: var(--text-secondary);
            font-weight: var(--font-weight-semibold);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--space-2);
        }

        .kpi-value {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
            line-height: 1.2;
        }

        .kpi-value.positive {
            color: var(--primary-green);
        }

        .kpi-value.negative {
            color: var(--status-error);
        }
        
        /* Filter Chip Styles */
        .filter-chip {
            position: relative;
            overflow: hidden;
        }
        
        .filter-chip:hover {
            border-color: #00ff88 !important;
            color: #00ff88 !important;
            box-shadow: 0 0 8px rgba(0, 255, 136, 0.3);
        }
        
        .filter-chip.active {
            background: #00ff88 !important;
            color: #000 !important;
            border-color: #00ff88 !important;
            font-weight: 600 !important;
        }
        
        .filter-chip.active.negative {
            background: #ff4757 !important;
            color: #fff !important;
            border-color: #ff4757 !important;
        }
        
        .filter-chip.active.high {
            background: #3742fa !important;
            color: #fff !important;
            border-color: #3742fa !important;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- REFINED LOGIN/SELECTION SCREEN -->
        <div id="loginScreen" class="login-screen" style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: var(--bg-primary); padding: 2rem; position: relative;">
            
            <!-- Main Login Container -->
            <div class="login-container" style="max-width: 500px; width: 100%; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 16px; box-shadow: var(--shadow-lg); padding: 3rem; text-align: center;">
                
                <!-- Brand Hero Area -->
                <div class="brand-hero" style="margin-bottom: 3rem;">
                    <h1 class="brand-name" style="font-size: 3rem; font-weight: 700; color: #00ff88; margin: 0 0 0.5rem 0; letter-spacing: 0.05em;">
                        WAGMI
                </h1>
                    <p class="brand-tagline" style="font-size: 1.1rem; color: var(--text-secondary); margin: 0; font-weight: 400;">
                        We're All Gonna Make It
                    </p>
                    </div>

                <!-- Primary Investor Login Section -->
                <div class="investor-login-main" style="margin-bottom: 2rem;">
                    <h2 style="font-size: 1.5rem; font-weight: 600; color: var(--text-primary); margin: 0 0 1.5rem 0;">
                        Access Your Portfolio
                    </h2>
                    <div class="investor-form" style="margin-bottom: 1.5rem;">
                        <input type="text" id="investorIdInput" placeholder="Enter your Investor ID (e.g., OAG)" style="width: 100%; padding: 1rem 1.25rem; border: 2px solid var(--border-primary); border-radius: 12px; background: var(--bg-primary); color: var(--text-primary); font-size: 1.1rem; margin-bottom: 0.75rem; text-align: center; transition: all 0.3s ease;">
                        <div id="investorError" class="error-message" style="color: var(--accent-orange); font-size: 0.875rem; text-align: center; display: none;">
                            Invalid Investor ID
                        </div>
                    </div>
                    <button class="btn btn-primary investor-btn" id="investorPortalButton" style="width: 100%; padding: 1.25rem 2rem; background: var(--accent-orange); color: var(--bg-primary); border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                        Access My Portfolio
                    </button>
                </div>
                
                <!-- Help Text -->
                <div style="font-size: 0.9rem; color: var(--text-muted); line-height: 1.5;">
                    <p>Don't have your Investor ID? Contact your fund manager for access credentials.</p>
                </div>
            </div>

            <!-- Manager Dashboard Access (Bottom Right) -->
            <div class="manager-access" style="position: absolute; bottom: 2rem; right: 2rem;">
                <button class="btn btn-primary manager-btn" id="managerPortalButton" style="padding: 0.75rem 1.5rem; background: #00ff88; color: #000000; border: none; border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                    Access Manager Dashboard
                </button>
            </div>
        </div>

        <!-- Investor ID Input Modal -->
        <div id="investorLoginModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="app.closeInvestorLogin()">&times;</span>
                <h2>Investor Access</h2>
                <p style="color: #666; margin-bottom: 20px;">Enter your unique Investor ID to access your portfolio</p>
                <div class="investor-id-form">
                    <input type="text" id="investorIdInput" placeholder="e.g., OA6" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 15px; text-transform: uppercase;">
                    <button class="btn btn-primary" onclick="app.loginWithInvestorId()" style="width: 100%;">Access My Portfolio</button>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 14px; color: #666;">
                    <strong>Investor ID Format:</strong> First Name + Last Name Initial + Number<br>
                    <em>Example: Omair Ansari (#6) â†’ OA6</em><br><br>
                    <strong>Don't have your Investor ID?</strong><br>
                    Contact your fund manager to receive your secure access credentials.
                </div>
            </div>
        </div>

        <!-- Manager View -->
        <div id="managerView" class="view-container" style="display: none;">

            <!-- Main Content -->
            <main class="main">
            
            <!-- KPI Ribbon - Top of Every Page -->
            <div class="kpi-ribbon" style="
                background: #121212;
                border: none;
                border-bottom: 1px solid #2d3139;
                border-radius: 0;
                padding: 16px 24px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                position: sticky;
                top: 0;
                z-index: 100;
                box-shadow: none;
            ">
                <!-- Brand Section -->
                <div style="display: flex; align-items: center; gap: 24px;">
                    <div onclick="window.backToLogin()" style="font-size: 24px; font-weight: 700; color: #00ff88; letter-spacing: 0.05em; cursor: pointer; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">WAGMI</div>
                    
                    <!-- Separator -->
                    <div style="width: 1px; height: 24px; background: #3d4148;"></div>

            <!-- Navigation -->
                    <nav style="display: flex; gap: 20px;">
                        <a href="#" onclick="window.switchTab('dashboard')" class="nav-link" data-tab="dashboard" style="color: #e2e8f0; text-decoration: none; font-size: 14px; transition: color 0.2s; cursor: pointer;" onmouseover="if(!this.classList.contains('active')) this.style.color='#00ff88'" onmouseout="if(!this.classList.contains('active')) this.style.color='#e2e8f0'">Dashboard</a>
                        <a href="#" onclick="window.switchTab('investors')" class="nav-link" data-tab="investors" style="color: #e2e8f0; text-decoration: none; font-size: 14px; transition: color 0.2s; cursor: pointer;" onmouseover="if(!this.classList.contains('active')) this.style.color='#00ff88'" onmouseout="if(!this.classList.contains('active')) this.style.color='#e2e8f0'">Investors</a>
                        <a href="#" onclick="window.switchTab('portfolio')" class="nav-link" data-tab="portfolio" style="color: #e2e8f0; text-decoration: none; font-size: 14px; transition: color 0.2s; cursor: pointer;" onmouseover="if(!this.classList.contains('active')) this.style.color='#00ff88'" onmouseout="if(!this.classList.contains('active')) this.style.color='#e2e8f0'">Portfolio</a>
                        <a href="#" onclick="window.switchTab('performance')" class="nav-link" data-tab="performance" style="color: #e2e8f0; text-decoration: none; font-size: 14px; transition: color 0.2s; cursor: pointer;" onmouseover="if(!this.classList.contains('active')) this.style.color='#00ff88'" onmouseout="if(!this.classList.contains('active')) this.style.color='#e2e8f0'">Performance</a>
            </nav>
                </div>
                
                <!-- KPI Metrics -->
                <div style="display: flex; align-items: center; gap: 24px;">
                    <!-- Active Investors -->
                    <div class="kpi-metric" style="text-align: center;">
                        <div style="font-size: 12px; color: #94a3b8; margin-bottom: 2px;">Active investors</div>
                        <div id="kpiActiveInvestors" style="font-size: 16px; font-weight: 600; color: #ffffff;">0</div>
                                </div>
                    
                    <!-- Separator -->
                    <div style="width: 1px; height: 24px; background: #3d4148;"></div>
                    
                    <!-- Total AUM -->
                    <div class="kpi-metric" style="text-align: center;">
                        <div style="font-size: 12px; color: #94a3b8; margin-bottom: 2px;">Total AUM</div>
                        <div id="kpiTotalAUM" style="font-size: 16px; font-weight: 600; color: #ffffff;">$0.00</div>
                            </div>
                    
                    <!-- Separator -->
                    <div style="width: 1px; height: 24px; background: #3d4148;"></div>
                    
                    <!-- Cumulative Return -->
                    <div class="kpi-metric" style="text-align: center;">
                        <div style="font-size: 12px; color: #94a3b8; margin-bottom: 2px;">Cumulative Return</div>
                        <div id="kpiCumulativeReturn" style="font-size: 16px; font-weight: 600; color: #00ff88;">+0.0%</div>
                            </div>
                    
                    <!-- Separator -->
                    <div style="width: 1px; height: 24px; background: #3d4148;"></div>
                    
                    <!-- Month-on-Month -->
                    <div class="kpi-metric" style="text-align: center;">
                        <div style="font-size: 12px; color: #94a3b8; margin-bottom: 2px;">Month-on-Month</div>
                        <div id="kpiMonthlyReturn" style="font-size: 16px; font-weight: 600; color: #00ff88;">+0.0%</div>
                            </div>
                            </div>
                
                <!-- Last Updated Section -->
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i data-lucide="clock" style="width: 16px; height: 16px; color: #94a3b8;"></i>
                    <span id="kpiLastUpdated" style="font-size: 12px; color: #94a3b8;">Last updated: Loading...</span>
                    <button onclick="window.refreshPortfolioData()" style="background: none; border: none; cursor: pointer; padding: 4px; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#3d4148'; this.querySelector('svg').style.color='#00ff88'; this.querySelector('svg').style.transform='rotate(180deg)'" onmouseout="this.style.background='none'; this.querySelector('svg').style.color='#94a3b8'; this.querySelector('svg').style.transform='rotate(0deg)'">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: #94a3b8; transition: all 0.3s ease;">
                            <path d="M4 12a8 8 0 0 1 8-8V2l4 4-4 4V8a6 6 0 1 0 6 6h2a8 8 0 0 1-16 0z" fill="currentColor"/>
                            <path d="M20 12a8 8 0 0 1-8 8v2l-4-4 4-4v4a6 6 0 1 0-6-6H2a8 8 0 0 1 16 0z" fill="currentColor"/>
                        </svg>
                    </button>
                            </div>
                            </div>
            
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">

                <div class="dashboard-grid">
                    <!-- Investment Summaries -->
                    <section class="card">
                        <h2>Investment Summaries</h2>
                        <div id="investmentSummaries" class="summaries-grid">
                            <!-- Investment summary cards will be generated here -->
                        </div>

                    </section>

                    <!-- Portfolio Overview -->
                    <section class="card">
                        <h2>Portfolio Allocation</h2>
                        <div class="chart-container">
                            <canvas id="allocationChart"></canvas>
                        </div>
                    </section>

                    <!-- Recent Transactions -->
                    <section class="card">
                        <h2>Recent Transactions</h2>
                        <div id="recentTransactions" class="transactions-list">
                            <!-- Recent transactions will be shown here -->
                        </div>
                    </section>

                    <!-- Performance Chart -->
                    <section class="card">
                        <h2>Portfolio Performance</h2>
                        <div class="chart-container">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </section>
                </div>
            </div>

            <!-- Investors Tab -->
            <div id="investors" class="tab-content">

                <div class="investors-header">
                    <!-- Unified Search and Filter Controls -->
                    <div class="investor-controls" style="margin-bottom: 24px;">
                        <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap; justify-content: space-between;">
                            <!-- Search Bar -->
                            <input type="text" id="investorSearch" placeholder="Search by ID or Name..." 
                                   style="flex: 1; min-width: 300px; max-width: 400px; padding: 12px 16px; border: 1px solid #3d4148; border-radius: 12px; background: #1a1d23; color: #e2e8f0; font-size: 14px; transition: border-color 0.2s;"
                                   oninput="window.filterInvestors(); window.updateClearAllButton();"
                                   onfocus="this.style.borderColor='#00ff88'"
                                   onblur="this.style.borderColor='#3d4148'">
                            
                            <!-- Filter Tags Container -->
                            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                <!-- Return Filters -->
                                <div style="display: flex; gap: 6px; align-items: center;">
                                    <span style="color: #7f8c8d; font-size: 12px; font-weight: 500; margin-right: 4px;">RETURNS:</span>
                                    <button class="filter-chip" data-filter="positive" onclick="window.toggleFilter('positive')" 
                                            style="padding: 6px 12px; border: 1px solid #3d4148; border-radius: 16px; background: transparent; color: #7f8c8d; font-size: 12px; cursor: pointer; transition: all 0.2s; font-weight: 500;">
                                        Positive
                                    </button>
                                    <button class="filter-chip" data-filter="negative" onclick="window.toggleFilter('negative')" 
                                            style="padding: 6px 12px; border: 1px solid #3d4148; border-radius: 16px; background: transparent; color: #7f8c8d; font-size: 12px; cursor: pointer; transition: all 0.2s; font-weight: 500;">
                                        Negative
                                    </button>
                                    <button class="filter-chip" data-filter="high" onclick="window.toggleFilter('high')" 
                                            style="padding: 6px 12px; border: 1px solid #3d4148; border-radius: 16px; background: transparent; color: #7f8c8d; font-size: 12px; cursor: pointer; transition: all 0.2s; font-weight: 500;">
                                        High (50%+)
                                    </button>
                            </div>
                                
                                <!-- Investment Size Filters -->
                                <div style="display: flex; gap: 6px; align-items: center;">
                                    <span style="color: #7f8c8d; font-size: 12px; font-weight: 500; margin-right: 4px;">SIZE:</span>
                                    <button class="filter-chip" data-filter="small" onclick="window.toggleFilter('small')" 
                                            style="padding: 6px 12px; border: 1px solid #3d4148; border-radius: 16px; background: transparent; color: #7f8c8d; font-size: 12px; cursor: pointer; transition: all 0.2s; font-weight: 500;">
                                        Small (&lt;$1K)
                                    </button>
                                    <button class="filter-chip" data-filter="medium" onclick="window.toggleFilter('medium')" 
                                            style="padding: 6px 12px; border: 1px solid #3d4148; border-radius: 16px; background: transparent; color: #7f8c8d; font-size: 12px; cursor: pointer; transition: all 0.2s; font-weight: 500;">
                                        Medium ($1K-$5K)
                                    </button>
                                    <button class="filter-chip" data-filter="large" onclick="window.toggleFilter('large')" 
                                            style="padding: 6px 12px; border: 1px solid #3d4148; border-radius: 16px; background: transparent; color: #7f8c8d; font-size: 12px; cursor: pointer; transition: all 0.2s; font-weight: 500;">
                                        Large (&gt;$5K)
                                    </button>
                        </div>
                                
                                <!-- AUM Filters -->
                                <div style="display: flex; gap: 6px; align-items: center;">
                                    <span style="color: #7f8c8d; font-size: 12px; font-weight: 500; margin-right: 4px;">AUM %:</span>
                                    <button class="filter-chip" data-filter="major" onclick="window.toggleFilter('major')" 
                                            style="padding: 6px 12px; border: 1px solid #3d4148; border-radius: 16px; background: transparent; color: #7f8c8d; font-size: 12px; cursor: pointer; transition: all 0.2s; font-weight: 500;">
                                        Major (&gt;20%)
                                    </button>
                            </div>
                                
                                <!-- Clear All Button -->
                                <button id="clearAllButton" onclick="window.clearAllFilters()" 
                                        style="padding: 6px 12px; border: 1px solid #3d4148; border-radius: 16px; background: transparent; color: #7f8c8d; font-size: 12px; cursor: default; transition: all 0.2s; font-weight: 500; margin-left: 8px;">
                                    Clear All
                                </button>
                            </div>
                            </div>
                            </div>
                </div>
                <div class="table-container">
                    <table id="investorsTable" class="data-table">
                        <thead>
                            <tr>
                                <th onclick="window.sortInvestors('id')" class="sortable-header sticky-column" style="cursor: pointer; user-select: none; position: relative; padding: 12px 16px; position: sticky; left: 0; background: #1a1d23; z-index: 10; border-right: 1px solid #2d3139;" onmouseover="this.style.background='#2d3139'; this.querySelector('.sort-indicator').style.color='#00ff88'" onmouseout="this.style.background='#1a1d23'; this.querySelector('.sort-indicator').style.color='#7f8c8d'">
                                    <span class="sort-indicator" style="position: absolute; left: 0.75px; top: 50%; transform: translateY(-50%); color: #7f8c8d; transition: color 0.2s ease;">â†•</span> ID
                                </th>
                                <th onclick="window.sortInvestors('name')" class="sortable-header" style="cursor: pointer; user-select: none; position: relative; padding: 12px 16px;" onmouseover="this.style.background='#2d3139'; this.querySelector('.sort-indicator').style.color='#00ff88'" onmouseout="this.style.background=''; this.querySelector('.sort-indicator').style.color='#7f8c8d'">
                                    <span class="sort-indicator" style="position: absolute; left: 0.75px; top: 50%; transform: translateY(-50%); color: #7f8c8d; transition: color 0.2s ease;">â†•</span> Name
                                </th>
                                <th onclick="window.sortInvestors('date')" class="sortable-header" style="cursor: pointer; user-select: none; position: relative; padding: 12px 16px; text-align: center !important;" onmouseover="this.style.background='#2d3139'; this.querySelector('.sort-indicator').style.color='#00ff88'" onmouseout="this.style.background=''; this.querySelector('.sort-indicator').style.color='#7f8c8d'">
                                    <span class="sort-indicator" style="position: absolute; left: 0.75px; top: 50%; transform: translateY(-50%); color: #7f8c8d; transition: color 0.2s ease;">â†•</span> Initial Investment Date
                                </th>
                                <th onclick="window.sortInvestors('investment')" class="sortable-header" style="cursor: pointer; user-select: none; position: relative; padding: 12px 16px; text-align: center !important;" onmouseover="this.style.background='#2d3139'; this.querySelector('.sort-indicator').style.color='#00ff88'" onmouseout="this.style.background=''; this.querySelector('.sort-indicator').style.color='#7f8c8d'">
                                    <span class="sort-indicator" style="position: absolute; left: 0.75px; top: 50%; transform: translateY(-50%); color: #7f8c8d; transition: color 0.2s ease;">â†•</span> Total Investment ($)
                                </th>
                                <th onclick="window.sortInvestors('aum')" class="sortable-header" style="cursor: pointer; user-select: none; position: relative; padding: 12px 16px; text-align: center !important;" onmouseover="this.style.background='#2d3139'; this.querySelector('.sort-indicator').style.color='#00ff88'" onmouseout="this.style.background=''; this.querySelector('.sort-indicator').style.color='#7f8c8d'">
                                    <span class="sort-indicator" style="position: absolute; left: 0.75px; top: 50%; transform: translateY(-50%); color: #7f8c8d; transition: color 0.2s ease;">â†•</span> Share of AUM ($)
                                </th>
                                <th onclick="window.sortInvestors('share')" class="sortable-header" style="cursor: pointer; user-select: none; position: relative; padding: 12px 16px; text-align: center !important;" onmouseover="this.style.background='#2d3139'; this.querySelector('.sort-indicator').style.color='#00ff88'" onmouseout="this.style.background=''; this.querySelector('.sort-indicator').style.color='#7f8c8d'">
                                    <span class="sort-indicator" style="position: absolute; left: 0.75px; top: 50%; transform: translateY(-50%); color: #7f8c8d; transition: color 0.2s ease;">â†•</span> Share of AUM (%)
                                </th>
                                <th onclick="window.sortInvestors('return')" class="sortable-header" style="cursor: pointer; user-select: none; position: relative; padding: 12px 16px; text-align: center !important;" onmouseover="this.style.background='#2d3139'; this.querySelector('.sort-indicator').style.color='#00ff88'" onmouseout="this.style.background=''; this.querySelector('.sort-indicator').style.color='#7f8c8d'">
                                    <span class="sort-indicator" style="position: absolute; left: 0.75px; top: 50%; transform: translateY(-50%); color: #7f8c8d; transition: color 0.2s ease;">â†•</span> Return (%)
                                </th>
                                <th style="cursor: default; text-align: center; width: 80px;"></th>
                            </tr>
                        </thead>
                        <tbody id="investorsTableBody">
                            <!-- Investor rows will be generated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Portfolio Tab -->
            <div id="portfolio" class="tab-content">
                    <!-- Portfolio Header -->
                <div class="portfolio-header">
                        <div class="portfolio-brand">
                            <div class="brand-circle">WAGMI</div>
                            <h1 class="portfolio-title">Portfolio</h1>
                    </div>
                </div>
                
                    <!-- Portfolio Analysis Charts -->
                    <div class="portfolio-charts-section" style="margin: 30px 0;">
                        <div class="charts-header" style="text-align: center; margin-bottom: 30px;">
                            <h2 style="color: var(--text-primary); font-size: 1.8rem; margin-bottom: 10px;">ðŸ“Š Portfolio Analysis</h2>
                            <p style="color: var(--text-secondary); font-size: 1rem;">Portfolio allocation breakdown by category</p>
                        </div>
                        <div class="stacked-chart-container" style="background: var(--bg-elevated); border-radius: 12px; padding: 30px; border: 1px solid var(--border-primary);">
                            <div class="chart-container" style="position: relative; height: 400px;">
                                <canvas id="portfolioStackedChart"></canvas>
                            </div>
                    </div>
                </div>

                    <!-- Target vs Current Allocation Analysis -->
                    <div class="target-allocation-section" style="margin-bottom: 40px;">
                        <div class="section-header" style="margin-bottom: 25px;">
                            <h3 style="color: var(--text-primary); margin-bottom: 8px; font-size: 1.5rem;">ðŸŽ¯ Target vs Current Allocation</h3>
                            <p style="color: var(--text-secondary); font-size: 1rem;">Compare portfolio allocation against target risk distribution</p>
                        </div>
                        
                        <!-- Target vs Current Stacked Bar Charts -->
                        <div class="allocation-charts-container" style="background: var(--bg-elevated); border-radius: 12px; padding: 30px; border: 1px solid var(--border-primary);">
                            <div class="chart-container" style="position: relative; height: 400px;">
                                <canvas id="targetVsCurrentChart"></canvas>
                    </div>
                        </div>
                    </div>

                    <!-- Asset Holdings -->
                    <div class="assets-section">
                        <div class="assets-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div class="assets-header-left" style="display: flex; align-items: center; gap: 15px;">
                                <div class="assets-title">Assets</div>
                                <div class="assets-count" id="assetsCount">0 assets</div>
                        </div>
                            <div class="assets-header-right">
                                <button class="btn btn-primary" onclick="window.openAddAssetModal()" style="padding: 10px 20px; font-size: 0.9rem;">
                                    <span style="margin-right: 8px;">+</span>Add Asset
                                </button>
                    </div>
                        </div>
                        
                        <div class="assets-table-container">
                            <div class="assets-table-header">
                                <div class="asset-col-asset">Asset</div>
                                <div class="asset-col-chain">Chain</div>
                                <div class="asset-col-quantity">Quantity</div>
                                <div class="asset-col-risk">Risk</div>
                                <div class="asset-col-location">Location</div>
                                <div class="asset-col-cointype">Type</div>
                                <div class="asset-col-price">Price</div>
                                <div class="asset-col-value">Value</div>
                                <div class="asset-col-actions">Actions</div>
                </div>

                            <div class="assets-table-body" id="portfolioTableBody">
                                <!-- Portfolio data will be loaded here dynamically -->
                                <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                    <div style="font-size: 2rem; margin-bottom: 16px;">ðŸ“Š</div>
                                    <div style="font-size: 1.1rem; margin-bottom: 8px;">Loading portfolio...</div>
                                    <div style="font-size: 0.9rem;">Fetching data from Google Sheets</div>
                        </div>
                    </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Tab -->
            <div id="performance" class="tab-content">
                <div class="performance-header">
                    <h2>Performance Analytics</h2>
                    <div class="date-filters">
                        <select id="periodFilter">
                            <option value="1M">1 Month</option>
                            <option value="3M">3 Months</option>
                            <option value="6M">6 Months</option>
                            <option value="1Y" selected>1 Year</option>
                            <option value="ALL">All Time</option>
                        </select>
                    </div>
                </div>
                <div class="performance-grid">
                    <div class="card">
                        <h3>Fund Performance</h3>
                        <div class="performance-metrics">
                            <div class="metric">
                                <span class="metric-label">Net Inflows</span>
                                <span class="metric-value" id="netInflows">$0.00</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Capital Appreciation</span>
                                <span class="metric-value" id="capitalAppreciation">$0.00</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Cumulative Return</span>
                                <span class="metric-value" id="cumulativeReturn">0.00%</span>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Monthly Performance</h3>
                        <div class="chart-container">
                            <canvas id="monthlyPerformanceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            </main>
        </div>

        <!-- Investor View -->
        <div id="investorView" class="view-container" style="display: none;">
            <!-- Header -->
            <header class="header">
                <div class="header-content">
                    <div class="header-left">
                        <h1>ðŸ“Š Investment Portal</h1>
                        <span class="view-badge investor">Investor View</span>
                        <span id="investorNameDisplay" class="investor-name"></span>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="window.backToLogin()">Switch Account</button>
                    </div>
                    <div class="header-stats">
                        <div class="stat-card">
                            <span class="stat-label">My Investment</span>
                            <span class="stat-value" id="myInvestmentValue">$0.00</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-label">Total Return</span>
                            <span class="stat-value" id="myTotalReturn">0.00%</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-label">Share Holdings</span>
                            <span class="stat-value" id="myShareHoldings">0.00%</span>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Investor Navigation -->
            <nav class="nav">
                <button class="nav-btn active" data-tab="investor-summary">Summary</button>
                <button class="nav-btn" data-tab="investor-performance">Performance</button>
                <button class="nav-btn" data-tab="investor-statements">Statements</button>
            </nav>

            <!-- Investor Main Content -->
            <main class="main">
                <!-- Investor Summary Tab -->
                <div id="investor-summary" class="tab-content active">
                    <div class="investor-dashboard-grid">
                        <!-- Personal Investment Summary -->
                        <section class="card investor-summary-card">
                            <h2>My Investment Summary</h2>
                            <div id="personalSummary" class="personal-summary">
                                <!-- Personal summary will be generated here -->
                            </div>
                        </section>

                        <!-- Portfolio Allocation (My Share) -->
                        <section class="card">
                            <h2>My Portfolio Allocation</h2>
                            <div class="chart-container">
                                <canvas id="myAllocationChart"></canvas>
                            </div>
                        </section>

                        <!-- Investment History -->
                        <section class="card">
                            <h2>My Investment History</h2>
                            <div id="myTransactionHistory" class="transaction-history">
                                <!-- Personal transaction history will be shown here -->
                            </div>
                        </section>

                        <!-- Performance Overview -->
                        <section class="card">
                            <h2>Performance Overview</h2>
                            <div class="chart-container">
                                <canvas id="myPerformanceChart"></canvas>
                            </div>
                        </section>
                    </div>
                </div>

                <!-- Investor Performance Tab -->
                <div id="investor-performance" class="tab-content">
                    <div class="performance-grid">
                        <div class="card">
                            <h2>Detailed Performance Metrics</h2>
                            <div class="investor-metrics">
                                <div class="metric-row">
                                    <span class="metric-label">Initial Investment Date</span>
                                    <span class="metric-value" id="myInvestmentDate">-</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Days Invested</span>
                                    <span class="metric-value" id="myDaysInvested">-</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Capital Appreciation</span>
                                    <span class="metric-value" id="myCapitalAppreciation">$0.00</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Annualized Return</span>
                                    <span class="metric-value" id="myAnnualizedReturn">0.00%</span>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <h2>Performance vs Fund</h2>
                            <div class="chart-container">
                                <canvas id="myVsFundChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Investor Statements Tab -->
                <div id="investor-statements" class="tab-content">
                    <div class="statements-grid">
                        <div class="card">
                            <h2>Investment Statement</h2>
                            <div class="statement-actions">
                                <button class="btn btn-primary" onclick="app.generateStatement()">Generate PDF Statement</button>
                                <button class="btn btn-secondary" onclick="app.exportData()">Export Data</button>
                            </div>
                            <div id="investmentStatement" class="statement-content">
                                <!-- Statement content will be generated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Modals -->
        
        <!-- Investor Details Modal -->
        <div id="investorDetailsModal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <span class="close">&times;</span>
                <h2 id="investorDetailsTitle">Investor Details</h2>
                
                <!-- Investor Summary -->
                <div class="investor-summary" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <strong>Investor ID:</strong>
                            <div id="detailInvestorId">-</div>
                    </div>
                        <div>
                            <strong>Name:</strong>
                            <div id="detailInvestorName">-</div>
                    </div>
                        <div>
                            <strong>Join Date:</strong>
                            <div id="detailJoinDate">-</div>
                    </div>
                        <div>
                            <strong>Total Investment:</strong>
                            <div id="detailTotalInvestment">-</div>
                    </div>
                        <div>
                            <strong>Current Value:</strong>
                            <div id="detailCurrentValue">-</div>
                        </div>
                        <div>
                            <strong>Total Return:</strong>
                            <div id="detailTotalReturn">-</div>
                </div>
            </div>
        </div>

                <!-- Transaction History -->
                <h3>Transaction History</h3>
                <div class="table-container">
                    <table id="investorTransactionsTable" class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="investorTransactionsBody">
                            <!-- Transactions will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="form-actions" style="margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="window.closeInvestorModal()">Close</button>
                </div>
            </div>
        </div>

        <!-- Add Asset Modal -->
        <div id="addAssetModal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <span class="close">&times;</span>
                <h2>Add New Asset</h2>
                <form id="addAssetForm">
                    <!-- Asset Search -->
                    <div class="form-group">
                        <label for="assetSearch">Search Asset</label>
                        <div class="search-container" style="position: relative;">
                            <input type="text" id="assetSearch" placeholder="Type to search (e.g., Bitcoin, Ethereum, Solana)" autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <div id="assetDropdown" class="asset-dropdown" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;">
                                <!-- Search results will appear here -->
                    </div>
                    </div>
                        <input type="hidden" id="selectedAsset" name="asset" required>
                        <input type="hidden" id="selectedAssetId" name="assetId" required>
                        <input type="hidden" id="selectedAssetSymbol" name="assetSymbol" required>
                        <input type="hidden" id="selectedAssetImage" name="assetImage" required>
                        <div id="selectedAssetInfo" style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; display: none;">
                            <!-- Selected asset info will appear here -->
                    </div>
                    </div>

                    <!-- Quantity Input -->
                    <div class="form-group">
                        <label for="assetQuantity">Quantity Owned</label>
                        <input type="number" id="assetQuantity" name="quantity" step="0.000001" min="0" placeholder="0.00" required>
                    </div>

                    <!-- Blockchain Text Field -->
                    <div class="form-group">
                        <label for="assetChain">Blockchain</label>
                        <div class="autocomplete-container">
                            <input type="text" id="assetChain" name="chain" placeholder="Enter blockchain (e.g., Ethereum, Solana, Hyperliquid)" autocomplete="off" style="width: 100%; padding: 12px; border: 2px solid var(--border-primary); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem;">
                            <div id="chainSuggestions" class="autocomplete-suggestions"></div>
                    </div>
                    </div>

                    <!-- Risk Level -->
                    <div class="form-group">
                        <label for="assetRisk">Risk Level</label>
                        <div class="autocomplete-container">
                            <input type="text" id="assetRisk" name="riskLevel" placeholder="Enter risk level (e.g., Low, Medium, High)" required autocomplete="off">
                            <div id="riskSuggestions" class="autocomplete-suggestions"></div>
            </div>
        </div>

                    <!-- Location -->
                    <div class="form-group">
                        <label for="assetLocation">Location</label>
                        <div class="autocomplete-container">
                            <input type="text" id="assetLocation" name="location" placeholder="Enter location (e.g., Phantom, Exchange, Cold Wallet)" required autocomplete="off">
                            <div id="locationSuggestions" class="autocomplete-suggestions"></div>
                    </div>
                    </div>

                    <!-- Coin Type -->
                    <div class="form-group">
                        <label for="assetCoinType">Coin Type</label>
                        <div class="autocomplete-container">
                            <input type="text" id="assetCoinType" name="coinType" placeholder="Enter coin type (e.g., Memecoin, Major, Altcoin)" required autocomplete="off">
                            <div id="coinTypeSuggestions" class="autocomplete-suggestions"></div>
                    </div>
                    </div>



                    <!-- Value Preview -->
                    <div class="form-group">
                        <label>Estimated Value</label>
                        <div id="valuePreview" style="padding: 15px; background: #e3f2fd; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #1976d2;">$0.00</div>
                            <div style="font-size: 0.9rem; color: #7f8c8d;">Live price will be fetched automatically</div>
                    </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="window.closeAddAssetModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Asset</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ===================================================================
        // WAGMI INVESTMENT MANAGER - MAIN APPLICATION SCRIPT
        // ===================================================================
        // This script contains all the JavaScript functionality for the
        // crypto investment management application including:
        // - Tab navigation and UI management
        // - Google Sheets API integration  
        // - Portfolio data processing and display
        // - Asset management (add/edit/delete)
        // - Chart generation and visualization
        // - Autocomplete and form handling
        // ===================================================================
        
        console.log('ðŸš€ WAGMI Investment Manager - Initializing...');
        
        // ========================================
        // CONFIGURATION CONSTANTS
        // ========================================
        
        /**
         * Application Configuration
         * Centralized configuration for URLs, endpoints, and settings
         */
        const CONFIG = {
            // Google Apps Script URLs
            GOOGLE_APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbyR5aSLuZhoFL0X-igNyVdifZDzbdi29EhGzcpFRLBaZe3bDgK1QVOiWCZO3hfRSFla/exec',
            
            // API Endpoints
            API_ENDPOINTS: {
                ADD_ASSET: 'add',
                UPDATE_ASSET: 'update',
                DELETE_ASSET: 'delete',
                GET_LAST_UPDATE: 'getLastPriceUpdate',
                REFRESH_PRICES: 'testPriceRefresh',
                SETUP_AUTOMATION: 'setupAutomation',
                CHECK_TRIGGERS: 'checkTriggers'
            },
            
            // Update Intervals (in milliseconds)
            TIMESTAMP_UPDATE_INTERVAL: 60 * 1000, // 1 minute
            PRICE_REFRESH_INTERVAL: 30 * 60 * 1000, // 30 minutes
            
            // UI Settings
            REFRESH_BUTTON_DELAY: 2000, // 2 seconds
            SUCCESS_MESSAGE_DURATION: 3000 // 3 seconds
        };
        
        // Simple navigation function
        window.enterManagerView = function() {
            console.log('ðŸ”§ Entering Manager View (inline)...');
            
            const loginScreen = document.getElementById('loginScreen');
            const managerView = document.getElementById('managerView');
            
            if (loginScreen && managerView) {
                loginScreen.style.display = 'none';
                managerView.style.display = 'block';
                
                // Initialize dashboard tab and load data
                setTimeout(() => {
                    window.switchTab('dashboard');
                    console.log('âœ… Manager view loaded with dashboard data');
                }, 100);
                
                console.log('âœ… Successfully switched to manager view');
            } else {
                console.error('âŒ Could not find required elements');
                alert('Error: Could not find required elements');
            }
        };
        
        // Make it available globally for button clicks
        window.app = {
            enterManagerView: window.enterManagerView
        };
        
        // ===================================================================
        // TAB NAVIGATION & UI MANAGEMENT
        // ===================================================================
        
        // Tab navigation function
        window.switchTab = function(tabName) {
            console.log('ðŸ”„ Switching to tab:', tabName);
            
            // Save current tab state to localStorage
            localStorage.setItem('wagmi_current_tab', tabName);
            localStorage.setItem('wagmi_manager_view_active', 'true');
            
            // Update tab content
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            const targetTab = document.getElementById(tabName);
            if (targetTab) targetTab.classList.add('active');
            
            // Update KPI ribbon navigation active state
            const navLinks = document.querySelectorAll('.kpi-ribbon .nav-link');
            navLinks.forEach(link => {
                const linkTab = link.getAttribute('data-tab');
                if (linkTab === tabName) {
                    // Set active state - vibrant green color
                    link.style.color = '#00ff88';
                    link.style.fontWeight = '600';
                    link.classList.add('active');
                } else {
                    // Set inactive state - white color
                    link.style.color = '#e2e8f0';
                    link.style.fontWeight = '400';
                    link.classList.remove('active');
                }
            });
            
            // Load basic data for the tab
            if (tabName === 'dashboard') {
                window.loadDashboardData();
            } else if (tabName === 'investors') {
                window.loadInvestorsData();
            } else if (tabName === 'portfolio') {
                window.loadPortfolioData();
            } else if (tabName === 'performance') {
                window.loadPerformanceData();
            }
        };
        
        // Function to restore app state on page refresh
        window.restoreAppState = function() {
            console.log('ðŸ”„ Restoring app state...');
            
            // Check if manager view was active
            const managerViewActive = localStorage.getItem('wagmi_manager_view_active');
            const currentTab = localStorage.getItem('wagmi_current_tab');
            
            if (managerViewActive === 'true') {
                console.log('ðŸ“± Restoring manager view...');
                
                // Hide login screen and show manager view
                const loginScreen = document.getElementById('loginScreen');
                const managerView = document.getElementById('managerView');
                
                if (loginScreen && managerView) {
                    loginScreen.style.display = 'none';
                    managerView.style.display = 'block';
                    console.log('âœ… Manager view restored');
                    
                    // Restore the specific tab if one was saved
                    if (currentTab && ['dashboard', 'investors', 'portfolio', 'performance'].includes(currentTab)) {
                        console.log(`ðŸ“Š Restoring tab: ${currentTab}`);
                        setTimeout(() => {
                            window.switchTab(currentTab);
                        }, 100); // Small delay to ensure DOM is ready
                    } else {
                        // Default to dashboard if no valid tab saved
                        console.log('ðŸ“Š No valid tab saved, defaulting to dashboard');
                        setTimeout(() => {
                            window.switchTab('dashboard');
                        }, 100);
                    }
                }
            } else {
                console.log('ðŸ  No manager view state to restore, staying on login screen');
            }
        };
        
        // ===================================================================
        // GOOGLE SHEETS API INTEGRATION
        // ===================================================================
        
        // Google Sheets configuration
        const SPREADSHEET_ID = '1h04nkcnQmxaFml8RubIGmPgffMiyoEIg350ryjXK0tM';
        const API_KEY = 'AIzaSyAWXECv5w1HjPmWcTnEqifMifJk-kKeEDA';
        
        // Function to fetch live data from Google Sheets
        window.fetchLiveInvestorData = async function() {
            try {
                console.log('ðŸ“Š Fetching live investor data from Google Sheets...');
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Investors!A:H?key=${API_KEY}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.values && data.values.length > 1) {
                    console.log('âœ… Successfully fetched live investor data');
                    console.log('ðŸ“Š Raw data from Google Sheets:', data.values);
                    return data.values.slice(1); // Skip header row
                } else {
                    console.error('âŒ No investor data found');
                    return null;
                }
            } catch (error) {
                console.error('âŒ Error fetching investor data:', error);
                return null;
            }
        };
        
        // Function to fetch live transactions data
        window.fetchLiveTransactionData = async function() {
            try {
                console.log('ðŸ’° Fetching live transaction data from Google Sheets...');
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Transactions!A:F?key=${API_KEY}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.values && data.values.length > 1) {
                    console.log('âœ… Successfully fetched live transaction data');
                    return data.values.slice(1); // Skip header row
                } else {
                    console.error('âŒ No transaction data found');
                    return null;
                }
            } catch (error) {
                console.error('âŒ Error fetching transaction data:', error);
                return null;
            }
        };
        
        // Function to fetch KPI data from Google Sheets
        window.fetchKPIData = async function() {
            try {
                console.log('ðŸ“Š Fetching KPI data from Google Sheets...');
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/KPIs!A:B?key=${API_KEY}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.values && data.values.length > 1) {
                    console.log('âœ… Successfully fetched KPI data');
                    return data.values.slice(1); // Skip header row
                } else {
                    console.error('âŒ No KPI data found');
                    return null;
                }
            } catch (error) {
                console.error('âŒ Error fetching KPI data:', error);
                return null;
            }
        };

        // Function to fetch last update timestamp from Google Sheets
        window.fetchLastUpdateTimestamp = async function() {
            try {
                console.log('ðŸ•’ Fetching last update timestamp from Google Sheets...');
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Last Update!A2?key=${API_KEY}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.values && data.values.length > 0 && data.values[0].length > 0) {
                    const timestamp = data.values[0][0];
                    console.log('âœ… Successfully fetched last update timestamp:', timestamp);
                    return timestamp;
                } else {
                    console.error('âŒ No last update timestamp found');
                    return null;
                }
            } catch (error) {
                console.error('âŒ Error fetching last update timestamp:', error);
                return null;
            }
        };
        
        // Function to update KPI ribbon with formatted data
        window.updateKPIRibbon = async function(kpiData) {
            if (!kpiData || kpiData.length === 0) {
                console.log('âš ï¸ No KPI data to display');
                return;
            }
            
            console.log('ðŸ“Š Updating KPI ribbon with data:', kpiData);
            
            // Create a map of KPI data for easy lookup
            const kpiMap = {};
            kpiData.forEach(row => {
                if (row[0] && row[1]) {
                    kpiMap[row[0].toLowerCase().trim()] = row[1];
                }
            });
            
            // Update each KPI with proper formatting
            const totalInvestors = parseInt(kpiMap['total investors']) || 0;
            const totalInvested = parseFloat(kpiMap['total invested']) || 0;
            const totalAUM = parseFloat(kpiMap['total aum']) || 0;
            const cumulativeReturn = parseFloat(kpiMap['cumulative retur']) || 0; // Note: typo in sheet
            const monthlyReturn = parseFloat(kpiMap['monthly return']) || 0;
            
            // Format and update Active Investors
            document.getElementById('kpiActiveInvestors').textContent = totalInvestors.toString();
            
            // Format and update Total AUM (using AUM instead of invested for display)
            document.getElementById('kpiTotalAUM').textContent = formatCurrency(totalAUM);
            
            // Format and update Cumulative Return
            const cumulativeElement = document.getElementById('kpiCumulativeReturn');
            cumulativeElement.textContent = formatPercentage(cumulativeReturn);
            cumulativeElement.style.color = cumulativeReturn >= 0 ? '#00ff88' : '#ff4757';
            
            // Format and update Monthly Return
            const monthlyElement = document.getElementById('kpiMonthlyReturn');
            monthlyElement.textContent = formatPercentage(monthlyReturn);
            monthlyElement.style.color = monthlyReturn >= 0 ? '#00ff88' : '#ff4757';
            
            // Fetch and update last updated time from database
            try {
                const dbTimestamp = await window.fetchLastUpdateTimestamp();
                if (dbTimestamp) {
                    // Parse the ISO timestamp and format it for display
                    const dbDate = new Date(dbTimestamp);
                    const timeString = dbDate.toLocaleTimeString('en-US', { 
                        hour: 'numeric', 
                        minute: '2-digit',
                        hour12: true 
                    });
                    document.getElementById('kpiLastUpdated').textContent = `Last updated: ${timeString}`;
                    console.log('âœ… Updated last updated time from database:', timeString);
                } else {
                    // Fallback to browser time if database timestamp is not available
                    const now = new Date();
                    const timeString = now.toLocaleTimeString('en-US', { 
                        hour: 'numeric', 
                        minute: '2-digit',
                        hour12: true 
                    });
                    document.getElementById('kpiLastUpdated').textContent = `Last updated: ${timeString}`;
                    console.log('âš ï¸ Using browser time as fallback:', timeString);
                }
            } catch (error) {
                console.error('âŒ Error fetching database timestamp:', error);
                // Fallback to browser time
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true 
                });
                document.getElementById('kpiLastUpdated').textContent = `Last updated: ${timeString}`;
            }
            
            console.log('âœ… KPI ribbon updated successfully');
        };
        
        // Helper function to format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }
        
        // Helper function to format percentage
        function formatPercentage(value) {
            const sign = value >= 0 ? '+' : '';
            return `${sign}${value.toFixed(1)}%`;
        }
        
        // Function to refresh KPI data
        window.refreshKPIData = async function() {
            console.log('ðŸ”„ Refreshing KPI data...');
            const kpiData = await window.fetchKPIData();
            if (kpiData) {
                window.updateKPIRibbon(kpiData);
            }
        };
        
        // Basic data loading functions
        window.loadDashboardData = async function() {
            console.log('ðŸ“Š Loading dashboard data...');
            
            // Load KPI data first
            const kpiData = await window.fetchKPIData();
            if (kpiData) {
                window.updateKPIRibbon(kpiData);
            }
            
            // Try to load live data first
            const liveInvestorData = await window.fetchLiveInvestorData();
            if (liveInvestorData) {
                window.updateSummaryDashboard(liveInvestorData);
                window.displayLiveInvestorData(liveInvestorData);
                return;
            }
            
            // Show error when no live data is available
            console.error('âŒ No live dashboard data available from database');
            const dashboardContent = document.getElementById('dashboard');
            if (dashboardContent) {
                dashboardContent.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #e2e8f0;">
                        <div style="font-size: 48px; margin-bottom: 20px;">âš ï¸</div>
                        <div style="font-size: 24px; font-weight: 600; margin-bottom: 12px; color: #ef4444;">Database Connection Error</div>
                        <div style="font-size: 16px; color: #94a3b8; margin-bottom: 24px;">Failed to load dashboard data from database</div>
                        <button onclick="window.loadDashboardData()" style="background: #00ff88; color: #000; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">
                            Retry
                        </button>
                    </div>
                `;
            }
        };
        
        // Function to calculate and update summary dashboard
        window.updateSummaryDashboard = function(investorData) {
            console.log('ðŸ“Š Updating summary dashboard...');
            console.log('ðŸ“Š Investor data received:', investorData?.length, 'rows');
            
            // Note: Portfolio Overview widgets have been removed - KPI ribbon now handles all metrics
            // This function is kept for compatibility but no longer updates UI elements
            console.log('ðŸ“Š Summary dashboard update skipped - KPI ribbon handles all metrics now');
            
            if (!investorData || investorData.length <= 1) {
                console.error('âŒ No valid investor data available for summary dashboard');
                return;
            }
            
            // Process data for logging purposes (no UI updates needed)
            let totalInvestors = 0;
            let totalInvested = 0;
            let totalCurrentValue = 0;
            
            for (let i = 0; i < investorData.length; i++) {
                const row = investorData[i];
                if (row && row.length >= 5) {
                    const investmentValue = parseFloat(row[4]?.replace(/[$,]/g, '')) || 0;
                    const currentValue = parseFloat(row[5]?.replace(/[$,]/g, '')) || 0;
                    
                    if (investmentValue > 0) {
                        totalInvestors++;
                        totalInvested += investmentValue;
                        totalCurrentValue += currentValue;
                    }
                }
            }
            
            console.log('ðŸ“Š Processed rows:', investorData.length, 'investors found:', totalInvestors);
        };

        // Function to display live investor data
        window.displayLiveInvestorData = function(investorData) {
            console.log('ðŸ“Š Displaying live investor data:', investorData);
            
            // Calculate totals from live data
            let totalAUM = 0;
            let totalInitial = 0;
            
            // Header stats removed - no longer needed
            
            // Process investor data and build summaries
            const summariesContainer = document.getElementById('investmentSummaries');
            if (summariesContainer) {
                let summariesHTML = '';
                
                investorData.forEach(row => {
                    const investorId = row[0] || '';
                    const name = row[1] || '';
                    const email = row[2] || '';
                    const joinDate = row[3] || '';
                    const investmentValue = parseFloat(row[4]?.replace(/[$,]/g, '')) || 0;
                    const currentValue = parseFloat(row[5]?.replace(/[$,]/g, '')) || 0;
                    const sharePercentage = parseFloat(row[6]?.replace('%', '')) || 0;
                    
                    totalInitial += investmentValue;
                    totalAUM += currentValue;
                    
                    const totalReturn = investmentValue > 0 ? ((currentValue - investmentValue) / investmentValue * 100) : 0;
                    
                    summariesHTML += `
                        <div class="summary-card">
                            <div class="summary-header">${name} (${investorId})</div>
                            <div class="summary-row">
                                <span class="summary-label">Initial Investment</span>
                                <span class="summary-value">$${investmentValue.toLocaleString()}</span>
                    </div>
                            <div class="summary-row">
                                <span class="summary-label">Current Value</span>
                                <span class="summary-value">$${currentValue.toLocaleString()}</span>
                    </div>
                            <div class="summary-row">
                                <span class="summary-label">Total Return</span>
                                <span class="summary-value ${totalReturn >= 0 ? 'positive' : 'negative'}">${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(1)}%</span>
                    </div>
                            <div class="summary-row">
                                <span class="summary-label">Share Holding</span>
                                <span class="summary-value">${sharePercentage.toFixed(1)}%</span>
                    </div>
            </div>
                    `;
                });
                
                summariesContainer.innerHTML = summariesHTML;
            }
            
            // Update header stats with calculated values
            const overallReturn = totalInitial > 0 ? ((totalAUM - totalInitial) / totalInitial * 100) : 0;
            
            // Header stats updates removed - no longer needed
            
            // Also load live transactions
            window.loadLiveTransactions();
        };
        
        // Function to load live transactions
        window.loadLiveTransactions = async function() {
            const transactionData = await window.fetchLiveTransactionData();
            if (transactionData) {
                const transactionsContainer = document.getElementById('recentTransactions');
                if (transactionsContainer) {
                    let transactionsHTML = '';
                    
                    // Show last 5 transactions
                    const recentTransactions = transactionData.slice(-5).reverse();
                    
                    recentTransactions.forEach(row => {
                        const investorId = row[1] || '';
                        const type = row[2] || 'Investment';
                        const amount = parseFloat(row[3]) || 0;
                        const date = row[4] || '';
                        
                        transactionsHTML += `
                            <div class="transaction-item">
                                <div class="transaction-info">
                                    <div class="transaction-type">${type} - ${investorId}</div>
                                    <div class="transaction-date">${date}</div>
        </div>
                                <div class="transaction-amount ${type === 'Investment' ? 'positive' : 'negative'}">$${amount.toLocaleString()}</div>
    </div>
                        `;
                    });
                    
                    transactionsContainer.innerHTML = transactionsHTML;
                }
            }
        };
        
        
        window.loadInvestorsData = async function() {
            console.log('ðŸ‘¥ Loading investors data...');
            
            // Load KPI data first
            const kpiData = await window.fetchKPIData();
            if (kpiData) {
                window.updateKPIRibbon(kpiData);
            }
            
            // Try to load live data first
            console.log('ðŸ” Attempting to fetch live investor data...');
            const liveInvestorData = await window.fetchLiveInvestorData();
            console.log('ðŸ“Š Live investor data result:', liveInvestorData);
            
            if (liveInvestorData && liveInvestorData.length > 0) {
                console.log('âœ… Using live investor data with dynamic date calculation');
                window.updateSummaryDashboard(liveInvestorData); // Update summary widget
                await window.displayLiveInvestorsTable(liveInvestorData);
                return;
            }
            
            // Show error when no live data is available
            console.error('âŒ No live investor data available from database');
            const investorsTableBody = document.getElementById('investorsTableBody');
            if (investorsTableBody) {
                investorsTableBody.innerHTML = `
                    <tr>
                        <td class="sticky-column" style="position: sticky; left: 0; background: #1a1d23; z-index: 10; border-right: 1px solid #2d3139;">#ERROR</td>
                        <td>#ERROR</td>
                        <td style="text-align: center;">#ERROR</td>
                        <td style="text-align: center;">#ERROR</td>
                        <td style="text-align: center;">#ERROR</td>
                        <td style="text-align: center;">#ERROR</td>
                        <td style="text-align: center;">#ERROR</td>
                        <td style="text-align: center;">
                            <button style="background: #111; border-radius: 8px; padding: 6px 12px; border: 1px solid #2d3139; color: #e2e8f0; cursor: not-allowed;" disabled>#ERROR</button>
                        </td>
                    </tr>
                `;
            }
        };
        
        
        // Function to display live investors table
        window.displayLiveInvestorsTable = async function(investorData) {
            console.log('ðŸ‘¥ Displaying live investors table:', investorData);
            console.log('ðŸ“Š Processing investors with dynamic date calculation...');
            
            const investorsTableBody = document.getElementById('investorsTableBody');
            if (investorsTableBody) {
                // Show loading state while processing
                investorsTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px; color: #7f8c8d;">Loading investor data from Google Sheets...</td></tr>';
                
                let tableHTML = '';
                
                                 // Process each investor using Google Sheets data directly
                 for (const row of investorData) {
                     const investorId = row[0] || '';
                     const name = row[1] || '';
                     const email = row[2] || '';
                     const joinDate = row[3] || ''; // Join date from Google Sheets
                     const investmentValue = parseFloat(row[4]?.replace(/[$,]/g, '')) || 0;
                     const currentValue = parseFloat(row[5]?.replace(/[$,]/g, '')) || 0;
                     const sharePercentage = parseFloat(row[6]?.replace('%', '')) || 0;
                     const returnPercentage = parseFloat(row[7]?.replace('%', '')) || 0;
                     
                     console.log(`ðŸ” Processing investor ${investorId} (${name})`);
                     console.log(`ðŸ“… Join date from Google Sheets: ${joinDate}`);
                     
                     // Format the join date from Google Sheets (should be in YYYY-MM-DD format)
                     let formattedDate = 'N/A';
                     if (joinDate) {
                         try {
                             // If it's already in YYYY-MM-DD format, format it nicely
                             if (joinDate.includes('-')) {
                                 const date = new Date(joinDate);
                                 formattedDate = date.toLocaleDateString('en-US', {
                                     month: '2-digit',
                                     day: '2-digit',
                                     year: 'numeric'
                                 });
                             } else {
                                 // If it's in a different format, try to parse it
                                 const date = new Date(joinDate);
                                 if (!isNaN(date.getTime())) {
                                     formattedDate = date.toLocaleDateString('en-US', {
                                         month: '2-digit',
                                         day: '2-digit',
                                         year: 'numeric'
                                     });
                                 }
                             }
                         } catch (error) {
                             console.warn(`âš ï¸ Could not parse date for ${investorId}: ${joinDate}`);
                             formattedDate = joinDate; // Use as-is if parsing fails
                         }
                     }
                     
                     console.log(`ðŸ“… Final formatted date for ${investorId}: ${formattedDate}`);
                    
                    // Use return percentage from Google Sheets if available, otherwise calculate
                    const totalReturn = returnPercentage > 0 ? returnPercentage : (investmentValue > 0 ? ((currentValue - investmentValue) / investmentValue * 100) : 0);
                    
                    // Format values according to specifications - ensure consistency with KPI ribbon
                    const formattedInvestment = formatCurrency(investmentValue);
                    const formattedAUM = formatCurrency(currentValue);
                    const formattedReturn = formatPercentage(totalReturn);
                    const formattedShare = `${sharePercentage.toFixed(1)}%`; // No sign for share percentage
                    
                    // Color for return percentage (green for positive, red for negative, white for zero) - match KPI ribbon colors
                    const returnColor = totalReturn > 0 ? '#00ff88' : totalReturn < 0 ? '#ff4757' : '#e2e8f0';
                    
                    tableHTML += `
                        <tr style="border-bottom: 1px solid #2d3139; transition: background-color 0.2s ease;" onmouseover="this.style.backgroundColor='#1f2329'" onmouseout="this.style.backgroundColor=''">
                            <td class="sticky-column" style="position: sticky; left: 0; background: #1a1d23; z-index: 5; border-right: 1px solid #2d3139; padding: 12px 16px; font-weight: 600; color: #e2e8f0; text-align: left;">${investorId}</td>
                            <td style="padding: 12px 16px; color: #e2e8f0; text-align: left;">${name}</td>
                            <td style="padding: 12px 16px; text-align: center !important; color: #e2e8f0;">${formattedDate}</td>
                            <td style="padding: 12px 16px; text-align: center !important; color: #e2e8f0;">${formattedInvestment}</td>
                            <td style="padding: 12px 16px; text-align: center !important; color: #e2e8f0;">${formattedAUM}</td>
                            <td style="padding: 12px 16px; text-align: center !important; color: #e2e8f0;">${formattedShare}</td>
                            <td style="padding: 12px 16px; text-align: center !important; color: ${returnColor} !important; font-weight: 500;">${formattedReturn}</td>
                            <td style="padding: 12px 16px; text-align: center;">
                                <button onclick="window.showInvestorDetails('${investorId}', '${name}', '${formattedDate}', ${investmentValue}, ${currentValue}, ${totalReturn}); event.stopPropagation();" 
                                        style="background: #111; border: none; border-radius: 8px; padding: 6px 12px; color: #e2e8f0; cursor: pointer; font-size: 12px; transition: background 0.2s;" 
                                        onmouseover="this.style.background='#1a1a1a'" 
                                        onmouseout="this.style.background='#111'">
                                    More
                                </button>
                            </td>
                        </tr>
                    `;
                }
                
                console.log('âœ… Finished processing all investors, updating table');
                investorsTableBody.innerHTML = tableHTML;
            }
        };
        
        window.loadPortfolioData = async function() {
            console.log('ðŸ’¼ Loading portfolio data...');
            
            // Load KPI data first
            const kpiData = await window.fetchKPIData();
            if (kpiData) {
                window.updateKPIRibbon(kpiData);
            }
            
            try {
                // First, load the same summary data that Dashboard and Investor tabs use
                const liveInvestorData = await window.fetchLiveInvestorData();
                if (liveInvestorData) {
                    window.updateSummaryDashboard(liveInvestorData);
                } else {
                    console.error('âŒ No live investor data available for portfolio summary');
                }
                
                // Then fetch and display portfolio-specific data
                const portfolioData = await window.fetchPortfolioData();
                
                if (portfolioData && portfolioData.length > 0) {
                    console.log('âœ… Using live portfolio data from database');
                    await window.displayPortfolioData(portfolioData);
                } else {
                    console.log('âš ï¸ No portfolio data found, showing empty state');
                    window.displayEmptyPortfolio();
                }
            } catch (error) {
                console.error('âŒ Error loading portfolio data:', error);
                window.displayEmptyPortfolio();
                // Portfolio data failed to load - error already logged
            }
        };

        // Function to load performance data
        window.loadPerformanceData = async function() {
            console.log('ðŸ“ˆ Loading performance data...');
            
            // Load KPI data first
            const kpiData = await window.fetchKPIData();
            if (kpiData) {
                window.updateKPIRibbon(kpiData);
            }
            
            // Load performance chart data
            try {
                // For now, we'll use the same data as portfolio for performance charts
                const portfolioData = await window.fetchPortfolioData();
                if (portfolioData && portfolioData.length > 0) {
                    console.log('âœ… Performance data loaded successfully');
                    // Performance charts will be generated when the tab is shown
                } else {
                    console.log('âš ï¸ No performance data available');
                }
            } catch (error) {
                console.error('âŒ Error loading performance data:', error);
            }
        };

        // Function to display portfolio data from database
        window.displayPortfolioData = async function(portfolioData) {
            console.log('ðŸ’¼ Displaying portfolio data:', portfolioData);
            
            const portfolioTableBody = document.getElementById('portfolioTableBody');
            if (!portfolioTableBody) return;
            
            // Update autocomplete data from the portfolio
            window.updateAutocompleteData(portfolioData);
            
            // Sort portfolio data by total value in descending order (highest to lowest)
            const sortedPortfolioData = portfolioData.slice().sort((a, b) => {
                const quantityA = parseFloat(a[3]) || 0;  // Column D: Quantity
                const priceA = parseFloat(a[4]) || 0;     // Column E: Current Price
                const valueA = quantityA * priceA;
                
                const quantityB = parseFloat(b[3]) || 0;  // Column D: Quantity
                const priceB = parseFloat(b[4]) || 0;     // Column E: Current Price
                const valueB = quantityB * priceB;
                
                return valueB - valueA; // Descending order (largest first)
            });
            
            console.log('ðŸ”„ Portfolio sorted by value (highest to lowest)');
            
            let assetsHTML = '';
            let totalPortfolioValue = 0;
            
            console.log('ðŸ’¼ Calculating portfolio values...');
            
            sortedPortfolioData.forEach((row, rowIndex) => {
                const assetName = row[0] || '';        // Column A: Asset Name
                const symbol = row[1] || '';           // Column B: Symbol
                const chain = row[2] || '';            // Column C: Chain
                const quantity = parseFloat(row[3]) || 0;    // Column D: Quantity
                const currentPrice = parseFloat(row[4]) || 0; // Column E: Current Price
                const totalValue = parseFloat(row[5]) || 0;   // Column F: Total Value
                const imageUrl = row[6] || '';         // Column G: Image URL
                const riskLevel = row[7] || '';        // Column H: Risk Level
                const location = row[8] || '';         // Column I: Location
                const coinType = row[9] || '';         // Column J: Coin Type
                
                // Calculate the real-time total value instead of using stored value
                const calculatedValue = quantity * currentPrice;
                
                // Calculate asset value and add to portfolio total
                totalPortfolioValue += calculatedValue;
                
                try {
                    // Use database image URL first, then fallback to hardcoded logos
                    let tokenLogo = imageUrl || '';
                    let fallbackSymbol = symbol.charAt(0).toUpperCase();
                    
                    // If no database image URL, use hardcoded fallbacks
                    if (!tokenLogo) {
                        const symbolLower = symbol.toLowerCase();
                        const nameLower = assetName.toLowerCase();
                        
                        switch(true) {
                            case symbolLower === 'btc' || symbolLower === 'bitcoin' || nameLower.includes('bitcoin'):
                                tokenLogo = 'https://assets.coingecko.com/coins/images/1/large/bitcoin.png';
                                fallbackSymbol = 'â‚¿';
                                break;
                            case symbolLower === 'eth' || symbolLower === 'ethereum' || nameLower.includes('ethereum'):
                                tokenLogo = 'https://assets.coingecko.com/coins/images/279/large/ethereum.png';
                                fallbackSymbol = 'Îž';
                                break;
                            case symbolLower === 'ada' || symbolLower === 'cardano' || nameLower.includes('cardano'):
                                tokenLogo = 'https://assets.coingecko.com/coins/images/975/large/cardano.png';
                                fallbackSymbol = 'â‚³';
                                break;
                            case symbolLower === 'sol' || symbolLower === 'solana' || nameLower.includes('solana'):
                                tokenLogo = 'https://assets.coingecko.com/coins/images/4128/large/solana.png';
                                fallbackSymbol = 'â—Ž';
                                break;
                            case symbolLower === 'aura' || nameLower.includes('aura'):
                                tokenLogo = 'https://assets.coingecko.com/coins/images/25942/thumb/aura-logo-square.png';
                                fallbackSymbol = 'ðŸŒŸ';
                                break;
                            case symbolLower === 'jitosol' || symbolLower === 'jito' || nameLower.includes('jito'):
                                tokenLogo = 'https://assets.coingecko.com/coins/images/32455/small/jito.png';
                                fallbackSymbol = 'J';
                                break;
                            case symbolLower === 'mystery' || nameLower.includes('mystery'):
                                tokenLogo = 'https://assets.coingecko.com/coins/images/31967/small/mystery.png';
                                fallbackSymbol = 'M';
                                break;
                            case symbolLower === 'matic' || nameLower.includes('polygon'):
                                tokenLogo = 'https://assets.coingecko.com/coins/images/4713/large/matic-token-icon.png';
                                fallbackSymbol = 'ðŸ”·';
                                break;
                            case symbolLower === 'avax' || nameLower.includes('avalanche'):
                                tokenLogo = 'https://assets.coingecko.com/coins/images/12559/large/coin-round-red.png';
                                fallbackSymbol = 'ðŸ”º';
                                break;
                            case symbolLower === 'link' || nameLower.includes('chainlink'):
                                tokenLogo = 'https://assets.coingecko.com/coins/images/877/large/chainlink-new-logo.png';
                                fallbackSymbol = 'ðŸ”—';
                                break;
                            case symbolLower === 'dot' || nameLower.includes('polkadot'):
                                tokenLogo = 'https://assets.coingecko.com/coins/images/12171/large/polkadot.png';
                                fallbackSymbol = 'â—';
                                break;
                            default:
                                tokenLogo = '';
                                fallbackSymbol = symbol.charAt(0).toUpperCase();
                                break;
                        }
                    }
                    
                    console.log(`ðŸ–¼ï¸ [DEBUG] Final logo result - URL: "${tokenLogo}", Fallback: "${fallbackSymbol}"`);
                    
                    // Create unique row identifier using symbol + location + index to handle duplicate symbols
                    const uniqueRowId = `${symbol.toLowerCase()}-${location.toLowerCase().replace(/\s+/g, '-')}-${rowIndex}`;
                    
                    assetsHTML += `
                        <div class="asset-row" data-asset-id="${uniqueRowId}" data-symbol="${symbol}" data-location="${location}">
                            <div class="asset-col-asset">
                                <div class="asset-info">
                                    <div class="asset-icon">
                                        ${tokenLogo ? 
                                            `<img src="${tokenLogo}" alt="${symbol}" onerror="this.parentElement.innerHTML='<span class=\\'fallback\\'>${fallbackSymbol}</span>'; this.parentElement.classList.add('fallback');">` : 
                                            `<span class="fallback">${fallbackSymbol}</span>`
                                        }
                                    </div>
                                    <div class="asset-details">
                                        <div class="asset-name">${assetName}</div>
                                        <div class="asset-symbol">${symbol.toUpperCase()}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="asset-col-chain">
                                <span class="chain-badge" data-chain="${chain.toLowerCase()}">${chain.toUpperCase()}</span>
                            </div>
                            <div class="asset-col-quantity">
                                <span class="quantity-display">${quantity.toLocaleString()}</span>
                                <input type="number" class="asset-quantity-input" value="${quantity}" step="0.000001" style="display: none;">
                            </div>
                            <div class="asset-col-risk">
                                <span class="risk-display">${riskLevel}</span>
                                <input type="text" class="asset-risk-input" value="${riskLevel}" style="display: none;" autocomplete="off">
                            </div>
                            <div class="asset-col-location">
                                <span class="location-display">${location}</span>
                                <input type="text" class="asset-location-input" value="${location}" style="display: none;" autocomplete="off">
                            </div>
                            <div class="asset-col-cointype">
                                <span class="cointype-display">${coinType}</span>
                                <input type="text" class="asset-cointype-input" value="${coinType}" style="display: none;" autocomplete="off">
                            </div>

                            <div class="asset-col-price">$${currentPrice.toLocaleString()}</div>
                            <div class="asset-col-value">
                                <span class="value-display">$${calculatedValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                            </div>
                            <div class="asset-col-actions">
                                <button class="asset-edit-btn" onclick="window.editAssetFields('${uniqueRowId}')">Edit</button>
                                <button class="asset-delete-btn" onclick="window.deleteAsset('${uniqueRowId}')">Delete</button>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error(`âŒ Error processing asset ${assetName}:`, error);
                }
            });
            
            portfolioTableBody.innerHTML = assetsHTML;
            
            // Update assets count
            const assetsCount = document.getElementById('assetsCount');
            if (assetsCount) {
                assetsCount.textContent = `${portfolioData.length} assets`;
            }
            
            // Update total portfolio value
            // Update Portfolio tab overview widget
            const portfolioCurrentValueElement = document.getElementById('portfolioSummaryCurrentValue');
            if (portfolioCurrentValueElement) {
                portfolioCurrentValueElement.textContent = `$${totalPortfolioValue.toLocaleString()}`;
            }
            
            // Update legacy totalPortfolioValue element if it exists (for backwards compatibility)
            const totalValueElement = document.getElementById('totalPortfolioValue');
            if (totalValueElement) {
                totalValueElement.textContent = `$${totalPortfolioValue.toLocaleString()}`;
            }
            
            // Update other portfolio overview metrics
            const portfolioTotalInvestorsElement = document.getElementById('portfolioSummaryTotalInvestors');
            const portfolioTotalInvestedElement = document.getElementById('portfolioSummaryTotalInvested');
            const portfolioTotalGainsElement = document.getElementById('portfolioSummaryTotalGains');
            const portfolioMonthlyReturnElement = document.getElementById('portfolioSummaryMonthlyReturn');
            
            // Portfolio overview metrics are now updated by updateSummaryDashboard() with live data
            // No need for hardcoded values here since they get overridden by the live data
            
            console.log('âœ… Portfolio calculation completed');
            
            // Generate portfolio analysis charts with a small delay to ensure DOM is ready
            setTimeout(() => {
                window.generatePortfolioCharts(sortedPortfolioData);
            }, 100);
        };

        // Function to update portfolio summary
        window.updatePortfolioSummary = async function(portfolioData) {
            let totalValue = 0;
            
            for (const row of portfolioData) {
                const quantity = parseFloat(row[3]) || 0;    // Column D: Quantity
                const currentPrice = parseFloat(row[4]) || 0; // Column E: Current Price
                const calculatedValue = quantity * currentPrice;
                totalValue += calculatedValue;
            }
            
            // Update total portfolio value
            const totalValueElement = document.getElementById('totalPortfolioValue');
            if (totalValueElement) {
                totalValueElement.textContent = `$${totalValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }
            
            // Update last updated time
            const lastUpdatedElement = document.getElementById('portfolioLastUpdated');
            if (lastUpdatedElement) {
                lastUpdatedElement.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
            }
        };

        // Function to display empty portfolio state
        window.displayEmptyPortfolio = function() {
            const portfolioTableBody = document.getElementById('portfolioTableBody');
            if (portfolioTableBody) {
                portfolioTableBody.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“ˆ</div>
                        <div style="font-size: 1.2rem; margin-bottom: 0.5rem; color: var(--text-primary);">No assets added yet</div>
                        <div>Click "Add Asset" to start building your portfolio</div>
                    </div>
                `;
            }
            
            // Reset portfolio value
            const totalValueElement = document.getElementById('totalPortfolioValue');
            if (totalValueElement) {
                totalValueElement.textContent = '$0.00';
            }
            
            // Update assets count
            const assetsCount = document.querySelector('.assets-count');
            if (assetsCount) {
                assetsCount.textContent = '0 assets';
            }
        };

        // Function to save portfolio history snapshot
        window.savePortfolioHistory = async function(totalValue, reason = 'Asset Update') {
            try {
                console.log(`ðŸ“ˆ [HISTORY] Saving portfolio snapshot: $${totalValue} (${reason})`);
                
                const historyData = {
                    action: 'history',
                    timestamp: new Date().toISOString(),
                    totalValue: totalValue,
                    reason: reason,
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString()
                };
                
                const webhookUrl = CONFIG.GOOGLE_APPS_SCRIPT_URL;
                
                // Send to Google Apps Script
                const urlWithParams = `${webhookUrl}?action=${encodeURIComponent(historyData.action)}&timestamp=${encodeURIComponent(historyData.timestamp)}&totalValue=${encodeURIComponent(historyData.totalValue)}&reason=${encodeURIComponent(historyData.reason)}&date=${encodeURIComponent(historyData.date)}&time=${encodeURIComponent(historyData.time)}`;
                
                console.log(`ðŸ“ˆ [HISTORY] Sending history data: ${urlWithParams}`);
                
                const response = await fetch(urlWithParams, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        console.log(`âœ… [HISTORY] Portfolio history saved successfully`);
                        return true;
                    } else {
                        console.error(`âŒ [HISTORY] Failed to save history:`, result.error);
                        return false;
                    }
                } else {
                    console.error(`âŒ [HISTORY] HTTP error saving history:`, response.status);
                    return false;
                }
            } catch (error) {
                console.error('âŒ [HISTORY] Error saving portfolio history:', error);
                return false;
            }
        };


        // ===================================================================
        // CHART GENERATION FUNCTIONS
        // ===================================================================
        
        // Target portfolio allocation (loaded from Google Sheets)
        window.targetAllocation = {
            'Low risk': 20,
            'Medium risk': 29, 
            'High risk': 40,
            'Degen': 1,
            'Stablecoin': 10
        };
        
        // Function to fetch target allocation from Google Sheets
        window.fetchTargetAllocation = async function() {
            try {
                console.log('ðŸŽ¯ Fetching target allocation from Google Sheets...');
                
                // Try to fetch from TargetAllocation sheet using Google Sheets API (only columns A & B)
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/TargetAllocation!A:B?key=${API_KEY}`
                );
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.values && data.values.length > 1) {
                        const targetAllocation = {};
                        
                        // Skip header row (index 0)
                        for (let i = 1; i < data.values.length; i++) {
                            const row = data.values[i];
                            const riskCategory = row[0];
                            const percentage = parseFloat(row[1]);
                            
                            if (riskCategory && !isNaN(percentage) && percentage > 0) {
                                targetAllocation[riskCategory] = percentage;
                            }
                        }
                        
                        if (Object.keys(targetAllocation).length > 0) {
                            window.targetAllocation = targetAllocation;
                            console.log('âœ… Target allocation loaded from database:', targetAllocation);
                            return targetAllocation;
                        }
                    }
                }
                
                console.log('âš ï¸ Using default target allocation');
                return window.targetAllocation;
                
            } catch (error) {
                console.error('âŒ Error fetching target allocation:', error);
                console.log('âš ï¸ Using default target allocation');
                return window.targetAllocation;
            }
        };

        window.generatePortfolioCharts = async function(portfolioData) {
            console.log('ðŸ“Š Generating portfolio analysis charts...');
            
            try {
                // Generate main stacked bar chart
                window.generateStackedBarChart(portfolioData);
                
                // Fetch target allocation and generate comparison charts
                await window.fetchTargetAllocation();
                window.generateTargetVsCurrentCharts(portfolioData);
                
                console.log('âœ… Portfolio charts generated successfully');
            } catch (error) {
                console.error('âŒ Error generating portfolio charts:', error);
            }
        };

        // Generate 100% Stacked Bar Chart for all portfolio categories
        window.generateStackedBarChart = function(portfolioData) {
            const ctx = document.getElementById('portfolioStackedChart');
            if (!ctx) return;

            // Aggregate data for all four categories
            const riskData = {};
            const typeData = {};
            const locationData = {};
            const tokenData = {};
            const tokenRiskMapping = {}; // Map tokens to their risk levels
            let totalValue = 0;

            portfolioData.forEach(row => {
                const quantity = parseFloat(row[3]) || 0;
                const price = parseFloat(row[4]) || 0;
                const value = quantity * price;
                const symbol = row[1] || 'Unknown';
                const riskLevel = row[7] || 'Unknown';
                const coinType = row[9] || 'Unknown';
                const location = row[8] || 'Unknown';
                
                totalValue += value;
                riskData[riskLevel] = (riskData[riskLevel] || 0) + value;
                typeData[coinType] = (typeData[coinType] || 0) + value;
                locationData[location] = (locationData[location] || 0) + value;
                tokenData[symbol] = (tokenData[symbol] || 0) + value;
                
                // Map each token to its risk level for color coding
                tokenRiskMapping[symbol] = riskLevel;
            });

            // Sort and limit tokens to top 6 + Others
            const sortedTokens = Object.entries(tokenData)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 6);
            
            const otherTokenValue = Object.entries(tokenData)
                .slice(6)
                .reduce((sum, [,value]) => sum + value, 0);
            
            const finalTokenData = {};
            sortedTokens.forEach(([token, value]) => {
                finalTokenData[token] = value;
            });
            if (otherTokenValue > 0) {
                finalTokenData['Others'] = otherTokenValue;
            }

            // Convert to percentages for each category
            const riskPercentages = Object.entries(riskData).map(([key, value]) => ({
                label: key,
                percentage: ((value / totalValue) * 100).toFixed(1),
                value: value
            }));

            const typePercentages = Object.entries(typeData).map(([key, value]) => ({
                label: key,
                percentage: ((value / totalValue) * 100).toFixed(1),
                value: value
            }));

            const locationPercentages = Object.entries(locationData).map(([key, value]) => ({
                label: key,
                percentage: ((value / totalValue) * 100).toFixed(1),
                value: value
            }));

            const tokenPercentages = Object.entries(finalTokenData).map(([key, value]) => ({
                label: key,
                percentage: ((value / totalValue) * 100).toFixed(1),
                value: value
            }));

            // Define colors for each category (updated to match website theme)
            const riskColors = {
                'Low': '#64748B',      // Slate gray for Low risk
                'Medium': '#F59E0B',   // Amber for Medium risk  
                'High': '#EF4444',     // Red for High risk
                'Degen': '#DC2626',    // Dark red for Degen
                'Unknown': '#9CA3AF'   // Gray for Unknown
            };

            const typeColors = {
                'Major': '#3B82F6',      // Blue for Major
                'Altcoin': '#8B5CF6',    // Purple for Altcoin
                'Meme': '#10B981',       // Emerald for Meme
                'Stablecoin': '#6B7280', // Gray for Stablecoin
                'Unknown': '#9CA3AF'     // Gray for Unknown
            };

            const locationColors = ['#3B82F6', '#10B981', '#F59E0B', '#8B5CF6', '#EF4444', '#06B6D4', '#84CC16', '#F97316', '#64748B'];

            // Prepare datasets for stacked bar chart
            const datasets = [];

            // Risk Level datasets (Bar 1)
            riskPercentages.forEach((item, index) => {
                datasets.push({
                    label: `Risk: ${item.label}`,
                    data: [parseFloat(item.percentage), 0, 0, 0], // Only show in first bar
                    backgroundColor: riskColors[item.label] || '#9CA3AF',
                    stack: 'stack1'
                });
            });

            // Token Allocation datasets (Bar 2) - clustered by risk level, largest at bottom
            const tokensByRisk = {
                'High': [],
                'Degen': [],
                'Medium': [],
                'Low': [],
                'Unknown': []
            };

            // Group tokens by risk level
            tokenPercentages.forEach((item) => {
                const tokenRisk = tokenRiskMapping[item.label] || 'Unknown';
                tokensByRisk[tokenRisk].push(item);
            });

            // Sort each risk group by percentage (largest first) and add to datasets
            ['High', 'Degen', 'Medium', 'Low', 'Unknown'].forEach(riskLevel => {
                tokensByRisk[riskLevel]
                    .sort((a, b) => parseFloat(b.percentage) - parseFloat(a.percentage))
                    .forEach((item) => {
                        const tokenColor = riskColors[riskLevel] || '#9CA3AF';
                        datasets.push({
                            label: `Token: ${item.label}`,
                            data: [0, parseFloat(item.percentage), 0, 0], // Only show in second bar
                            backgroundColor: tokenColor,
                            stack: 'stack1'
                        });
                    });
            });

            // Token Type datasets (Bar 3) - sorted with largest at bottom, independent colors
            const sortedTypePercentages = typePercentages.sort((a, b) => parseFloat(b.percentage) - parseFloat(a.percentage));
            sortedTypePercentages.forEach((item, index) => {
                datasets.push({
                    label: `Type: ${item.label}`,
                    data: [0, 0, parseFloat(item.percentage), 0], // Only show in third bar
                    backgroundColor: typeColors[item.label] || '#9CA3AF',
                    stack: 'stack1'
                });
            });

            // Location datasets (Bar 4)
            locationPercentages.forEach((item, index) => {
                datasets.push({
                    label: `Location: ${item.label}`,
                    data: [0, 0, 0, parseFloat(item.percentage)], // Only show in fourth bar
                    backgroundColor: locationColors[index % locationColors.length],
                    stack: 'stack1'
                });
            });

            // Destroy existing chart if it exists
            if (window.portfolioStackedChartInstance) {
                window.portfolioStackedChartInstance.destroy();
            }



            window.portfolioStackedChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Risk Level', 'Token Allocation', 'Token Type', 'Location'],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    categoryPercentage: 0.8, // Make bars thicker
                    barPercentage: 0.9,
                    scales: {
                        x: {
                            stacked: true,
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 14,
                                    weight: 'bold',
                                    family: 'Inter, -apple-system, sans-serif'
                                },
                                color: '#E0E7FF'
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                },
                                font: {
                                    size: 12
                                },
                                color: '#94A3B8'
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)',
                                drawBorder: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false, // Hide legend for cleaner look
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleColor: '#E0E7FF',
                            bodyColor: '#CBD5E1',
                            borderColor: '#475569',
                            borderWidth: 1,
                            cornerRadius: 8,
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    if (value > 0) {
                                        // Calculate dollar amount
                                        const category = label.split(': ')[0];
                                        const itemName = label.split(': ')[1];
                                        let amount = 0;
                                        
                                        if (category === 'Risk') {
                                            amount = riskData[itemName] || 0;
                                        } else if (category === 'Type') {
                                            amount = typeData[itemName] || 0;
                                        } else if (category === 'Location') {
                                            amount = locationData[itemName] || 0;
                                        } else if (category === 'Token') {
                                            amount = itemName === 'Others' ? otherTokenValue : (tokenData[itemName] || 0);
                                        }
                                        
                                        return `${itemName}: ${value}% ($${amount.toLocaleString()})`;
                                    }
                                    return null;
                                },
                                filter: function(tooltipItem) {
                                    return tooltipItem.parsed.y > 0;
                                }
                            }
                        },
                        datalabels: {
                            display: function(context) {
                                const value = context.parsed ? context.parsed.y : context.dataset.data[context.dataIndex];
                                return value > 5; // Only show labels for segments > 5%
                            },
                            color: '#FFFFFF',
                            font: {
                                size: 11,
                                weight: 'bold',
                                family: 'Inter, -apple-system, sans-serif'
                            },
                            formatter: function(value, context) {
                                if (value <= 5) return ''; // Don't show labels for small segments
                                const label = context.dataset.label || '';
                                const itemName = label.split(': ')[1];
                                return itemName; // Just show the clean segment title
                            },
                            textAlign: 'center',
                            anchor: 'center',
                            align: 'center'
                        }
                    }
                }
            });
        };

        // Generate Target vs Current Allocation Stacked Bar Chart
        window.generateTargetVsCurrentCharts = function(portfolioData) {
            console.log('ðŸ“Š Generating target vs current allocation analysis...');
            console.log('Portfolio data:', portfolioData);
            console.log('Target allocation:', window.targetAllocation);
            
            // Calculate current allocation from portfolio data
            const currentRiskAllocation = {};
            let totalCurrentValue = 0;
            
            portfolioData.forEach(row => {
                const quantity = parseFloat(row[3]) || 0;
                const price = parseFloat(row[4]) || 0;
                const value = quantity * price;
                const riskLevel = row[7] || 'Unknown';
                
                currentRiskAllocation[riskLevel] = (currentRiskAllocation[riskLevel] || 0) + value;
                totalCurrentValue += value;
            });
            
            console.log('Current risk allocation:', currentRiskAllocation);
            console.log('Total current value:', totalCurrentValue);
            
            // Convert to percentages
            const currentPercentages = {};
            Object.keys(currentRiskAllocation).forEach(risk => {
                currentPercentages[risk] = totalCurrentValue > 0 ? 
                    (currentRiskAllocation[risk] / totalCurrentValue) * 100 : 0;
            });
            
            console.log('Current percentages:', currentPercentages);
            
            // Generate stacked bar chart
            window.generateTargetVsCurrentStackedChart(window.targetAllocation, currentPercentages);
        };

        // Generate Target vs Current Allocation Stacked Bar Chart
        window.generateTargetVsCurrentStackedChart = function(targetAllocation, currentPercentages) {
            const ctx = document.getElementById('targetVsCurrentChart');
            if (!ctx) return;

            // Destroy existing chart if it exists
            if (window.targetVsCurrentChartInstance) {
                window.targetVsCurrentChartInstance.destroy();
            }

            // Risk level colors (same as main portfolio chart)
            const riskColors = {
                'Low': '#6B7280',          // Gray
                'Low risk': '#6B7280',     // Gray (alternative)
                'Medium': '#F59E0B',       // Amber
                'Medium risk': '#F59E0B',  // Amber (alternative)
                'High': '#EF4444',         // Red
                'High risk': '#EF4444',    // Red (alternative)
                'Degen': '#DC2626',        // Dark Red
                'Stablecoin': '#3B82F6',   // Blue
                'None': '#9CA3AF'          // Light Gray for "None" category
            };

            // Get all risk categories (union of target and current)
            const allRiskCategories = [...new Set([
                ...Object.keys(targetAllocation),
                ...Object.keys(currentPercentages)
            ])];

            // Sort categories for consistent display
            allRiskCategories.sort();

            // Prepare datasets for target and current
            const targetDatasets = [];
            const currentDatasets = [];

            allRiskCategories.forEach(riskCategory => {
                const targetPercent = targetAllocation[riskCategory] || 0;
                const currentPercent = currentPercentages[riskCategory] || 0;
                const color = riskColors[riskCategory] || '#6B7280';

                if (targetPercent > 0) {
                    targetDatasets.push({
                        label: `Target: ${riskCategory}`,
                        data: [targetPercent, 0], // [Target bar, Current bar]
                        backgroundColor: color,
                        borderColor: '#1E293B',
                        borderWidth: 1
                    });
                }

                if (currentPercent > 0) {
                    currentDatasets.push({
                        label: `Current: ${riskCategory}`,
                        data: [0, currentPercent], // [Target bar, Current bar]
                        backgroundColor: color,
                        borderColor: '#1E293B',
                        borderWidth: 1
                    });
                }
            });

            // Combine datasets
            const datasets = [...targetDatasets, ...currentDatasets];

            window.targetVsCurrentChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Target Allocation', 'Current Allocation'],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    categoryPercentage: 0.6,
                    barPercentage: 0.8,
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                color: '#E0E7FF'
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                font: {
                                    size: 12
                                },
                                color: '#94A3B8',
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)',
                                drawBorder: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false, // Hide legend for cleaner look
                            position: 'top',
                            labels: {
                                color: '#E0E7FF',
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleColor: '#E0E7FF',
                            bodyColor: '#CBD5E1',
                            borderColor: '#475569',
                            borderWidth: 1,
                            cornerRadius: 8,
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    try {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed && context.parsed.y ? context.parsed.y : 0;
                                        if (value > 0) {
                                            return `${label}: ${value.toFixed(1)}%`;
                                        }
                                        return null;
                                    } catch (error) {
                                        console.error('Tooltip error:', error);
                                        return null;
                                    }
                                }
                            }
                        },
                        // Data labels for segments >5%
                        datalabels: {
                            display: function(context) {
                                try {
                                    return context.parsed && context.parsed.y > 5;
                                } catch (error) {
                                    return false;
                                }
                            },
                            formatter: function(value, context) {
                                try {
                                    if (value > 5 && context.dataset && context.dataset.label) {
                                        // Extract the segment name from the label (e.g., "Target: High risk" -> "High risk")
                                        const label = context.dataset.label.split(': ')[1] || context.dataset.label;
                                        // Format like top charts: "High 40%" or "High 51%"
                                        return `${label} ${value.toFixed(0)}%`;
                                    }
                                    return '';
                                } catch (error) {
                                    return '';
                                }
                            },
                            color: '#FFFFFF',
                            font: {
                                size: 11,
                                weight: 'bold'
                            },
                            backgroundColor: null,
                            borderRadius: 0,
                            padding: 0,
                            textAlign: 'center',
                            anchor: 'center',
                            align: 'center'
                        }
                    }
                }
            });
        };

        // Function to fetch live transaction data for a specific investor
        window.fetchInvestorTransactions = async function(investorId) {
            try {
                console.log(`ðŸ“‹ Fetching transactions for investor: ${investorId}`);
                
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Transactions!A:F?key=${API_KEY}`
                );
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.values && data.values.length > 1) {
                    console.log('âœ… Successfully fetched transaction data');
                    
                    // Filter transactions for this investor (skip header row)
                    const investorTransactions = [];
                    for (let i = 1; i < data.values.length; i++) {
                        const row = data.values[i];
                        if (row && row.length >= 6) {
                            const rowInvestorId = row[1]; // Column B: Investor ID
                            if (rowInvestorId === investorId) {
                                investorTransactions.push({
                                    date: row[0] || '', // Column A: Date
                                    investorId: row[1] || '', // Column B: Investor ID
                                    type: row[2] || '', // Column C: Type
                                    amount: parseFloat(row[3]?.replace(/[$,]/g, '')) || 0, // Column D: Amount
                                    method: row[4] || '', // Column E: Method
                                    notes: row[5] || '' // Column F: Notes
                                });
                            }
                        }
                    }
                    
                    console.log(`ðŸ“Š Found ${investorTransactions.length} transactions for investor ${investorId}`);
                    return investorTransactions;
                } else {
                    console.log('âš ï¸ No transaction data found');
                    return [];
                }
            } catch (error) {
                console.error('âŒ Error fetching transactions:', error);
                return [];
            }
        };

        // Function to show investor details modal
        window.showInvestorDetails = async function(investorId, name, joinDate, totalInvestment, currentValue, totalReturn) {
            console.log(`ðŸ“Š Showing details for investor: ${investorId} - ${name}`);
            
            // Populate investor summary
            document.getElementById('detailInvestorId').textContent = investorId;
            document.getElementById('detailInvestorName').textContent = name;
            document.getElementById('detailJoinDate').textContent = joinDate;
            document.getElementById('detailTotalInvestment').textContent = `$${totalInvestment.toLocaleString()}`;
            document.getElementById('detailCurrentValue').textContent = `$${currentValue.toLocaleString()}`;
            
            const returnClass = totalReturn >= 0 ? 'positive' : 'negative';
            const returnSign = totalReturn >= 0 ? '+' : '';
            document.getElementById('detailTotalReturn').innerHTML = `<span class="${returnClass}">${returnSign}${totalReturn.toFixed(1)}%</span>`;
            
            // Update modal title
            document.getElementById('investorDetailsTitle').textContent = `${name} (${investorId})`;
            
            // Show loading state
            const transactionsBody = document.getElementById('investorTransactionsBody');
            transactionsBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #7f8c8d;">Loading transactions...</td></tr>';
            
            // Show the modal first
            document.getElementById('investorDetailsModal').classList.add('active');
            
            // Fetch real transaction data from database
            const liveTransactions = await window.fetchInvestorTransactions(investorId);
            
            let transactionHTML = '';
            
            if (liveTransactions && liveTransactions.length > 0) {
                // Use live transaction data from database
                console.log(`âœ… Displaying ${liveTransactions.length} live transactions`);
                liveTransactions.forEach(transaction => {
                    // Format date as single line: MM/DD/YYYY
                    const formattedDate = transaction.date ? 
                        new Date(transaction.date).toLocaleDateString('en-US', {
                            month: '2-digit',
                            day: '2-digit', 
                            year: 'numeric'
                        }) : 'N/A';
                    const typeClass = transaction.type === 'Investment' ? 'positive' : 'negative';
                    const typeIcon = transaction.type === 'Investment' ? 'â†—ï¸' : 'â†™ï¸';
                    
                    transactionHTML += `
                        <tr>
                            <td style="white-space: nowrap;">${formattedDate}</td>
                            <td><span class="${typeClass}">${typeIcon} ${transaction.type}</span></td>
                            <td>$${transaction.amount.toLocaleString()}</td>
                            <td>${transaction.notes || 'No notes'}</td>
                        </tr>
                    `;
                });
            } else {
                // Show error when no live transaction data is available
                console.error('âŒ No live transaction data available from database');
                transactionHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 20px; color: #ef4444;">
                            <div style="font-size: 18px; margin-bottom: 8px;">âš ï¸</div>
                            <div style="font-weight: 600; margin-bottom: 4px;">Database Connection Error</div>
                            <div style="font-size: 14px; color: #94a3b8;">Failed to load transaction data from database</div>
                        </td>
                        </tr>
                    `;
            }
            
            // Update the table with live data or error message
            transactionsBody.innerHTML = transactionHTML || '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #7f8c8d;">No transactions found</td></tr>';
        };

        // Function to close investor details modal
        window.closeInvestorModal = function() {
            console.log('âŒ Closing investor details modal');
            document.getElementById('investorDetailsModal').classList.remove('active');
        };

        // Function to scroll to investor table (for Investors tab)
        window.scrollToInvestorTable = function() {
            console.log('ðŸ“ Scrolling to investor table...');
            const investorTable = document.getElementById('investorsTable');
            if (investorTable) {
                investorTable.scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
                console.log('âœ… Scrolled to investor table');
            } else {
                console.log('âš ï¸ Investor table not found');
            }
        };

        // === INVESTOR TABLE ENHANCEMENTS ===
        
        // Global variables for investor table state
        window.investorTableState = {
            currentSort: { column: null, direction: 'asc' },
            allInvestors: [],
            filteredInvestors: []
        };

        // Function to sort investors table
        window.sortInvestors = function(column) {
            console.log(`ðŸ”„ Sorting investors by ${column}`);
            
            const tbody = document.getElementById('investorsTableBody');
            if (!tbody) return;
            
            const rows = Array.from(tbody.querySelectorAll('tr'));
            if (rows.length === 0) return;
            
            // Determine sort direction
            let direction = 'asc';
            if (window.investorTableState.currentSort.column === column) {
                direction = window.investorTableState.currentSort.direction === 'asc' ? 'desc' : 'asc';
            }
            
            // Update sort state
            window.investorTableState.currentSort = { column, direction };
            
            // Update sort indicators
            document.querySelectorAll('.sort-indicator').forEach(indicator => {
                indicator.textContent = 'â†•';
                indicator.style.color = '#7f8c8d';
            });
            
            // Update current column indicator
            const currentHeader = document.querySelector(`th[onclick*="${column}"] .sort-indicator`);
            if (currentHeader) {
                currentHeader.textContent = direction === 'asc' ? 'â†‘' : 'â†“';
                currentHeader.style.color = '#00ff88';
            }
            
            // Sort rows
            rows.sort((a, b) => {
                let aValue, bValue;
                
                switch (column) {
                    case 'id':
                        aValue = a.cells[0].textContent.trim();
                        bValue = b.cells[0].textContent.trim();
                        break;
                    case 'name':
                        aValue = a.cells[1].textContent.trim();
                        bValue = b.cells[1].textContent.trim();
                        break;
                    case 'date':
                        // Parse dates for sorting (MM/DD/YYYY format)
                        const aDateStr = a.cells[2].textContent.trim();
                        const bDateStr = b.cells[2].textContent.trim();
                        aValue = new Date(aDateStr);
                        bValue = new Date(bDateStr);
                        break;
                    case 'investment':
                        aValue = parseFloat(a.cells[3].textContent.replace(/[$,]/g, ''));
                        bValue = parseFloat(b.cells[3].textContent.replace(/[$,]/g, ''));
                        break;
                    case 'aum':
                        aValue = parseFloat(a.cells[4].textContent.replace(/[$,]/g, ''));
                        bValue = parseFloat(b.cells[4].textContent.replace(/[$,]/g, ''));
                        break;
                    case 'share':
                        aValue = parseFloat(a.cells[5].textContent.replace(/[%]/g, ''));
                        bValue = parseFloat(b.cells[5].textContent.replace(/[%]/g, ''));
                        break;
                    case 'return':
                        aValue = parseFloat(a.cells[6].textContent.replace(/[%+]/g, ''));
                        bValue = parseFloat(b.cells[6].textContent.replace(/[%+]/g, ''));
                        break;
                    default:
                        return 0;
                }
                
                if (aValue < bValue) return direction === 'asc' ? -1 : 1;
                if (aValue > bValue) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
            
            console.log(`âœ… Sorted investors by ${column} (${direction})`);
        };

        // Function to filter investors
        window.filterInvestors = function() {
            console.log('ðŸ” Filtering investors...');
            
            const searchTerm = document.getElementById('investorSearch').value.toLowerCase();
            const tbody = document.getElementById('investorsTableBody');
            
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr');
            let visibleCount = 0;
            
            // Get active filters
            const activeFilters = window.getActiveFilters();
            
            rows.forEach(row => {
                const name = row.cells[1].textContent.toLowerCase();
                const id = row.cells[0].textContent.toLowerCase();
                const returnText = row.cells[6].textContent;
                const returnValue = parseFloat(returnText.replace(/[%+]/g, ''));
                const investmentText = row.cells[3].textContent;
                const investmentValue = parseFloat(investmentText.replace(/[$,]/g, ''));
                const shareText = row.cells[5].textContent;
                const shareValue = parseFloat(shareText.replace(/[%]/g, ''));
                
                let showRow = true;
                
                // Search filter
                if (searchTerm && !name.includes(searchTerm) && !id.includes(searchTerm)) {
                    showRow = false;
                }
                
                // Return filters
                if (activeFilters.positive && returnValue <= 0) showRow = false;
                if (activeFilters.negative && returnValue >= 0) showRow = false;
                if (activeFilters.high && returnValue < 50) showRow = false;
                
                // Investment size filters
                if (activeFilters.small && investmentValue >= 1000) showRow = false;
                if (activeFilters.medium && (investmentValue < 1000 || investmentValue > 5000)) showRow = false;
                if (activeFilters.large && investmentValue <= 5000) showRow = false;
                
                // AUM filters
                if (activeFilters.major && shareValue <= 20) showRow = false;
                
                row.style.display = showRow ? '' : 'none';
                if (showRow) visibleCount++;
            });
            
            console.log(`âœ… Filtered investors: ${visibleCount} visible`);
            
            // Show/hide Clear All button based on filter state
            window.updateClearAllButton();
        };

        // Function to get active filters
        window.getActiveFilters = function() {
            const filters = {
                positive: false,
                negative: false,
                high: false,
                small: false,
                medium: false,
                large: false,
                major: false
            };
            
            document.querySelectorAll('.filter-chip.active').forEach(chip => {
                const filterType = chip.getAttribute('data-filter');
                if (filters.hasOwnProperty(filterType)) {
                    filters[filterType] = true;
                }
            });
            
            return filters;
        };
        
        // Function to toggle filter chips
        window.toggleFilter = function(filterType) {
            const chip = document.querySelector(`[data-filter="${filterType}"]`);
            if (!chip) return;
            
            // Toggle active state
            chip.classList.toggle('active');
            
            // Add specific class for styling
            if (chip.classList.contains('active')) {
                if (filterType === 'negative') chip.classList.add('negative');
                if (filterType === 'high') chip.classList.add('high');
            } else {
                chip.classList.remove('negative', 'high');
            }
            
            // Apply filter
            window.filterInvestors();
        };
        
        // Function to update Clear All button state
        window.updateClearAllButton = function() {
            const clearAllButton = document.getElementById('clearAllButton');
            if (!clearAllButton) return;
            
            const searchTerm = document.getElementById('investorSearch').value.trim();
            const activeFilters = window.getActiveFilters();
            const hasActiveFilters = Object.values(activeFilters).some(filter => filter === true);
            
            // Update button styling based on filter state
            if (searchTerm || hasActiveFilters) {
                // Active state - colored with hover effects
                clearAllButton.style.borderColor = '#ff4757';
                clearAllButton.style.color = '#ff4757';
                clearAllButton.style.cursor = 'pointer';
                clearAllButton.onmouseover = function() {
                    this.style.background = '#ff4757';
                    this.style.color = 'white';
                };
                clearAllButton.onmouseout = function() {
                    this.style.background = 'transparent';
                    this.style.color = '#ff4757';
                };
            } else {
                // Inactive state - greyed out with no hover effects
                clearAllButton.style.borderColor = '#3d4148';
                clearAllButton.style.color = '#7f8c8d';
                clearAllButton.style.cursor = 'default';
                clearAllButton.onmouseover = null;
                clearAllButton.onmouseout = null;
            }
        };
        
        // Function to clear all filters
        window.clearAllFilters = function() {
            console.log('ðŸ§¹ Clearing all filters...');
            
            // Clear search
            document.getElementById('investorSearch').value = '';
            
            // Clear all filter chips
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active', 'negative', 'high');
            });
            
            // Reset sort indicators
            document.querySelectorAll('.sort-indicator').forEach(indicator => {
                indicator.textContent = 'â†•';
                indicator.style.color = '#7f8c8d';
            });
            
            // Reset sort state
            window.investorTableState.currentSort = { column: null, direction: 'asc' };
            
            // Show all rows
            window.filterInvestors();
            
            // Force Clear All button to inactive state
            const clearAllButton = document.getElementById('clearAllButton');
            if (clearAllButton) {
                clearAllButton.style.borderColor = '#3d4148';
                clearAllButton.style.color = '#7f8c8d';
                clearAllButton.style.cursor = 'default';
                clearAllButton.style.background = 'transparent';
                clearAllButton.onmouseover = null;
                clearAllButton.onmouseout = null;
            }
            
            console.log('âœ… All filters cleared');
        };


        // === PORTFOLIO FUNCTIONALITY ===
        
        // Global variables for portfolio
        window.portfolioAssets = [];
        window.assetSearchResults = [];
        
        // Autocomplete data storage
        window.autocompleteData = {
            riskLevels: new Set(),
            locations: new Set(),
            coinTypes: new Set(),
            blockchains: new Set(['Ethereum', 'Solana', 'Bitcoin', 'Hyperliquid', 'Polygon', 'Arbitrum', 'Optimism', 'Base'])
        };

        // Function to update autocomplete data from portfolio
        window.updateAutocompleteData = function(portfolioData) {
            console.log('ðŸ”„ Updating autocomplete data...');
            
            // Clear existing data (but keep default blockchains)
            window.autocompleteData.riskLevels.clear();
            window.autocompleteData.locations.clear();
            window.autocompleteData.coinTypes.clear();
            
            // Populate from existing portfolio data
            portfolioData.forEach(row => {
                if (row.length >= 10) {
                    const blockchain = row[2]?.trim();  // Column C: Chain
                    const riskLevel = row[7]?.trim();
                    const location = row[8]?.trim();
                    const coinType = row[9]?.trim();
                    
                    if (blockchain) window.autocompleteData.blockchains.add(blockchain);
                    if (riskLevel) window.autocompleteData.riskLevels.add(riskLevel);
                    if (location) window.autocompleteData.locations.add(location);
                    if (coinType) window.autocompleteData.coinTypes.add(coinType);
                }
            });
            
            console.log('ðŸ“Š Autocomplete data updated:', {
                riskLevels: Array.from(window.autocompleteData.riskLevels),
                locations: Array.from(window.autocompleteData.locations),
                coinTypes: Array.from(window.autocompleteData.coinTypes),
                blockchains: Array.from(window.autocompleteData.blockchains)
            });
        };

        // Function to setup autocomplete for a field
        window.setupAutocomplete = function(inputId, suggestionsId, dataSet) {
            const input = document.getElementById(inputId);
            const suggestions = document.getElementById(suggestionsId);
            let highlightedIndex = -1;
            
            if (!input || !suggestions) return;
            
            input.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                suggestions.innerHTML = '';
                highlightedIndex = -1;
                
                if (value.length === 0) {
                    suggestions.style.display = 'none';
                    return;
                }
                
                const matches = Array.from(dataSet).filter(item => 
                    item.toLowerCase().includes(value)
                ).sort((a, b) => {
                    // Prioritize items that start with the input
                    const aStarts = a.toLowerCase().startsWith(value);
                    const bStarts = b.toLowerCase().startsWith(value);
                    if (aStarts && !bStarts) return -1;
                    if (!aStarts && bStarts) return 1;
                    return a.localeCompare(b);
                });
                
                if (matches.length > 0) {
                    matches.forEach((match, index) => {
                        const div = document.createElement('div');
                        div.className = 'autocomplete-suggestion';
                        div.textContent = match;
                        div.addEventListener('click', function() {
                            input.value = match;
                            suggestions.style.display = 'none';
                        });
                        suggestions.appendChild(div);
                    });
                    suggestions.style.display = 'block';
                } else {
                    suggestions.style.display = 'none';
                }
            });
            
            // Handle keyboard navigation
            input.addEventListener('keydown', function(e) {
                const suggestionItems = suggestions.querySelectorAll('.autocomplete-suggestion');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    highlightedIndex = Math.min(highlightedIndex + 1, suggestionItems.length - 1);
                    updateHighlight(suggestionItems);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    highlightedIndex = Math.max(highlightedIndex - 1, -1);
                    updateHighlight(suggestionItems);
                } else if (e.key === 'Enter' && highlightedIndex >= 0) {
                    e.preventDefault();
                    suggestionItems[highlightedIndex].click();
                } else if (e.key === 'Escape') {
                    suggestions.style.display = 'none';
                    highlightedIndex = -1;
                }
            });
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.style.display = 'none';
                    highlightedIndex = -1;
                }
            });
            
            function updateHighlight(items) {
                items.forEach((item, index) => {
                    item.classList.toggle('highlighted', index === highlightedIndex);
                });
            }
        };
        
        // Debug function to test data
        window.debugPortfolioData = function() {
            console.log('ðŸ“Š Portfolio data loaded successfully');
            console.log('ðŸ“Š Autocomplete data:', {
                riskLevels: Array.from(window.autocompleteData.riskLevels),
                locations: Array.from(window.autocompleteData.locations),
                coinTypes: Array.from(window.autocompleteData.coinTypes)
            });
            
            // Test database connection
            window.loadPortfolioData().then(() => {
                console.log('âœ… Portfolio data loaded successfully');
            }).catch(error => {
                console.error('âŒ Error loading portfolio data:', error);
            });
                };

        // Function to get custom Hyperliquid assets
        window.getCustomHyperliquidAssets = function(query) {
            const customAssets = [
                {
                    id: 'buddy-hyperliquid',
                    name: 'Buddy',
                    symbol: 'BUDDY',
                    thumb: 'https://via.placeholder.com/32/00ff64/ffffff?text=B',
                    large: 'https://via.placeholder.com/64/00ff64/ffffff?text=B',
                    contract_address: '0x84ecb2340931f6b153ff10bcfafb6726'
                },
                {
                    id: 'hype-hyperliquid',
                    name: 'Hyperliquid',
                    symbol: 'HYPE',
                    thumb: 'https://via.placeholder.com/32/00ff64/ffffff?text=H',
                    large: 'https://via.placeholder.com/64/00ff64/ffffff?text=H'
                }
            ];
            
            const queryLower = query.toLowerCase();
            return customAssets.filter(asset => 
                asset.name.toLowerCase().includes(queryLower) ||
                asset.symbol.toLowerCase().includes(queryLower) ||
                asset.id.toLowerCase().includes(queryLower)
            );
        };
        
        // Function to open Add Asset modal
        window.openAddAssetModal = function() {
            console.log('ðŸ“ˆ Opening Add Asset modal...');
            document.getElementById('addAssetModal').classList.add('active');
            
            // Debug current autocomplete data
            console.log('ðŸ” Current autocomplete data when opening modal:', {
                riskLevels: Array.from(window.autocompleteData.riskLevels),
                locations: Array.from(window.autocompleteData.locations),
                coinTypes: Array.from(window.autocompleteData.coinTypes)
            });
            
            // Initialize autocomplete functionality
            setTimeout(() => {
                console.log('ðŸ”§ Setting up autocomplete with data:', {
                    riskLevels: Array.from(window.autocompleteData.riskLevels),
                    locations: Array.from(window.autocompleteData.locations),
                    coinTypes: Array.from(window.autocompleteData.coinTypes)
                });
                
                window.setupAutocomplete('assetRisk', 'riskSuggestions', window.autocompleteData.riskLevels);
                window.setupAutocomplete('assetLocation', 'locationSuggestions', window.autocompleteData.locations);
                window.setupAutocomplete('assetCoinType', 'coinTypeSuggestions', window.autocompleteData.coinTypes);
                window.setupAutocomplete('assetChain', 'chainSuggestions', window.autocompleteData.blockchains);
                
                console.log('âœ… Autocomplete setup complete');
            }, 100);
            // Reset form
            document.getElementById('addAssetForm').reset();
            document.getElementById('selectedAsset').value = '';
            document.getElementById('selectedAssetId').value = '';
            document.getElementById('selectedAssetSymbol').value = '';
            document.getElementById('selectedAssetImage').value = '';
            document.getElementById('assetChain').value = '';
            document.getElementById('selectedAssetInfo').style.display = 'none';
            document.getElementById('valuePreview').innerHTML = '<div style="font-size: 1.5rem; font-weight: bold; color: #1976d2;">$0.00</div><div style="font-size: 0.9rem; color: #7f8c8d;">Live price will be fetched automatically</div>';
        };
        
        // Function to close Add Asset modal
        window.closeAddAssetModal = function() {
            console.log('âŒ Closing Add Asset modal');
            document.getElementById('addAssetModal').classList.remove('active');
        };
        

        
        // Function to search assets using CoinGecko API
        window.searchAssets = async function(query) {
            if (!query || query.length < 2) {
                document.getElementById('assetDropdown').style.display = 'none';
                return;
            }
            
            try {
                console.log(`ðŸ” Searching for assets: ${query}`);
                
                // Check for custom Hyperliquid assets first (always check regardless of blockchain selection)
                const customHyperliquidAssets = window.getCustomHyperliquidAssets(query);
                
                // Use CoinGecko's search endpoint (free)
                const response = await fetch(`https://api.coingecko.com/api/v3/search?query=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                let allResults = [];
                
                // Add CoinGecko results
                if (data.coins && data.coins.length > 0) {
                    // No longer filter by chain - return all results
                    allResults = data.coins.slice(0, 15); // Get more results since we're not filtering
                }
                
                // Add custom Hyperliquid assets to the results
                if (customHyperliquidAssets.length > 0) {
                    allResults = [...customHyperliquidAssets, ...allResults];
                }
                
                if (allResults.length > 0) {
                    window.assetSearchResults = allResults.slice(0, 10); // Limit to 10 total results
                    window.displayAssetSearchResults(window.assetSearchResults);
                } else {
                    document.getElementById('assetDropdown').innerHTML = '<div style="padding: 10px; color: #7f8c8d;">No assets found</div>';
                    document.getElementById('assetDropdown').style.display = 'block';
                }
            } catch (error) {
                console.error('âŒ Error searching assets:', error);
                document.getElementById('assetDropdown').innerHTML = '<div style="padding: 10px; color: #dc3545;">Error searching assets</div>';
                document.getElementById('assetDropdown').style.display = 'block';
            }
        };
        

        
        // Function to display asset search results
        window.displayAssetSearchResults = function(results) {
            const dropdown = document.getElementById('assetDropdown');
            let html = '';
            
            results.forEach(asset => {
                html += `
                    <div class="asset-result" onclick="window.selectAsset('${asset.id}', '${asset.name}', '${asset.symbol}', '${asset.large || asset.thumb}')" style="padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; gap: 10px;">
                        <img src="${asset.large || asset.thumb}" alt="${asset.name}" style="width: 24px; height: 24px;">
                        <div>
                            <div style="font-weight: bold;">${asset.name}</div>
                            <div style="font-size: 0.8rem; color: #7f8c8d;">${asset.symbol.toUpperCase()}</div>
                        </div>
                    </div>
                `;
            });
            
            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
        };
        
        // Function to detect blockchain based on asset
        window.detectBlockchain = function(assetId, assetName, assetSymbol) {
            const symbolLower = assetSymbol.toLowerCase();
            const nameLower = assetName.toLowerCase();
            
            // Hyperliquid assets (custom ones)
            if (['hyperliquid', 'hype', 'purr', 'jeff', 'god', 'hfun', 'buddy'].includes(symbolLower) || 
                nameLower.includes('hyperliquid')) {
                return 'Hyperliquid';
            }
            
            // Solana ecosystem assets
            if (['sol', 'ray', 'orca', 'msol', 'jto', 'hnt', 'render', 'pyth', 'w', 'kmno', 'drift', 
                 'tnsr', 'bonk', 'wif', 'popcat', 'bome', 'boden', 'moodeng', 'jitosol', 'step'].includes(symbolLower) ||
                nameLower.includes('solana') || nameLower.includes('raydium') || nameLower.includes('marinade') ||
                nameLower.includes('jito') || nameLower.includes('helium') || nameLower.includes('render') ||
                nameLower.includes('pyth') || nameLower.includes('wormhole') || nameLower.includes('bonk') ||
                nameLower.includes('dogwifcoin')) {
                return 'Solana';
            }
            
            // Bitcoin
            if (symbolLower === 'btc' || nameLower.includes('bitcoin')) {
                return 'Bitcoin';
            }
            
            // Ethereum ecosystem assets (including specific ones like Aura)
            if (['aura', 'cvx', 'bal', 'uni', 'link', 'mkr', 'comp', 'aave', 'snx', 'crv', 'yfi', 
                 '1inch', 'grt', 'ens', 'wbtc', 'dai', 'frax', 'reth', 'steth', 'shib', 'pepe'].includes(symbolLower) ||
                nameLower.includes('aura') || nameLower.includes('convex') || nameLower.includes('balancer') ||
                nameLower.includes('uniswap') || nameLower.includes('chainlink') || nameLower.includes('ethereum')) {
                return 'Ethereum';
            }
            
            // Default to Ethereum for most other assets (since CoinGecko has many ERC-20 tokens)
            return 'Ethereum';
        };

        // Function to select an asset
        window.selectAsset = async function(assetId, assetName, assetSymbol, assetImage) {
            console.log(`ðŸª™ Selected asset: ${assetName} (${assetSymbol})`);
            
            document.getElementById('assetSearch').value = `${assetName} (${assetSymbol.toUpperCase()})`;
            document.getElementById('selectedAsset').value = assetName;
            document.getElementById('selectedAssetId').value = assetId;
            document.getElementById('selectedAssetSymbol').value = assetSymbol;
            document.getElementById('selectedAssetImage').value = assetImage;
            document.getElementById('assetDropdown').style.display = 'none';
            
            // Auto-populate blockchain field
            const detectedBlockchain = window.detectBlockchain(assetId, assetName, assetSymbol);
            document.getElementById('assetChain').value = detectedBlockchain;
            console.log(`ðŸ”— Auto-detected blockchain: ${detectedBlockchain}`);
            
            // Show selected asset info
            const assetInfo = document.getElementById('selectedAssetInfo');
            assetInfo.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <img src="${assetImage}" alt="${assetName}" style="width: 32px; height: 32px;">
                    <div>
                        <div style="font-weight: bold;">${assetName}</div>
                        <div style="font-size: 0.8rem; color: #7f8c8d;">${assetSymbol.toUpperCase()} â€¢ Chain: ${detectedBlockchain}</div>
                    </div>
                </div>
            `;
            assetInfo.style.display = 'block';
            
            // Fetch current price
            await window.updateValuePreview(assetId);
        };
        
        // Function to handle adding asset to portfolio
        window.handleAddAsset = async function(event) {
            event.preventDefault();
            
            const selectedChain = document.getElementById('assetChain').value;
            const selectedAssetId = document.getElementById('selectedAssetId').value;
            const selectedAssetName = document.getElementById('selectedAsset').value;
            const selectedAssetSymbol = document.getElementById('selectedAssetSymbol').value;
            const selectedAssetImage = document.getElementById('selectedAssetImage').value;
            const quantity = parseFloat(document.getElementById('assetQuantity').value);
            const riskLevel = document.getElementById('assetRisk').value;
            const location = document.getElementById('assetLocation').value;
            const coinType = document.getElementById('assetCoinType').value;
            
            if (!selectedChain || !selectedAssetId || !selectedAssetName || !selectedAssetSymbol || !quantity || !riskLevel || !location || !coinType) {
                alert('Please fill in all required fields');
                return;
            }
            
            console.log('ðŸš€ Adding asset to portfolio:', {
                chain: selectedChain,
                assetId: selectedAssetId,
                name: selectedAssetName,
                symbol: selectedAssetSymbol,
                quantity: quantity
            });
            
            try {
                let currentPrice = 0;
                
                // Check cache first
                const cachedData = window.priceCache.get(selectedAssetId);
                if (cachedData) {
                    console.log(`ðŸ’¾ Using cached price for adding ${selectedAssetSymbol}`);
                    currentPrice = cachedData.usd;
                } else if (window.apiRateLimit.canMakeRequest()) {
                    // Make API request if within rate limit
                    console.log(`ðŸ’° Fetching price for adding ${selectedAssetSymbol}`);
                    window.apiRateLimit.recordRequest();
                    
                    const priceResponse = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${selectedAssetId}&vs_currencies=usd&include_24hr_change=true`);
                    if (priceResponse.ok) {
                        const priceData = await priceResponse.json();
                        currentPrice = priceData[selectedAssetId]?.usd || 0;
                        
                        // Cache the result
                        if (priceData[selectedAssetId]) {
                            window.priceCache.set(selectedAssetId, priceData[selectedAssetId]);
                        }
                    } else {
                        throw new Error(`HTTP ${priceResponse.status}`);
                    }
                } else {
                    // Use fallback price if rate limited
                    console.warn(`â±ï¸ Rate limited when adding asset, using fallback price`);
                    currentPrice = window.fallbackPrices[selectedAssetId.toLowerCase()] || window.fallbackPrices[selectedAssetSymbol.toLowerCase()] || 1;
                }
                const totalValue = currentPrice * quantity;
                
                // Prepare asset data for database
                const assetData = {
                    name: selectedAssetName,
                    symbol: selectedAssetSymbol.toUpperCase(),
                    chain: selectedChain,
                    quantity: quantity,
                    currentPrice: currentPrice,
                    totalValue: totalValue,
                    imageUrl: selectedAssetImage,
                    riskLevel: riskLevel,
                    location: location,
                    coinType: coinType
                };
                
                // Add to database
                const success = await window.addAssetToDatabase(assetData);
                
                if (success) {
                    alert(`Successfully added ${quantity} ${selectedAssetSymbol.toUpperCase()} to your portfolio!`);
                    
                    // Close modal and refresh portfolio
                    window.closeAddAssetModal();
                    await window.loadPortfolioData();
                } else {
                    alert('Failed to add asset to database. Please try again.');
                }
                
            } catch (error) {
                console.error('âŒ Error adding asset:', error);
                alert('Error adding asset. Please try again.');
            }
        };

        // Function to add asset to Google Sheets Portfolio tab via Google Apps Script
        window.addAssetToDatabase = async function(assetData) {
            try {
                console.log('ðŸ’¾ Adding asset to database via Apps Script:', assetData);
                
                // Google Apps Script webhook URL
                const webhookUrl = CONFIG.GOOGLE_APPS_SCRIPT_URL;
                
                // Use GET request with URL parameters (POST requests have CORS issues)
                const urlWithParams = `${webhookUrl}?action=add&name=${encodeURIComponent(assetData.name)}&symbol=${encodeURIComponent(assetData.symbol)}&chain=${encodeURIComponent(assetData.chain)}&quantity=${encodeURIComponent(assetData.quantity)}&currentPrice=${encodeURIComponent(assetData.currentPrice)}&totalValue=${encodeURIComponent(assetData.totalValue)}&imageUrl=${encodeURIComponent(assetData.imageUrl)}&riskLevel=${encodeURIComponent(assetData.riskLevel)}&location=${encodeURIComponent(assetData.location)}&coinType=${encodeURIComponent(assetData.coinType)}`;
                
                console.log('ðŸŒ Sending GET request to add asset:', urlWithParams);
                
                // Send data to Google Apps Script via GET
                const response = await fetch(urlWithParams, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                console.log('ðŸ“¡ Response status:', response.status);
                console.log('ðŸ“¡ Response ok:', response.ok);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const responseText = await response.text();
                console.log('ðŸ“„ Raw response:', responseText);
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('âŒ Failed to parse response as JSON:', parseError);
                    throw new Error(`Invalid JSON response: ${responseText}`);
                }
                
                console.log('ðŸ“‹ Parsed result:', result);
                
                if (result.success) {
                    console.log('âœ… Asset successfully added to database via Apps Script');
                    return true;
                } else {
                    console.error('âŒ Apps Script returned error:', result.error);
                    
                    // Show error with manual entry fallback
                    const manualEntry = `
                        âŒ Google Apps Script Error: ${result.error}
                        
                        Please manually add this row to your Portfolio tab:
                        
                        Column A (Asset Name): ${assetData.name}
                        Column B (Symbol): ${assetData.symbol}
                        Column C (Chain): ${assetData.chain}
                        Column D (Quantity): ${assetData.quantity}
                        Column E (Current Price): ${assetData.currentPrice}
                        Column F (Total Value): ${assetData.totalValue}
                        
                        Tab-separated line to copy:
                        ${assetData.name}\t${assetData.symbol}\t${assetData.chain}\t${assetData.quantity}\t${assetData.currentPrice}\t${assetData.totalValue}
                    `;
                    
                    console.log(manualEntry);
                    alert(manualEntry);
                    return false;
                }
            } catch (error) {
                console.error('âŒ Network/Fetch error:', error);
                
                // Network error fallback with detailed error info
                const manualEntry = `
                    âŒ Network Error: ${error.message}
                    
                    Please manually add this row to your Portfolio tab:
                    
                    Column A (Asset Name): ${assetData.name}
                    Column B (Symbol): ${assetData.symbol}
                    Column C (Chain): ${assetData.chain}
                    Column D (Quantity): ${assetData.quantity}
                    Column E (Current Price): ${assetData.currentPrice}
                    Column F (Total Value): ${assetData.totalValue}
                    
                    Tab-separated line to copy:
                    ${assetData.name}\t${assetData.symbol}\t${assetData.chain}\t${assetData.quantity}\t${assetData.currentPrice}\t${assetData.totalValue}
                `;
                
                console.log(manualEntry);
                alert(manualEntry);
                return false;
            }
        };

        // Function to fetch portfolio data from Google Sheets
        window.fetchPortfolioData = async function() {
            try {
                console.log('ðŸ’¼ Fetching portfolio data from Google Sheets...');
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Portfolio!A:J?key=${API_KEY}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.values && data.values.length > 1) {
                    console.log('âœ… Successfully fetched portfolio data');
                    return data.values.slice(1); // Skip header row
                } else {
                    console.log('âš ï¸ No portfolio data found');
                    return [];
                }
            } catch (error) {
                console.error('âŒ Error fetching portfolio data:', error);
                return null;
            }
        };



        // Back to login function
        window.backToLogin = function() {
            console.log('ðŸ  Returning to login screen...');
            
            // Clear saved app state
            localStorage.removeItem('wagmi_current_tab');
            localStorage.removeItem('wagmi_manager_view_active');
            
            const loginScreen = document.getElementById('loginScreen');
            const managerView = document.getElementById('managerView');
            
            if (loginScreen && managerView) {
                loginScreen.style.display = 'flex';
                managerView.style.display = 'none';
                console.log('âœ… Returned to login screen and cleared saved state');
            }
        };

        // Function to delete an asset from portfolio
        window.deleteAsset = function(uniqueRowId) {
            const assetRow = document.querySelector(`[data-asset-id="${uniqueRowId}"]`);
            if (!assetRow) {
                console.error(`Asset row not found for unique ID: ${uniqueRowId}`);
                return;
            }

            // Get asset details from the row
            const assetSymbol = assetRow.getAttribute('data-symbol');
            const assetName = assetRow.querySelector('.asset-name')?.textContent || assetSymbol.toUpperCase();
            
            // Confirm deletion
            if (!confirm(`Are you sure you want to delete ${assetName} (${assetSymbol.toUpperCase()}) from your portfolio?\n\nThis action cannot be undone.`)) {
                return;
            }

            console.log(`ðŸ—‘ï¸ Deleting asset: ${assetSymbol} (Row ID: ${uniqueRowId})`);
            
            // Call the delete function using the symbol (database still uses symbol for deletion)
            window.deleteAssetFromDatabase(assetSymbol)
                .then(success => {
                    if (success) {
                        console.log(`âœ… Successfully deleted ${assetSymbol}`);
                        // Refresh portfolio to reflect changes
                        window.loadPortfolioData();
                    } else {
                        alert(`Failed to delete ${assetName}. Please try again.`);
                    }
                })
                .catch(error => {
                    console.error('âŒ Error deleting asset:', error);
                    alert(`Error deleting ${assetName}. Please try again.`);
                });
        };

        // Function to delete asset from Google Sheets Portfolio tab via Google Apps Script
        window.deleteAssetFromDatabase = async function(assetSymbol) {
            try {
                console.log(`ðŸ’¾ Deleting asset from database via Apps Script: ${assetSymbol}`);
                
                // Google Apps Script webhook URL
                const webhookUrl = CONFIG.GOOGLE_APPS_SCRIPT_URL;
                
                // Use GET request with URL parameters - ensure uppercase for database matching
                const urlWithParams = `${webhookUrl}?action=delete&symbol=${encodeURIComponent(assetSymbol.toUpperCase())}`;
                
                console.log('ðŸŒ Sending GET request to delete asset:', urlWithParams);
                
                // Send delete request to Google Apps Script
                const response = await fetch(urlWithParams, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                console.log('ðŸ“¡ Delete response status:', response.status);
                console.log('ðŸ“¡ Delete response ok:', response.ok);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('ðŸ“¡ Delete response data:', result);
                
                if (result.success) {
                    console.log('âœ… Asset deleted successfully from database');
                    return true;
                } else {
                    console.error('âŒ Failed to delete asset:', result.error || 'Unknown error');
                    return false;
                }
                
            } catch (error) {
                console.error('âŒ Error deleting asset from database:', error);
                return false;
            }
        };

        // Asset editing functions (quantity + new fields)
        window.editAssetFields = function(uniqueRowId) {
            console.log(`âœï¸ Editing fields for row ${uniqueRowId}`);
            const assetRow = document.querySelector(`[data-asset-id="${uniqueRowId}"]`);
            if (!assetRow) return;
            
            // Get the actual symbol from the data attribute
            const assetSymbol = assetRow.getAttribute('data-symbol');

            // Show all input fields, hide all display elements
            const displays = assetRow.querySelectorAll('.quantity-display, .risk-display, .location-display, .cointype-display');
            const inputs = assetRow.querySelectorAll('.asset-quantity-input, .asset-risk-input, .asset-location-input, .asset-cointype-input');
            
            displays.forEach(display => display.style.display = 'none');
            inputs.forEach(input => {
                input.style.display = 'block';
                // Store original values
                input.dataset.originalValue = input.value || input.options[input.selectedIndex]?.value || '';
            });

            // Focus on quantity input
            const quantityInput = assetRow.querySelector('.asset-quantity-input');
            if (quantityInput) {
                quantityInput.focus();
                quantityInput.select();
            }

            // Add keyboard event listeners
            inputs.forEach(input => {
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        window.saveAssetFields(assetSymbol);
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        window.cancelEditAssetFields(assetSymbol);
                    }
                });
            });

            // Update action buttons
            const actionsDiv = assetRow.querySelector('.asset-col-actions');
            actionsDiv.innerHTML = `
                <button class="asset-save-btn" onclick="window.saveAssetFields('${uniqueRowId}')">Save</button>
                <button class="asset-cancel-btn" onclick="window.cancelEditAssetFields('${uniqueRowId}')">Cancel</button>
            `;
        };

        window.cancelEditAssetFields = function(uniqueRowId) {
            console.log(`âŒ Cancelling edit for row ${uniqueRowId}`);
            const assetRow = document.querySelector(`[data-asset-id="${uniqueRowId}"]`);
            if (!assetRow) return;
            
            // Get the actual symbol from the data attribute
            const assetSymbol = assetRow.getAttribute('data-symbol');

            const displays = assetRow.querySelectorAll('.quantity-display, .risk-display, .location-display, .cointype-display');
            const inputs = assetRow.querySelectorAll('.asset-quantity-input, .asset-risk-input, .asset-location-input, .asset-cointype-input');
            
            // Restore original values
            inputs.forEach(input => {
                if (input.dataset.originalValue !== undefined) {
                    input.value = input.dataset.originalValue;
                }
            });

            // Show displays, hide inputs
            displays.forEach(display => display.style.display = 'block');
            inputs.forEach(input => input.style.display = 'none');

            // Restore action buttons
            const actionsDiv = assetRow.querySelector('.asset-col-actions');
            actionsDiv.innerHTML = `
                <button class="asset-edit-btn" onclick="window.editAssetFields('${uniqueRowId}')">Edit</button>
                <button class="asset-delete-btn" onclick="window.deleteAsset('${uniqueRowId}')">Delete</button>
            `;
        };

        window.saveAssetFields = async function(uniqueRowId) {
            console.log(`ðŸ’¾ Saving fields for row ${uniqueRowId}`);
            const assetRow = document.querySelector(`[data-asset-id="${uniqueRowId}"]`);
            if (!assetRow) return;
            
            // Get the actual symbol from the data attribute
            const assetSymbol = assetRow.getAttribute('data-symbol');

            const quantityInput = assetRow.querySelector('.asset-quantity-input');
            const riskInput = assetRow.querySelector('.asset-risk-input');
            const locationInput = assetRow.querySelector('.asset-location-input');
            const cointypeInput = assetRow.querySelector('.asset-cointype-input');
            const newQuantity = parseFloat(quantityInput.value) || 0;
            const newRisk = riskInput.value;
            const newLocation = locationInput.value;
            const newCoinType = cointypeInput.value;

            try {
                // Update in database
                const success = await window.updateAssetFieldsInDatabase(assetSymbol, {
                    quantity: newQuantity,
                    riskLevel: newRisk,
                    location: newLocation,
                    coinType: newCoinType
                });

                if (success) {
                    // Update displays
                    assetRow.querySelector('.quantity-display').textContent = newQuantity.toLocaleString();
                    assetRow.querySelector('.risk-display').textContent = newRisk;
                    assetRow.querySelector('.location-display').textContent = newLocation;
                    assetRow.querySelector('.cointype-display').textContent = newCoinType;

                    // Show displays, hide inputs
                    const displays = assetRow.querySelectorAll('.quantity-display, .risk-display, .location-display, .cointype-display');
                    const inputs = assetRow.querySelectorAll('.asset-quantity-input, .asset-risk-input, .asset-location-input, .asset-cointype-input');
                    
                    displays.forEach(display => display.style.display = 'block');
                    inputs.forEach(input => input.style.display = 'none');

                    // Restore action buttons
                    const actionsDiv = assetRow.querySelector('.asset-col-actions');
                    actionsDiv.innerHTML = `
                        <button class="asset-edit-btn" onclick="window.editAssetFields('${uniqueRowId}')">Edit</button>
                        <button class="asset-delete-btn" onclick="window.deleteAsset('${uniqueRowId}')">Delete</button>
                    `;

                    // Refresh portfolio to update totals
                    await window.loadPortfolioData();
                    
                } else {
                    alert('Failed to update asset. Please try again.');
                }
            } catch (error) {
                console.error('âŒ Error saving asset fields:', error);
                alert('Error updating asset. Please try again.');
            }
        };

        window.updateAssetFieldsInDatabase = async function(assetSymbol, fieldData) {
            try {
                const webhookUrl = CONFIG.GOOGLE_APPS_SCRIPT_URL;
                
                const urlWithParams = `${webhookUrl}?action=updateFields&symbol=${encodeURIComponent(assetSymbol.toUpperCase())}&quantity=${encodeURIComponent(fieldData.quantity)}&riskLevel=${encodeURIComponent(fieldData.riskLevel)}&location=${encodeURIComponent(fieldData.location)}&coinType=${encodeURIComponent(fieldData.coinType)}`;
                
                const response = await fetch(urlWithParams, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                return result.success;
                
            } catch (error) {
                console.error('âŒ Error updating asset fields in database:', error);
                return false;
            }
        };

        // Legacy function for backward compatibility
        window.editAssetQuantity = function(assetSymbol) {
            console.log(`âœï¸ Editing quantity for ${assetSymbol}`);
            const assetRow = document.querySelector(`[data-asset-id="${assetSymbol}"]`);
            if (!assetRow) return;

            const quantityDisplay = assetRow.querySelector('.quantity-display');
            const quantityInput = assetRow.querySelector('.asset-quantity-input');
            const actionsDiv = assetRow.querySelector('.asset-col-actions');

            // Hide display, show input
            quantityDisplay.style.display = 'none';
            quantityInput.style.display = 'block';
            quantityInput.focus();
            quantityInput.select();
            
            // Add Enter key support for saving and Escape key for canceling
            quantityInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    window.saveAssetQuantity(assetSymbol);
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    window.cancelEditAssetQuantity(assetSymbol);
                }
            });

            // Update action buttons
            actionsDiv.innerHTML = `
                <button class="asset-save-btn" onclick="window.saveAssetQuantity('${assetSymbol}')">Save</button>
                <button class="asset-cancel-btn" onclick="window.cancelEditAssetQuantity('${assetSymbol}')">Cancel</button>
            `;

            // Store original value for cancel
            quantityInput.dataset.originalValue = quantityInput.value;
        };

        window.cancelEditAssetQuantity = function(assetSymbol) {
            console.log(`âŒ Cancelling edit for ${assetSymbol}`);
            const assetRow = document.querySelector(`[data-asset-id="${assetSymbol}"]`);
            if (!assetRow) return;

            const quantityDisplay = assetRow.querySelector('.quantity-display');
            const quantityInput = assetRow.querySelector('.asset-quantity-input');
            const actionsDiv = assetRow.querySelector('.asset-col-actions');

            // Restore original value
            quantityInput.value = quantityInput.dataset.originalValue;

            // Hide input, show display
            quantityInput.style.display = 'none';
            quantityDisplay.style.display = 'block';

            // Restore edit button
            actionsDiv.innerHTML = `
                <button class="asset-edit-btn" onclick="window.editAssetQuantity('${assetSymbol}')">Edit</button>
            `;
        };

        window.saveAssetQuantity = async function(assetSymbol) {
            console.log(`ðŸ’¾ Saving asset quantity for: ${assetSymbol}`);
            
            const assetRow = document.querySelector(`[data-asset-id="${assetSymbol}"]`);
            if (!assetRow) {
                console.error(`âŒ Asset row not found for: ${assetSymbol}`);
                alert(`Asset not found: ${assetSymbol}`);
                return;
            }
            const quantityInput = assetRow.querySelector('.asset-quantity-input');
            if (!quantityInput) {
                console.error('âŒ Quantity input not found');
                alert('Quantity input not found');
                return;
            }
            console.log(`âœ… [DEBUG] Quantity input found, value: "${quantityInput.value}"`);

            const newQuantity = parseFloat(quantityInput.value);
            console.log(`ðŸ“Š [DEBUG] Parsed quantity: ${newQuantity}`);

            if (isNaN(newQuantity) || newQuantity <= 0) {
                console.error(`âŒ [DEBUG] Invalid quantity: ${newQuantity}`);
                alert(`Please enter a valid quantity greater than 0. Current: "${quantityInput.value}"`);
                return;
            }

            // Show loading state
            const saveBtn = assetRow.querySelector('.asset-save-btn');
            if (saveBtn) {
                saveBtn.textContent = 'Saving...';
                saveBtn.disabled = true;
            }

            try {
                console.log(`ðŸŒ [DEBUG] Calling updateAssetQuantityInDatabase...`);
                
                // Update the database
                const success = await window.updateAssetQuantityInDatabase(assetSymbol, newQuantity);
                
                console.log(`ðŸ“¡ [DEBUG] Database update result: ${success}`);
                
                if (success) {
                    console.log(`âœ… [DEBUG] Database update successful, refreshing portfolio...`);
                    // Refresh the portfolio to show updated values
                    await window.loadPortfolioData();
                    console.log('âœ… [DEBUG] Portfolio refresh complete');
                    
                    // Calculate new total portfolio value and save to history
                    const portfolioData = await window.fetchPortfolioData();
                    if (portfolioData && portfolioData.length > 0) {
                        let totalValue = 0;
                        for (const row of portfolioData) {
                            const quantity = parseFloat(row[3]) || 0;
                            const currentPrice = parseFloat(row[4]) || 0;
                            totalValue += quantity * currentPrice;
                        }
                        
                        console.log(`ðŸ“ˆ [DEBUG] Saving portfolio history: $${totalValue.toFixed(2)}`);
                        await window.savePortfolioHistory(totalValue.toFixed(2), `Updated ${assetSymbol} quantity to ${newQuantity.toLocaleString()}`);
                    }
                    
                    alert(`âœ… Successfully updated ${assetSymbol} to ${newQuantity.toLocaleString()}`);
                } else {
                    console.error(`âŒ [DEBUG] Database update failed`);
                    alert('âŒ Failed to update asset quantity. Check console for details.');
                    window.cancelEditAssetQuantity(assetSymbol);
                }
            } catch (error) {
                console.error('âŒ [DEBUG] Exception in saveAssetQuantity:', error);
                alert(`âŒ Error: ${error.message}`);
                window.cancelEditAssetQuantity(assetSymbol);
            } finally {
                // Reset button state
                if (saveBtn) {
                    saveBtn.textContent = 'Save';
                    saveBtn.disabled = false;
                }
                console.log(`ðŸ [DEBUG] ===== FINISHED SAVE ASSET QUANTITY =====`);
            }
        };

        window.updateAssetQuantityInDatabase = async function(assetSymbol, newQuantity) {
            try {
                console.log(`ðŸš€ [DEBUG] ===== STARTING DATABASE UPDATE =====`);
                console.log(`ðŸ”„ [DEBUG] Asset: ${assetSymbol}, New Quantity: ${newQuantity}`);
                
                // First, get current portfolio data to find the row
                console.log(`ðŸ“Š [DEBUG] Fetching current portfolio data...`);
                const portfolioData = await window.fetchPortfolioData();
                
                if (!portfolioData) {
                    console.error('âŒ [DEBUG] No portfolio data returned from fetchPortfolioData');
                    return false;
                }
                console.log(`âœ… [DEBUG] Portfolio data fetched, ${portfolioData.length} rows`);
                console.log(`ðŸ“‹ [DEBUG] Portfolio data:`, portfolioData);

                // Find the asset row
                console.log(`ðŸ” [DEBUG] Searching for asset ${assetSymbol}...`);
                let rowIndex = -1;
                let assetData = null;
                for (let i = 0; i < portfolioData.length; i++) {
                    const rowSymbol = portfolioData[i][1];
                    console.log(`ðŸ” [DEBUG] Row ${i}: Symbol "${rowSymbol}" vs "${assetSymbol}"`);
                    if (rowSymbol && rowSymbol.toLowerCase() === assetSymbol.toLowerCase()) {
                        rowIndex = i + 2; // +2 because of header row and 1-based indexing
                        assetData = portfolioData[i];
                        console.log(`âœ… [DEBUG] Found asset at row ${rowIndex}, data:`, assetData);
                        break;
                    }
                }

                if (rowIndex === -1 || !assetData) {
                    console.error(`âŒ [DEBUG] Asset ${assetSymbol} not found in portfolio data`);
                    return false;
                }

                // Calculate new total value
                const currentPrice = parseFloat(assetData[4]) || 0; // Column E: Current Price
                const newTotalValue = newQuantity * currentPrice;
                console.log(`ðŸ’° [DEBUG] Current Price: ${currentPrice}, New Total Value: ${newTotalValue}`);

                // Prepare update data
                const updateData = {
                    action: 'update',
                    symbol: assetSymbol,
                    quantity: newQuantity,
                    totalValue: newTotalValue
                };

                const webhookUrl = CONFIG.GOOGLE_APPS_SCRIPT_URL;
                
                console.log(`ðŸŒ [DEBUG] Sending POST request to: ${webhookUrl}`);
                console.log(`ðŸ“¦ [DEBUG] Update data:`, updateData);
                console.log(`ðŸ“¦ [DEBUG] JSON payload:`, JSON.stringify(updateData));
                
                // Use URL parameters - Google Apps Script handles these better
                const urlWithParams = `${webhookUrl}?action=${encodeURIComponent(updateData.action)}&symbol=${encodeURIComponent(updateData.symbol)}&quantity=${encodeURIComponent(updateData.quantity)}&totalValue=${encodeURIComponent(updateData.totalValue)}`;
                
                console.log(`ðŸ“¤ [DEBUG] Sending GET request with URL params: ${urlWithParams}`);
                
                const response = await fetch(urlWithParams, {
                    method: 'GET',
                    mode: 'cors'
                });

                console.log(`ðŸ“¡ [DEBUG] Response status: ${response.status}`);
                console.log(`ðŸ“¡ [DEBUG] Response ok: ${response.ok}`);
                console.log(`ðŸ“¡ [DEBUG] Response headers:`, [...response.headers.entries()]);

                if (response.ok) {
                    const responseText = await response.text();
                    console.log(`ðŸ“„ [DEBUG] Raw response text: "${responseText}"`);
                    
                    let result;
                    try {
                        result = JSON.parse(responseText);
                        console.log(`ðŸ“‹ [DEBUG] Parsed response:`, result);
                    } catch (parseError) {
                        console.error(`âŒ [DEBUG] Failed to parse response as JSON:`, parseError);
                        console.log(`âŒ [DEBUG] Raw response was: "${responseText}"`);
                        return false;
                    }
                    
                    if (result.success) {
                        console.log(`âœ… [DEBUG] Database update successful!`);
                        return true;
                    } else {
                        console.error(`âŒ [DEBUG] Database update failed:`, result.error || result.message);
                        return false;
                    }
                } else {
                    console.error(`âŒ [DEBUG] HTTP request failed: ${response.status} ${response.statusText}`);
                    const errorText = await response.text();
                    console.error(`âŒ [DEBUG] Error response body: "${errorText}"`);
                    return false;
                }
            } catch (error) {
                console.error('âŒ [DEBUG] Exception in updateAssetQuantityInDatabase:', error);
                console.error('âŒ [DEBUG] Error stack:', error.stack);
                return false;
            } finally {
                console.log(`ðŸ [DEBUG] ===== FINISHED DATABASE UPDATE =====`);
            }
        };

        // SIMPLE DEBUG: Basic test function
        window.simpleTest = function() {
            console.log('ðŸ§ª Simple test function works!');
            alert('âœ… JavaScript is working! Now try: window.testGoogleAppsScript()');
            return 'JavaScript is working!';
        };

        // DEBUG: Test function to isolate Google Apps Script issues
        window.testGoogleAppsScript = async function() {
            console.log(`ðŸ§ª [TEST] ===== TESTING GOOGLE APPS SCRIPT =====`);
            
            const webhookUrl = CONFIG.GOOGLE_APPS_SCRIPT_URL;
            
            // Test 1: Simple GET request
            console.log(`ðŸ§ª [TEST] Test 1: GET request to check if script is running...`);
            try {
                const getResponse = await fetch(webhookUrl, { method: 'GET' });
                console.log(`ðŸ“¡ [TEST] GET Response status: ${getResponse.status}`);
                const getResult = await getResponse.text();
                console.log(`ðŸ“„ [TEST] GET Response: "${getResult}"`);
            } catch (error) {
                console.error(`âŒ [TEST] GET request failed:`, error);
            }
            
            // Test 2: Simple POST with test data
            console.log(`ðŸ§ª [TEST] Test 2: POST request with test data...`);
            const testData = {
                action: 'update',
                symbol: 'AURA',
                quantity: 12345,
                totalValue: 123.45
            };
            
            try {
                const postResponse = await fetch(webhookUrl, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });
                
                console.log(`ðŸ“¡ [TEST] POST Response status: ${postResponse.status}`);
                console.log(`ðŸ“¡ [TEST] POST Response ok: ${postResponse.ok}`);
                
                const postResult = await postResponse.text();
                console.log(`ðŸ“„ [TEST] POST Response: "${postResult}"`);
                
                if (postResponse.ok) {
                    try {
                        const parsedResult = JSON.parse(postResult);
                        console.log(`ðŸ“‹ [TEST] Parsed POST result:`, parsedResult);
                        
                        if (parsedResult.success) {
                            console.log(`âœ… [TEST] Google Apps Script is working correctly!`);
                            alert(`âœ… TEST PASSED: Google Apps Script is working!`);
                        } else {
                            console.error(`âŒ [TEST] Google Apps Script returned error:`, parsedResult.error);
                            alert(`âŒ TEST FAILED: ${parsedResult.error}`);
                        }
                    } catch (parseError) {
                        console.error(`âŒ [TEST] Failed to parse POST response:`, parseError);
                        alert(`âŒ TEST FAILED: Invalid JSON response`);
                    }
                } else {
                    console.error(`âŒ [TEST] POST request failed with status ${postResponse.status}`);
                    alert(`âŒ TEST FAILED: HTTP ${postResponse.status}`);
                }
            } catch (error) {
                console.error(`âŒ [TEST] POST request failed:`, error);
                alert(`âŒ TEST FAILED: ${error.message}`);
            }
            
            console.log(`ðŸ [TEST] ===== FINISHED TESTING GOOGLE APPS SCRIPT =====`);
        };

        // Rate limiting system for CoinGecko API
        window.apiRateLimit = {
            requests: [],
            maxRequests: 5, // Very conservative - only 5 per minute
            timeWindow: 60000, // 1 minute in milliseconds
            
            canMakeRequest: function() {
                const now = Date.now();
                // Remove requests older than time window
                this.requests = this.requests.filter(time => now - time < this.timeWindow);
                return this.requests.length < this.maxRequests;
            },
            
            recordRequest: function() {
                this.requests.push(Date.now());
            },
            
            getWaitTime: function() {
                if (this.requests.length === 0) return 0;
                const oldestRequest = Math.min(...this.requests);
                const waitTime = this.timeWindow - (Date.now() - oldestRequest);
                return Math.max(0, waitTime);
            }
        };

        // Cache system for API responses
        window.priceCache = {
            data: new Map(),
            maxAge: 30000, // 30 seconds cache
            
            get: function(key) {
                const cached = this.data.get(key);
                if (!cached) return null;
                
                if (Date.now() - cached.timestamp > this.maxAge) {
                    this.data.delete(key);
                    return null;
                }
                return cached.data;
            },
            
            set: function(key, data) {
                this.data.set(key, {
                    data: data,
                    timestamp: Date.now()
                });
            }
        };

        // Fallback prices for common assets
        window.fallbackPrices = {
            'ethereum': 3500,
            'bitcoin': 45000,
            'solana': 100,
            'cardano': 0.5,
            'aura': 0.12,
            'eth': 3500,
            'btc': 45000,
            'sol': 100,
            'ada': 0.5
        };

        // Function to update value preview with rate limiting and caching
        window.updateValuePreview = async function(assetId) {
            const quantity = parseFloat(document.getElementById('assetQuantity').value) || 0;
            
            if (!assetId || quantity <= 0) {
                document.getElementById('valuePreview').innerHTML = '<div style="font-size: 1.5rem; font-weight: bold; color: #1976d2;">$0.00</div><div style="font-size: 0.9rem; color: #7f8c8d;">Enter quantity to see estimated value</div>';
                return;
            }
            
            // Check cache first
            const cacheKey = assetId;
            let cachedData = window.priceCache.get(cacheKey);
            
            if (cachedData) {
                console.log(`ðŸ’¾ Using cached price for ${assetId}`);
                const price = cachedData.usd;
                const change24h = cachedData.usd_24h_change || 0;
                const totalValue = price * quantity;
                
                const changeClass = change24h >= 0 ? 'positive' : 'negative';
                const changeSign = change24h >= 0 ? '+' : '';
                
                document.getElementById('valuePreview').innerHTML = `
                    <div style="font-size: 1.5rem; font-weight: bold; color: #1976d2;">$${totalValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    <div style="font-size: 0.9rem; color: #7f8c8d;">
                        $${price.toLocaleString()} per token
                        <span class="${changeClass}" style="margin-left: 10px;">${changeSign}${change24h.toFixed(2)}% (24h)</span>
                        <span style="margin-left: 8px; color: #28a745;">ðŸ“¦ cached</span>
                    </div>
                `;
                return;
            }
            
            // Check rate limit
            if (!window.apiRateLimit.canMakeRequest()) {
                const waitTime = Math.ceil(window.apiRateLimit.getWaitTime() / 1000);
                console.warn(`â±ï¸ Rate limit reached, using fallback price. Wait ${waitTime}s for API access.`);
                
                // Use fallback price
                const selectedAssetSymbol = document.getElementById('selectedAssetSymbol').value || assetId;
                const fallbackPrice = window.fallbackPrices[assetId.toLowerCase()] || window.fallbackPrices[selectedAssetSymbol.toLowerCase()] || 1;
                const totalValue = fallbackPrice * quantity;
                
                document.getElementById('valuePreview').innerHTML = `
                    <div style="font-size: 1.5rem; font-weight: bold; color: #f39c12;">$${totalValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    <div style="font-size: 0.9rem; color: #7f8c8d;">
                        ~$${fallbackPrice.toLocaleString()} per token (estimated)
                        <div style="font-size: 0.8rem; color: #e67e22; margin-top: 4px;">
                            â±ï¸ Rate limited - wait ${waitTime}s for live price
                        </div>
                    </div>
                `;
                return;
            }
            
            try {
                console.log(`ðŸ’° Fetching live price for ${assetId}... (${window.apiRateLimit.requests.length}/8 requests used)`);
                
                // Record the API request
                window.apiRateLimit.recordRequest();
                
                const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${assetId}&vs_currencies=usd&include_24hr_change=true`, {
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data[assetId]) {
                    // Cache the result
                    window.priceCache.set(cacheKey, data[assetId]);
                    
                    const price = data[assetId].usd;
                    const change24h = data[assetId].usd_24h_change || 0;
                    const totalValue = price * quantity;
                    
                    const changeClass = change24h >= 0 ? 'positive' : 'negative';
                    const changeSign = change24h >= 0 ? '+' : '';
                    
                    document.getElementById('valuePreview').innerHTML = `
                        <div style="font-size: 1.5rem; font-weight: bold; color: #1976d2;">$${totalValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div style="font-size: 0.9rem; color: #7f8c8d;">
                            $${price.toLocaleString()} per token
                            <span class="${changeClass}" style="margin-left: 10px;">${changeSign}${change24h.toFixed(2)}% (24h)</span>
                            <span style="margin-left: 8px; color: #28a745;">ðŸ”´ live</span>
                        </div>
                    `;
                } else {
                    throw new Error('No price data returned');
                }
            } catch (error) {
                console.warn('âš ï¸ API failed, using fallback price:', error.message);
                
                // Use fallback price
                const selectedAssetSymbol = document.getElementById('selectedAssetSymbol').value || assetId;
                const fallbackPrice = window.fallbackPrices[assetId.toLowerCase()] || window.fallbackPrices[selectedAssetSymbol.toLowerCase()] || 1;
                const totalValue = fallbackPrice * quantity;
                
                document.getElementById('valuePreview').innerHTML = `
                    <div style="font-size: 1.5rem; font-weight: bold; color: #f39c12;">$${totalValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    <div style="font-size: 0.9rem; color: #7f8c8d;">
                        ~$${fallbackPrice.toLocaleString()} per token (estimated)
                        <div style="font-size: 0.8rem; color: #e67e22; margin-top: 4px;">
                            âš ï¸ API unavailable - using estimated price
                        </div>
                    </div>
                `;
            }
        };

        // Set up event listeners when DOM is ready
        // Register Chart.js plugins globally
        if (typeof ChartDataLabels !== 'undefined') {
            Chart.register(ChartDataLabels);
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸŽ¯ Setting up inline event listeners...');
            
            // Manager portal card
            const managerCard = document.getElementById('managerPortalBtn');
            if (managerCard) {
                managerCard.addEventListener('click', window.enterManagerView);
                console.log('âœ… Manager card listener added');
            }
            
            // Manager portal button
            const managerButton = document.getElementById('managerPortalButton');
            if (managerButton) {
                managerButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    window.enterManagerView();
                });
                console.log('âœ… Manager button listener added');
            }
            
            // Investor portal button
            const investorButton = document.getElementById('investorPortalButton');
            if (investorButton) {
                investorButton.addEventListener('click', function() {
                    console.log('ðŸ‘¤ Opening investor login modal...');
                    document.getElementById('investorLoginModal').classList.add('active');
                });
                console.log('âœ… Investor button listener added');
            }

            // Tab navigation buttons
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('nav-btn')) {
                    const tabName = e.target.getAttribute('data-tab');
                    if (tabName) {
                        window.switchTab(tabName);
                    }
                }
            });

            // Set up investor modal close functionality
            const investorModal = document.getElementById('investorDetailsModal');
            const investorModalClose = investorModal?.querySelector('.close');
            
            if (investorModalClose) {
                investorModalClose.addEventListener('click', window.closeInvestorModal);
                console.log('âœ… Investor modal close button event listener added');
            }
            
            // Close modal when clicking outside of it
            if (investorModal) {
                investorModal.addEventListener('click', function(e) {
                    if (e.target === investorModal) {
                        window.closeInvestorModal();
                    }
                });
                console.log('âœ… Investor modal background click listener added');
            }

            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const investorModal = document.getElementById('investorDetailsModal');
                    if (investorModal && investorModal.classList.contains('active')) {
                        window.closeInvestorModal();
                    }
                    
                    const assetModal = document.getElementById('addAssetModal');
                    if (assetModal && assetModal.classList.contains('active')) {
                        window.closeAddAssetModal();
                    }
                }
            });

            // Set up asset search input event listener
            const assetSearchInput = document.getElementById('assetSearch');
            if (assetSearchInput) {
                let searchTimeout;
                assetSearchInput.addEventListener('input', function(e) {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        window.searchAssets(e.target.value);
                    }, 300); // Debounce search
                });
                
                // Hide dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('.search-container')) {
                        document.getElementById('assetDropdown').style.display = 'none';
                    }
                });
            }

            // Set up quantity input event listener for value preview with debouncing
            const quantityInput = document.getElementById('assetQuantity');
            if (quantityInput) {
                let priceUpdateTimeout;
                quantityInput.addEventListener('input', function() {
                    // Clear previous timeout
                    clearTimeout(priceUpdateTimeout);
                    
                    // Debounce the API call to avoid rapid requests
                    priceUpdateTimeout = setTimeout(() => {
                        const assetId = document.getElementById('selectedAssetId').value;
                        if (assetId) {
                            window.updateValuePreview(assetId);
                        }
                    }, 500); // Wait 500ms after user stops typing
                });
            }

            // Set up Add Asset modal close button
            const addAssetModalClose = document.querySelector('#addAssetModal .close');
            if (addAssetModalClose) {
                addAssetModalClose.addEventListener('click', window.closeAddAssetModal);
            }

            // Set up Add Asset form submission
            const addAssetForm = document.getElementById('addAssetForm');
            if (addAssetForm) {
                addAssetForm.addEventListener('submit', window.handleAddAsset);
            }
            
            console.log('âœ… All event listeners set up');
            
            // DEBUG: Test if JavaScript is working
            console.log('ðŸ§ª [DEBUG] JavaScript is loading...');
            console.log('ðŸ§ª [DEBUG] window.testGoogleAppsScript available:', typeof window.testGoogleAppsScript);
            
            // Restore app state on page refresh
            window.restoreAppState();
            
            // Force initial data load for Dashboard tab
            setTimeout(() => {
                console.log('ðŸ”„ Force loading data for Dashboard tab...');
                window.loadInvestorsData();
            }, 1000);
        });

        // ========================================
        // SMART TIMESTAMP SYSTEM
        // ========================================
        
        /**
         * Smart Timestamp System
         * 
         * This system manages the display of "Last updated" timestamps across all
         * portfolio overview widgets. It fetches the actual database timestamp
         * from Google Apps Script and formats it for display.
         * 
         * Features:
         * - Fetches real database timestamps (not page refresh time)
         * - Displays in Toronto timezone
         * - Updates every minute automatically
         * - Handles errors gracefully with user-friendly messages
         * - Works across all tabs (Dashboard, Investors, Portfolio)
         * 
         * Dependencies:
         * - Google Apps Script with getLastPriceUpdate action
         * - "Last Update" sheet in Google Sheets with timestamp in cell A2
         * 
         * @namespace window.lastUpdatedSystem
         */
        window.lastUpdatedSystem = {
            
            /**
             * Format timestamp for display
             * 
             * Converts ISO timestamp to user-friendly format:
             * - "2:06 AM | Today" for today's timestamps
             * - "2:06 AM | Jan 15" for other dates
             * 
             * @param {string} timestamp - ISO timestamp string
             * @returns {string} Formatted timestamp string
             */
            formatTimestamp: function(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                
                // Check if it's today
                const isToday = date.toDateString() === now.toDateString();
                
                // Format time (e.g., "2:06 AM")
                const timeStr = date.toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
                
                // Format date
                const dateStr = isToday ? 'Today' : date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric'
                });
                
                return `${timeStr} | ${dateStr}`;
            },
            
            /**
             * Update timestamp display with real database time
             * 
             * Fetches the latest timestamp from Google Apps Script and updates
             * all timestamp displays across the application. Handles errors
             * gracefully with user-friendly messages.
             * 
             * @async
             * @returns {Promise<void>}
             */
            updateTimestamp: async function() {
                try {
                    console.log('ðŸ” Fetching last updated time from database...');
                    
                    const response = await fetch(`${CONFIG.GOOGLE_APPS_SCRIPT_URL}?action=${CONFIG.API_ENDPOINTS.GET_LAST_UPDATE}`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        console.log('ðŸ” API Response:', data);
                        
                        // Handle both possible response formats from Google Apps Script
                        const timestamp = data.timestamp || data.lastPriceUpdate;
                        
                        if (data.success && timestamp) {
                            const formattedTime = this.formatTimestamp(timestamp);
                            
                            // Update all timestamp displays
                            const timestampElements = [
                                'dashboardLastUpdated',
                                'investorsLastUpdated', 
                                'portfolioLastUpdated',
                            ];
                            
                            timestampElements.forEach(elementId => {
                                const element = document.getElementById(elementId);
                                if (element) {
                                    element.textContent = `Last updated: ${formattedTime}`;
                                }
                            });
                            
                            console.log(`âœ… Timestamp updated: ${formattedTime}`);
                        } else {
                            // Show user-friendly message when no data is available
                            this.updateAllTimestamps('No data available');
                            console.log('âš ï¸ No timestamp data found');
                        }
                    } else {
                        console.log('âš ï¸ Could not fetch timestamp data');
                    }
                    
                } catch (error) {
                    console.error('âŒ Error fetching timestamp:', error);
                    // Show user-friendly message when there's a connection error
                    this.updateAllTimestamps('Connection error');
                }
            },
            
            /**
             * Update all timestamp displays with a message
             * 
             * Helper function to update all timestamp elements across the application
             * with a consistent message. Used for error states and loading states.
             * 
             * @param {string} message - Message to display in all timestamp elements
             */
            updateAllTimestamps: function(message) {
                const timestampElements = [
                    'dashboardLastUpdated',
                    'investorsLastUpdated', 
                    'portfolioLastUpdated',
                ];
                
                timestampElements.forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.textContent = `Last updated: ${message}`;
                    }
                });
            },
            
            /**
             * Initialize the timestamp system
             * 
             * Sets up the timestamp system by:
             * - Fetching the initial timestamp
             * - Setting up automatic updates every minute
             * - Logging initialization status
             */
            init: function() {
                console.log('ðŸš€ Initializing last updated timestamp system...');
                
                // Fetch real timestamp immediately
                this.updateTimestamp();
                
                // Update every minute
                setInterval(() => {
                    this.updateTimestamp();
                }, CONFIG.TIMESTAMP_UPDATE_INTERVAL);
                
                console.log('âœ… Last updated timestamp system initialized');
            }
        };

        // ========================================
        // DYNAMIC PERFORMANCE METRICS SYSTEM
        // ========================================
        
        /**
         * Dynamic Performance Metrics Calculator
         * 
         * This system calculates real-time performance metrics from portfolio data
         * instead of using hardcoded values. It provides accurate, up-to-date
         * performance information for the investment manager dashboard.
         * 
         * Features:
         * - Real-time Total AUM calculation
         * - Dynamic Total Return calculation
         * - Live Active Investor count
         * - Month-on-Month performance tracking
         * - Individual investor performance metrics
         * 
         * @namespace window.performanceCalculator
         */
        window.performanceCalculator = {
            
            // Cache DOM elements for better performance
            _cachedElements: {
                portfolioRows: null,
                investorRows: null,
                totalInvestedElement: null
            },
            
            /**
             * Get cached DOM elements to avoid repeated queries
             */
            _getCachedElements: function() {
                if (!this._cachedElements.portfolioRows) {
                    this._cachedElements.portfolioRows = document.querySelectorAll('#portfolioTableBody tr');
                }
                if (!this._cachedElements.investorRows) {
                    this._cachedElements.investorRows = document.querySelectorAll('#investorsTableBody tr');
                }
                if (!this._cachedElements.totalInvestedElement) {
                    this._cachedElements.totalInvestedElement = document.getElementById('summaryTotalInvested');
                }
                return this._cachedElements;
            },
            
            /**
             * Clear cache when data changes
             */
            _clearCache: function() {
                this._cachedElements.portfolioRows = null;
                this._cachedElements.investorRows = null;
                this._cachedElements.totalInvestedElement = null;
            },
            
            /**
             * Calculate Total Assets Under Management (AUM)
             * 
             * Sums up all current portfolio values to get the total AUM.
             * This replaces the hardcoded $0.00 value in the manager header.
             * 
             * @returns {number} Total AUM in USD
             */
            calculateTotalAUM: function() {
                try {
                    console.log('ðŸ’° Calculating Total AUM...');
                    
                    // Get cached portfolio data
                    const { portfolioRows } = this._getCachedElements();
                    let totalAUM = 0;
                    
                    portfolioRows.forEach(row => {
                        const valueCell = row.querySelector('td:nth-child(6)'); // Column F: Total Value
                        if (valueCell) {
                            const valueText = valueCell.textContent.replace(/[$,]/g, '');
                            const value = parseFloat(valueText);
                            if (!isNaN(value)) {
                                totalAUM += value;
                            }
                        }
                    });
                    
                    // If no portfolio rows found in DOM, try to get from Google Sheets data
                    if (totalAUM === 0) {
                        console.log('ðŸ“Š No portfolio rows found in DOM, checking for live data...');
                        // Check if we have live portfolio data from Google Sheets
                        if (window.portfolioData && Array.isArray(window.portfolioData)) {
                            totalAUM = window.portfolioData.reduce((sum, asset) => {
                                const value = parseFloat(asset.currentValue || asset.totalValue || 0);
                                return sum + (isNaN(value) ? 0 : value);
                            }, 0);
                            console.log(`ðŸ“Š Using live portfolio data: $${totalAUM.toLocaleString()}`);
                        }
                    }
                    
                    console.log(`âœ… Total AUM calculated: $${totalAUM.toLocaleString()}`);
                    return totalAUM;
                    
                } catch (error) {
                    console.error('âŒ Error calculating Total AUM:', error);
                    return 0;
                }
            },
            
            /**
             * Calculate Total Return Percentage
             * 
             * Calculates the overall portfolio return by comparing current value
             * to total invested amount. This replaces the hardcoded 0.00%.
             * 
             * @returns {number} Total return percentage
             */
            calculateTotalReturn: function() {
                try {
                    console.log('ðŸ“ˆ Calculating Total Return...');
                    
                    const currentValue = this.calculateTotalAUM();
                    
                    // Get total invested from portfolio overview (cached)
                    const { totalInvestedElement } = this._getCachedElements();
                    let totalInvested = 0;
                    
                    if (totalInvestedElement) {
                        const investedText = totalInvestedElement.textContent.replace(/[$,]/g, '');
                        totalInvested = parseFloat(investedText) || 0;
                    }
                    
                    // If no total invested found in DOM, try to get from Google Sheets data
                    if (totalInvested === 0) {
                        console.log('ðŸ“Š No total invested found in DOM, checking for live data...');
                        // Check if we have live investor data from Google Sheets
                        if (window.investorData && Array.isArray(window.investorData)) {
                            totalInvested = window.investorData.reduce((sum, investor) => {
                                const value = parseFloat(investor.investmentValue || investor.investment || 0);
                                return sum + (isNaN(value) ? 0 : value);
                            }, 0);
                            console.log(`ðŸ“Š Using live investor data: $${totalInvested.toLocaleString()}`);
                        }
                    }
                    
                    if (totalInvested === 0) {
                        console.log('âš ï¸ No invested amount found, returning 0%');
                        return 0;
                    }
                    
                    const totalReturn = ((currentValue - totalInvested) / totalInvested) * 100;
                    console.log(`âœ… Total Return calculated: ${totalReturn.toFixed(2)}%`);
                    return totalReturn;
                    
                } catch (error) {
                    console.error('âŒ Error calculating Total Return:', error);
                    return 0;
                }
            },
            
            /**
             * Calculate Active Investor Count
             * 
             * Counts the number of unique investors in the database.
             * This replaces the hardcoded 0 value in the manager header.
             * 
             * @returns {number} Number of active investors
             */
            calculateInvestorCount: function() {
                try {
                    console.log('ðŸ‘¥ Calculating Active Investor Count...');
                    
                    // Get investor data from the investors table (cached)
                    const { investorRows } = this._getCachedElements();
                    const uniqueInvestors = new Set();
                    
                    investorRows.forEach(row => {
                        const nameCell = row.querySelector('td:nth-child(1)'); // Column A: Name
                        if (nameCell) {
                            const investorName = nameCell.textContent.trim();
                            if (investorName) {
                                uniqueInvestors.add(investorName);
                            }
                        }
                    });
                    
                    let count = uniqueInvestors.size;
                    
                    // If no investor rows found in DOM, try to get from Google Sheets data
                    if (count === 0) {
                        console.log('ðŸ“Š No investor rows found in DOM, checking for live data...');
                        // Check if we have live investor data from Google Sheets
                        if (window.investorData && Array.isArray(window.investorData)) {
                            count = window.investorData.length;
                            console.log(`ðŸ“Š Using live investor data: ${count} investors`);
                        }
                    }
                    
                    console.log(`âœ… Active Investor Count calculated: ${count}`);
                    return count;
                    
                } catch (error) {
                    console.error('âŒ Error calculating Investor Count:', error);
                    return 0;
                }
            },
            
            /**
             * Calculate Month-on-Month Return
             * 
             * Calculates the month-over-month performance change.
             * For now, uses a placeholder calculation until historical data is available.
             * 
             * @returns {number} Month-on-month return percentage
             */
            calculateMonthlyReturn: function() {
                try {
                    console.log('ðŸ“Š Calculating Month-on-Month Return...');
                    
                    // TODO: Implement real month-over-month calculation when historical data is available
                    // For now, use a placeholder calculation based on recent performance
                    const totalReturn = this.calculateTotalReturn();
                    
                    // Estimate monthly return as a fraction of total return
                    // This is a placeholder - real implementation would compare to previous month
                    const monthlyReturn = totalReturn * 0.1; // Rough estimate
                    
                    console.log(`âœ… Month-on-Month Return calculated: ${monthlyReturn.toFixed(1)}%`);
                    return monthlyReturn;
                    
                } catch (error) {
                    console.error('âŒ Error calculating Monthly Return:', error);
                    return 0;
                }
            },
            
            /**
             * Update all performance metrics in the UI
             * 
             * Updates the manager header and portfolio overview widgets
             * with the latest calculated performance metrics.
             */
            updateAllMetrics: function() {
                try {
                    console.log('ðŸ”„ Updating all performance metrics from live database...');
                    
                    // Get live metrics from the actual database tables
                    const liveMetrics = this.updatePortfolioOverviewFromLiveDatabase();
                    
                    // Update portfolio overview widgets with live data
                    this.updatePortfolioOverview(liveMetrics.monthlyReturn);
                    
                    console.log('âœ… All performance metrics updated from live database');
                    console.log(`ðŸ“Š Live database metrics: ${liveMetrics.totalInvestors} investors, $${liveMetrics.totalInvested.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} invested, $${liveMetrics.totalCurrentValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} current`);
                    
                } catch (error) {
                    console.error('âŒ Error updating performance metrics:', error);
                }
            },
            
            // updateManagerHeader function removed - header stats no longer needed
            
            /**
             * Update portfolio overview metrics
             * 
             * @param {number} monthlyReturn - Month-on-month return percentage
             */
            updatePortfolioOverview: function(monthlyReturn) {
                try {
                    console.log('ðŸ”„ Updating Portfolio Overview with live database data...');
                    
                    // Get live metrics from the actual database tables
                    const liveMetrics = this.updatePortfolioOverviewFromLiveDatabase();
                    
                    // Update Total Investors in all portfolio overview widgets
                    const investorElements = document.querySelectorAll('#summaryTotalInvestors, #investorsSummaryTotalInvestors, #portfolioSummaryTotalInvestors');
                    investorElements.forEach(element => {
                        element.textContent = liveMetrics.totalInvestors.toString();
                    });
                    
                    // Update Total Invested in all portfolio overview widgets (2 decimal places)
                    const investedElements = document.querySelectorAll('#summaryTotalInvested, #investorsSummaryTotalInvested, #portfolioSummaryTotalInvested');
                    investedElements.forEach(element => {
                        element.textContent = `$${liveMetrics.totalInvested.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    });
                    
                    // Update Current Value in all portfolio overview widgets (2 decimal places)
                    const currentValueElements = document.querySelectorAll('#summaryCurrentValue, #investorsSummaryCurrentValue, #portfolioSummaryCurrentValue');
                    currentValueElements.forEach(element => {
                        element.textContent = `$${liveMetrics.totalCurrentValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    });
                    
                    // Update Total P&L in all portfolio overview widgets (2 decimal places with conditional formatting)
                    const pnlElements = document.querySelectorAll('#summaryTotalPnL, #investorsSummaryTotalPnL, #portfolioSummaryTotalPnL');
                    pnlElements.forEach(element => {
                        const sign = liveMetrics.totalPnL >= 0 ? '+' : '';
                        element.textContent = `${sign}$${Math.abs(liveMetrics.totalPnL).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                        element.className = liveMetrics.totalPnL >= 0 ? 'metric-value positive' : 'metric-value negative';
                        element.style.color = liveMetrics.totalPnL >= 0 ? 'var(--text-success)' : 'var(--text-danger)';
                    });
                    
                    // Update Month-on-Month return in all portfolio overview widgets (1 decimal place with conditional formatting)
                    const monthlyElements = document.querySelectorAll('#summaryMonthlyReturn, #investorsSummaryMonthlyReturn, #portfolioSummaryMonthlyReturn');
                    monthlyElements.forEach(element => {
                        const sign = liveMetrics.monthlyReturn >= 0 ? '+' : '';
                        element.textContent = `${sign}${liveMetrics.monthlyReturn.toFixed(1)}%`;
                        element.className = `metric-value ${liveMetrics.monthlyReturn >= 0 ? 'positive' : 'negative'}`;
                        element.style.color = liveMetrics.monthlyReturn >= 0 ? 'var(--text-success)' : 'var(--text-danger)';
                    });
                    
                    console.log('âœ… Portfolio overview metrics updated with live database data');
                    console.log(`ðŸ“Š Live metrics: ${liveMetrics.totalInvestors} investors, $${liveMetrics.totalInvested.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} invested, $${liveMetrics.totalCurrentValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} current, ${liveMetrics.totalReturn.toFixed(1)}% return`);
                    
                } catch (error) {
                    console.error('âŒ Error updating portfolio overview:', error);
                }
            },
            
            /**
             * Update Portfolio Overview from Live Database
             * 
             * This function directly counts and calculates from the actual database tables
             * to ensure all Portfolio Overview metrics use real live data.
             * 
             * @returns {Object} Live database metrics
             */
            updatePortfolioOverviewFromLiveDatabase: function() {
                try {
                    console.log('ðŸ”„ Updating Portfolio Overview from displayed investor table...');
                    
                    let totalInvestors = 0;
                    let totalInvested = 0;
                    let totalCurrentValue = 0;
                    
                    // Count unique investors from the actual displayed table
                    const investorsTableBody = document.getElementById('investorsTableBody');
                    if (investorsTableBody) {
                        const investorRows = investorsTableBody.querySelectorAll('tr');
                        totalInvestors = investorRows.length;
                        
                        console.log(`ðŸ“Š Found ${totalInvestors} investor rows in displayed table`);
                        
                        // Sum actual investment and current values from the displayed table
                        investorRows.forEach((row, index) => {
                            const nameCell = row.querySelector('td:nth-child(2)'); // Name column
                            const investmentCell = row.querySelector('td:nth-child(4)'); // Investment Value column
                            const currentValueCell = row.querySelector('td:nth-child(5)'); // Current Value column
                            
                            const investorName = nameCell ? nameCell.textContent.trim() : `Investor ${index + 1}`;
                            
                            if (investmentCell) {
                                const investmentText = investmentCell.textContent.replace(/[$,]/g, '');
                                const investment = parseFloat(investmentText) || 0;
                                totalInvested += investment;
                                console.log(`   ${investorName}: Investment = $${investment}`);
                            }
                            
                            if (currentValueCell) {
                                const currentText = currentValueCell.textContent.replace(/[$,]/g, '');
                                const current = parseFloat(currentText) || 0;
                                totalCurrentValue += current;
                                console.log(`   ${investorName}: Current Value = $${current}`);
                            }
                        });
                    } else {
                        console.warn('âš ï¸ Investor table not found in DOM');
                    }
                    
                    // Calculate derived metrics
                    const totalPnL = totalCurrentValue - totalInvested;
                    const totalReturn = totalInvested > 0 ? ((totalCurrentValue - totalInvested) / totalInvested) * 100 : 0;
                    const monthlyReturn = 2.8; // TODO: Calculate from historical data
                    
                    const liveMetrics = {
                        totalInvestors,
                        totalInvested,
                        totalCurrentValue,
                        totalPnL,
                        totalReturn,
                        monthlyReturn
                    };
                    
                    console.log('âœ… Portfolio Overview metrics calculated from displayed table');
                    console.log(`ðŸ“Š Final metrics: ${totalInvestors} investors, $${totalInvested.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} invested, $${totalCurrentValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} current, ${totalReturn.toFixed(1)}% return`);
                    return liveMetrics;
                    
                } catch (error) {
                    console.error('âŒ Error calculating live database metrics:', error);
                    return {
                        totalInvestors: 0,
                        totalInvested: 0,
                        totalCurrentValue: 0,
                        totalPnL: 0,
                        totalReturn: 0,
                        monthlyReturn: 0
                    };
                }
            },
            
            /**
             * Initialize the performance calculator system
             * 
             * Sets up the system and performs initial calculations.
             */
            init: function() {
                console.log('ðŸš€ Initializing Dynamic Performance Metrics System...');
                
                // Wait for portfolio data to load, then update metrics
                setTimeout(() => {
                    this.updateAllMetrics();
                }, 3000); // Increased delay to ensure data is fully loaded
                
                console.log('âœ… Dynamic Performance Metrics System initialized');
            }
        };

        // ========================================
        // LIVE DATABASE INTEGRATION
        // ========================================
        
        /**
         * Refresh Portfolio Overview with Live Database Data
         * 
         * This function can be called manually to refresh the Portfolio Overview
         * widget with the latest data from the actual database tables.
         * 
         * Usage: window.refreshPortfolioOverviewFromDatabase()
         */
        window.refreshPortfolioOverviewFromDatabase = function() {
            console.log('ðŸ”„ Manually refreshing Portfolio Overview from live database...');
            
            if (window.performanceCalculator) {
                window.performanceCalculator.updateAllMetrics();
                console.log('âœ… Portfolio Overview refreshed with live database data');
            } else {
                console.error('âŒ Performance calculator not available');
            }
        };
        
        /**
         * Test Live Database Integration
         * 
         * This function tests the live database integration by showing
         * what data is being pulled from the actual database tables.
         * 
         * Usage: window.testLiveDatabaseIntegration()
         */
        window.testLiveDatabaseIntegration = function() {
            console.log('ðŸ§ª Testing Portfolio Overview from Displayed Table...');
            
            // Check the displayed investor table
            const investorsTableBody = document.getElementById('investorsTableBody');
            if (investorsTableBody) {
                const rows = investorsTableBody.querySelectorAll('tr');
                console.log(`ðŸ“Š Found ${rows.length} investors in displayed table:`);
                rows.forEach((row, index) => {
                    const nameCell = row.querySelector('td:nth-child(2)');
                    const investmentCell = row.querySelector('td:nth-child(4)');
                    const currentCell = row.querySelector('td:nth-child(5)');
                    const name = nameCell ? nameCell.textContent.trim() : `Investor ${index + 1}`;
                    const investment = investmentCell ? investmentCell.textContent : 'N/A';
                    const current = currentCell ? currentCell.textContent : 'N/A';
                    console.log(`   ${index + 1}. ${name}: ${investment} â†’ ${current}`);
                });
            } else {
                console.log('âŒ Investor table not found in DOM');
                return null;
            }
            
            if (window.performanceCalculator) {
                const liveMetrics = window.performanceCalculator.updatePortfolioOverviewFromLiveDatabase();
                
                console.log('ðŸ“Š Portfolio Overview Metrics (from displayed table):');
                console.log(`   ðŸ‘¥ Total Investors: ${liveMetrics.totalInvestors}`);
                console.log(`   ðŸ’° Total Invested: $${liveMetrics.totalInvested.toLocaleString()}`);
                console.log(`   ðŸ’Ž Current Value: $${liveMetrics.totalCurrentValue.toLocaleString()}`);
                console.log(`   ðŸ“ˆ Total P&L: $${liveMetrics.totalPnL.toLocaleString()}`);
                console.log(`   ðŸ“Š Total Return: ${liveMetrics.totalReturn.toFixed(2)}%`);
                console.log(`   ðŸ“… Month-on-Month: ${liveMetrics.monthlyReturn.toFixed(1)}%`);
                
                // Show in alert for easy verification
                alert(`Portfolio Overview Metrics:\n\n` +
                      `ðŸ‘¥ Total Investors: ${liveMetrics.totalInvestors}\n` +
                      `ðŸ’° Total Invested: $${liveMetrics.totalInvested.toLocaleString()}\n` +
                      `ðŸ’Ž Current Value: $${liveMetrics.totalCurrentValue.toLocaleString()}\n` +
                      `ðŸ“ˆ Total P&L: $${liveMetrics.totalPnL.toLocaleString()}\n` +
                      `ðŸ“Š Total Return: ${liveMetrics.totalReturn.toFixed(2)}%\n` +
                      `ðŸ“… Month-on-Month: ${liveMetrics.monthlyReturn.toFixed(1)}%`);
                
                return liveMetrics;
            } else {
                console.error('âŒ Performance calculator not available');
                return null;
            }
        };
        
        /**
         * Debug Google Sheets Structure
         * 
         * This function helps debug what sheets are available in your Google Sheets
         * and what data they contain. Use this to identify the correct sheet name.
         * 
         * Usage: window.debugGoogleSheets()
         */
        window.debugGoogleSheets = async function() {
            console.log('ðŸ” Debugging Google Sheets structure...');
            
            if (window.app) {
                await window.app.debugGoogleSheets();
            } else {
                console.error('âŒ App not available');
            }
        };
        
        /**
         * Force refresh data from Google Sheets
         * 
         * This function forces the app to reload data from Google Sheets
         * and update the UI with the correct data.
         * 
         * Usage: window.forceRefreshFromGoogleSheets()
         */
        window.forceRefreshFromGoogleSheets = async function() {
            console.log('ðŸ”„ Force refreshing data from Google Sheets...');
            
            try {
                // Fetch fresh data from Google Sheets
                const liveInvestorData = await window.fetchLiveInvestorData();
                
                if (liveInvestorData && liveInvestorData.length > 0) {
                    console.log(`âœ… Loaded ${liveInvestorData.length} investors from Google Sheets`);
                    console.log('ðŸ“Š Sample investor data:', liveInvestorData[0]);
                    
                    // Update the investor table
                    await window.displayLiveInvestorsTable(liveInvestorData);
                    
                    // Update Portfolio Overview
                    if (window.performanceCalculator) {
                        window.performanceCalculator.updateAllMetrics();
                    }
                    
                    console.log('âœ… UI updated with fresh Google Sheets data');
                } else {
                    console.warn('âš ï¸ No investor data loaded from Google Sheets');
                }
                
            } catch (error) {
                console.error('âŒ Error refreshing from Google Sheets:', error);
            }
        };
        
        /**
         * Test Google Sheets Data Loading
         * 
         * This function tests if Google Sheets data is being loaded correctly
         * and shows what data is available.
         * 
         * Usage: window.testGoogleSheetsData()
         */
        window.testGoogleSheetsData = async function() {
            console.log('ðŸ§ª Testing Google Sheets Data Loading...');
            
            try {
                const liveInvestorData = await window.fetchLiveInvestorData();
                
                if (liveInvestorData && liveInvestorData.length > 0) {
                    console.log(`ðŸ“Š Found ${liveInvestorData.length} investors in Google Sheets:`);
                    liveInvestorData.forEach((row, index) => {
                        const investment = parseFloat(row[4]?.replace(/[$,]/g, '')) || 0;
                        const current = parseFloat(row[5]?.replace(/[$,]/g, '')) || 0;
                        const share = parseFloat(row[6]?.replace('%', '')) || 0;
                        const returnPct = parseFloat(row[7]?.replace('%', '')) || 0;
                        
                        console.log(`   ${index + 1}. ${row[0]} (${row[1]}):`);
                        console.log(`      Join Date: ${row[3]}`);
                        console.log(`      Investment: $${investment.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`);
                        console.log(`      Current: $${current.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`);
                        console.log(`      Share: ${share.toFixed(1)}%`);
                        console.log(`      Return: ${returnPct.toFixed(1)}%`);
                    });
                    
                    // Show in alert for easy verification
                    const sampleInvestor = liveInvestorData[0];
                    if (sampleInvestor) {
                        const investment = parseFloat(sampleInvestor[4]?.replace(/[$,]/g, '')) || 0;
                        const current = parseFloat(sampleInvestor[5]?.replace(/[$,]/g, '')) || 0;
                        const share = parseFloat(sampleInvestor[6]?.replace('%', '')) || 0;
                        const returnPct = parseFloat(sampleInvestor[7]?.replace('%', '')) || 0;
                        
                        alert(`Google Sheets Data Test:\n\n` +
                              `Found ${liveInvestorData.length} investors\n\n` +
                              `Sample Investor (${sampleInvestor[0]}):\n` +
                              `Name: ${sampleInvestor[1]}\n` +
                              `Join Date: ${sampleInvestor[3]}\n` +
                              `Investment: $${investment.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}\n` +
                              `Current: $${current.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}\n` +
                              `Share: ${share.toFixed(1)}%\n` +
                              `Return: ${returnPct.toFixed(1)}%`);
                    }
                    
                    return liveInvestorData;
                } else {
                    console.error('âŒ No Google Sheets data found');
                    alert('âŒ No Google Sheets data found');
                    return null;
                }
            } catch (error) {
                console.error('âŒ Error testing Google Sheets data:', error);
                alert('âŒ Error testing Google Sheets data: ' + error.message);
                return null;
            }
        };
        
        // ========================================
        // PORTFOLIO REFRESH SYSTEM
        // ========================================
        
        /**
         * Manual Portfolio Data Refresh
         * 
         * Handles manual refresh of portfolio data triggered by user actions.
         * This function:
         * - Updates all refresh buttons to show loading state
         * - Calls Google Apps Script to refresh prices
         * - Updates the UI with new data
         * - Handles errors gracefully
         * - Restores button states after completion
         * 
         * @async
         * @returns {Promise<void>}
         */
        window.refreshPortfolioData = async function() {
            console.log('ðŸ”„ Manual portfolio refresh triggered by user');
            
            try {
                // Show loading state for KPI ribbon
                const kpiLastUpdated = document.getElementById('kpiLastUpdated');
                if (kpiLastUpdated) {
                    kpiLastUpdated.textContent = 'Refreshing...';
                    kpiLastUpdated.style.color = '#00ff88';
                    kpiLastUpdated.style.fontWeight = '600';
                }
                
                // Show loading state for all refresh buttons (only those with text content)
                const refreshButtons = document.querySelectorAll('button[onclick="window.refreshPortfolioData()"]');
                refreshButtons.forEach(button => {
                    // Only set text content if the button has text content (not just SVG icons)
                    if (button.textContent.trim() !== '') {
                    const originalText = button.textContent;
                    button.textContent = 'Refreshing...';
                    button.disabled = true;
                    } else {
                        // For buttons with only SVG icons, just disable them
                        button.disabled = true;
                    }
                });
                
                // Call your Google Apps Script to refresh prices
                console.log('ðŸ“¡ Calling Google Apps Script for price refresh...');
                
                const response = await fetch(`${CONFIG.GOOGLE_APPS_SCRIPT_URL}?action=${CONFIG.API_ENDPOINTS.REFRESH_PRICES}`);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('âœ… Price refresh result:', result);
                    
                    if (result.success) {
                        console.log('âœ… Prices refreshed successfully, updating UI...');
                        
                        // Show success message
                        const refreshButton = document.querySelector('.portfolio-btn');
                        if (refreshButton) {
                            refreshButton.textContent = 'âœ… Refreshed!';
                        }
                        
                                                    // Update performance metrics after successful refresh
                            if (window.performanceCalculator) {
                                // Clear cache since data has changed
                                window.performanceCalculator._clearCache();
                                setTimeout(() => {
                                    // Refresh Portfolio Overview with live database data
                                    window.performanceCalculator.updateAllMetrics();
                                    console.log('âœ… Portfolio Overview updated with fresh database data');
                                }, 1000); // Give time for portfolio data to update
                            }
                        
                        // Wait a moment for Google Sheets to update, then refresh the page
                        setTimeout(() => {
                            window.location.reload();
                        }, CONFIG.REFRESH_BUTTON_DELAY);
                    } else {
                        console.error('âŒ Price refresh failed:', result.error);
                        alert('Price refresh failed: ' + (result.error || 'Unknown error'));
                    }
                } else {
                    console.error('âŒ Failed to call Google Apps Script:', response.status);
                    alert('Failed to refresh prices. Please try again.');
                }
                
            } catch (error) {
                console.error('âŒ Error refreshing prices:', error);
                alert('Error refreshing prices: ' + error.message);
            } finally {
                // Restore KPI ribbon text with database timestamp
                const kpiLastUpdated = document.getElementById('kpiLastUpdated');
                if (kpiLastUpdated) {
                    try {
                        const dbTimestamp = await window.fetchLastUpdateTimestamp();
                        if (dbTimestamp) {
                            // Parse the ISO timestamp and format it for display
                            const dbDate = new Date(dbTimestamp);
                            const timeString = dbDate.toLocaleTimeString('en-US', { 
                                hour: 'numeric', 
                                minute: '2-digit',
                                hour12: true 
                            });
                            kpiLastUpdated.textContent = `Last updated: ${timeString}`;
                            console.log('âœ… Updated last updated time from database after refresh:', timeString);
                        } else {
                            // Fallback to browser time if database timestamp is not available
                            const now = new Date();
                            const timeString = now.toLocaleTimeString('en-US', { 
                                hour: 'numeric', 
                                minute: '2-digit',
                                hour12: true 
                            });
                            kpiLastUpdated.textContent = `Last updated: ${timeString}`;
                        }
                    } catch (error) {
                        console.error('âŒ Error fetching database timestamp after refresh:', error);
                        // Fallback to browser time
                        const now = new Date();
                        const timeString = now.toLocaleTimeString('en-US', { 
                            hour: 'numeric', 
                            minute: '2-digit',
                            hour12: true 
                        });
                        kpiLastUpdated.textContent = `Last updated: ${timeString}`;
                    }
                    kpiLastUpdated.style.color = '#94a3b8';
                    kpiLastUpdated.style.fontWeight = 'normal';
                }
                
                // Restore button state for all refresh buttons
                const refreshButtons = document.querySelectorAll('button[onclick="window.refreshPortfolioData()"]');
                refreshButtons.forEach(button => {
                    // Only restore text content if the button originally had text content
                    if (button.textContent.trim() !== '') {
                    button.textContent = 'Refresh';
                    }
                    button.disabled = false;
                });
            }
            
        };


        // Initialize last updated timestamp system when page loads
        if (window.lastUpdatedSystem) {
            window.lastUpdatedSystem.init();
        }
        
        // Initialize dynamic performance metrics system when page loads
        if (window.performanceCalculator) {
            window.performanceCalculator.init();
        }

        </script>
</body>
</html>
