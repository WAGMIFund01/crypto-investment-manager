<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Investment Manager</title>
    <!-- Add a simple data URI favicon to prevent 404 errors -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∞</text></svg>">
    <!-- <link rel="stylesheet" href="styles.css"> --> <!-- All styles are now inline -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* Modern Fintech √ó Crypto-Native Design System */
        

        
        :root {
            /* Dark Mode Foundation */
            --bg-primary: #0a0b0d;
            --bg-secondary: #111318;
            --bg-tertiary: #1a1d24;
            --bg-card: #1e2128;
            --bg-elevated: #252830;
            
            /* Fluorescent Accents */
            --accent-orange: #ff6b35;
            --accent-green: #00d4aa;
            --accent-purple: #8b5cf6;
            --accent-blue: #3b82f6;
            
            /* Text Colors */
            --text-primary: #666666; /* Medium gray - same as Details text for good visibility */
            --text-secondary: #999999; /* Lighter gray for labels, captions */
            --text-muted: #555555; /* Darker gray for muted text */
            --text-highlight: #ffffff; /* Pure white for emphasis */
            --text-success: #00d4aa;
            --text-danger: #ff4757;
            
            /* Borders & Dividers */
            --border-primary: #2d3139;
            --border-secondary: #3d4148;
            --border-accent: #ff6b35;
            
            /* Shadows */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 20px rgba(255, 107, 53, 0.3);
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, var(--accent-orange) 0%, var(--accent-green) 100%);
            --gradient-card: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-elevated) 100%);
            --gradient-success: linear-gradient(135deg, var(--accent-green) 0%, #00b894 100%);
        }

        /* Base Overrides */
        * {
            box-sizing: border-box;
        }

        body {
            background: var(--bg-primary) !important;
            color: var(--text-primary) !important;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif !important;
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        /* App Layout */
        .app {
            background: var(--bg-primary);
            min-height: 100vh;
        }

        /* Manager View */
        .manager-view {
            background: var(--bg-primary) !important;
            color: var(--text-primary) !important;
        }

        .manager-header {
            background: var(--bg-secondary) !important;
            border-bottom: 1px solid var(--border-primary) !important;
            padding: 1rem 2rem !important;
        }

        .manager-header h1 {
            color: var(--text-primary) !important;
            font-size: 1.5rem !important;
            font-weight: 700 !important;
            margin: 0 !important;
        }

        .manager-header .header-stats {
            gap: 2rem !important;
        }

        .manager-header .stat-item {
            color: var(--text-secondary) !important;
        }

        .manager-header .stat-value {
            color: var(--text-primary) !important;
            font-weight: 600 !important;
        }

        /* Navigation */
        .nav {
            background: var(--bg-secondary) !important;
            border-bottom: 1px solid var(--border-primary) !important;
            padding: 0 2rem !important;
        }

        .nav-btn {
            background: transparent !important;
            color: var(--text-secondary) !important;
            border: none !important;
            padding: 1rem 1.5rem !important;
            font-weight: 500 !important;
            transition: all 0.2s ease !important;
            border-bottom: 2px solid transparent !important;
        }

        .nav-btn:hover {
            color: var(--text-highlight) !important;
            background: var(--bg-tertiary) !important;
        }

        .nav-btn.active {
            color: var(--accent-orange) !important;
            border-bottom-color: var(--accent-orange) !important;
        }

        /* Cards */
        .card {
            background: var(--gradient-card) !important;
            border: 1px solid var(--border-primary) !important;
            border-radius: 12px !important;
            padding: 1.5rem !important;
            margin-bottom: 1.5rem !important;
            box-shadow: var(--shadow-md) !important;
            transition: all 0.3s ease !important;
        }

        .card:hover {
            border-color: var(--border-secondary) !important;
            transform: translateY(-2px) !important;
            box-shadow: var(--shadow-lg) !important;
        }

        .card h2, .card h3 {
            color: var(--text-primary) !important;
            margin-top: 0 !important;
            font-weight: 700 !important;
        }

        /* Summary Dashboard */
        .summary-dashboard {
            background: var(--gradient-card) !important;
            border: 1px solid var(--border-accent) !important;
            box-shadow: var(--shadow-glow) !important;
        }

        .summary-metric {
            background: var(--bg-elevated) !important;
            border: 1px solid var(--border-primary) !important;
            border-radius: 8px !important;
            transition: all 0.3s ease !important;
        }

        .summary-metric .metric-value {
            color: var(--text-highlight) !important; /* Pure white for numbers */
            font-weight: 700 !important; /* Bold numbers */
            font-size: 2rem !important;
        }

        .summary-metric .metric-label {
            color: var(--text-secondary) !important; /* Light gray for labels */
            font-weight: 500 !important; /* Slightly bolder labels */
            text-transform: uppercase !important;
            letter-spacing: 0.05em !important;
            font-size: 0.875rem !important;
        }

        /* Clickable Metrics */
        .clickable-metric:hover {
            transform: translateY(-4px) !important;
            box-shadow: var(--shadow-lg) !important;
            border-color: var(--accent-orange) !important;
            background: linear-gradient(135deg, var(--bg-elevated) 0%, var(--bg-card) 100%) !important;
        }

        .clickable-metric:hover .metric-value {
            color: var(--text-highlight) !important;
        }

        .clickable-metric .metric-label::after {
            content: " üëÜ";
            opacity: 0;
            transition: opacity 0.2s;
        }

        .clickable-metric:hover .metric-label::after {
            opacity: 1;
        }

        /* Buttons */
        .btn {
            font-family: inherit !important;
            font-weight: 600 !important;
            border-radius: 8px !important;
            padding: 0.75rem 1.5rem !important;
            border: none !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            text-decoration: none !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 0.5rem !important;
        }

        .btn-primary {
            background: var(--gradient-primary) !important;
            color: var(--text-highlight) !important;
            box-shadow: var(--shadow-sm) !important;
        }

        .btn-primary:hover {
            transform: translateY(-2px) !important;
            box-shadow: var(--shadow-md) !important;
        }

        .btn-secondary {
            background: var(--bg-elevated) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-secondary) !important;
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary) !important;
            border-color: var(--accent-orange) !important;
        }

        /* Landing page specific styles */
        .login-screen h1 {
            font-size: clamp(2.5rem, 8vw, 4rem) !important;
        }

        .login-screen .btn:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3) !important;
        }

        .btn-secondary[style*="accent-green"]:hover {
            background: var(--accent-green) !important;
            color: var(--bg-primary) !important;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .login-screen .login-container {
                padding: 2rem 1rem !important;
            }
            
            .login-screen h1 {
                font-size: 2.5rem !important;
            }
            
            .login-screen .btn {
                min-width: 100% !important;
                margin-bottom: 1rem !important;
            }
            
            .login-screen > div[style*="flex"] {
                flex-direction: column !important;
                gap: 1rem !important;
            }
        }

        /* Tables */
        .data-table {
            width: 100% !important;
            border-collapse: collapse !important;
            background: transparent !important;
        }

        .data-table th {
            background: var(--bg-secondary) !important;
            color: var(--text-secondary) !important;
            font-weight: 600 !important;
            padding: 1rem !important;
            text-align: left !important;
            border-bottom: 1px solid var(--border-primary) !important;
            font-size: 0.875rem !important;
            text-transform: uppercase !important;
            letter-spacing: 0.05em !important;
        }

        .data-table td {
            padding: 1rem !important;
            border-bottom: 1px solid var(--border-primary) !important;
            color: var(--text-primary) !important; /* Now uses the updated medium gray color */
            font-weight: 500 !important; /* Slightly bolder for better readability */
        }

        .data-table th {
            color: var(--text-secondary) !important; /* Light gray for headers */
            font-weight: 600 !important;
            padding: 1rem !important;
        }

        .data-table tr:hover td {
            color: var(--text-highlight) !important; /* Pure white on hover */
            background: var(--bg-elevated) !important; /* Subtle background highlight */
        }

        .data-table tr:hover {
            background: var(--bg-secondary) !important;
        }

        .data-table tr[style*="cursor: pointer"]:hover {
            background: var(--bg-tertiary) !important;
            transform: scale(1.01) !important;
            transition: all 0.2s ease !important;
        }

        /* Positive/Negative Values */
        .positive {
            color: var(--text-success) !important;
            font-weight: 600 !important;
        }

        .negative {
            color: var(--text-danger) !important;
            font-weight: 600 !important;
        }

        /* Modals - Hidden by default, shown when active */
        .modal {
            display: none !important;
            position: fixed !important;
            z-index: 1000 !important;
            left: 0 !important;
            top: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0, 0, 0, 0.8) !important;
            backdrop-filter: blur(8px) !important;
        }
        
        .modal.active {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        .modal-content {
            background: var(--gradient-card) !important;
            border: 1px solid var(--border-secondary) !important;
            border-radius: 16px !important;
            box-shadow: var(--shadow-lg) !important;
            animation: modalSlideIn 0.3s ease !important;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal h2 {
            color: var(--text-primary) !important;
        }

        .modal .close {
            color: var(--text-secondary) !important;
            font-size: 1.5rem !important;
        }

        .modal .close:hover {
            color: var(--accent-orange) !important;
        }

        /* Form Elements */
        .form-group label {
            color: var(--text-primary) !important;
            font-weight: 600 !important;
            margin-bottom: 0.5rem !important;
            display: block !important;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            background: var(--bg-secondary) !important;
            border: 1px solid var(--border-primary) !important;
            color: var(--text-primary) !important;
            border-radius: 8px !important;
            padding: 0.75rem !important;
            width: 100% !important;
            transition: all 0.2s ease !important;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none !important;
            border-color: var(--accent-orange) !important;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1) !important;
        }

        /* Autocomplete Styles */
        .autocomplete-container {
            position: relative !important;
        }

        .autocomplete-suggestions {
            position: absolute !important;
            top: 100% !important;
            left: 0 !important;
            right: 0 !important;
            background: var(--bg-secondary) !important;
            border: 1px solid var(--border-primary) !important;
            border-top: none !important;
            border-radius: 0 0 8px 8px !important;
            max-height: 200px !important;
            overflow-y: auto !important;
            z-index: 1000 !important;
            display: none !important;
        }

        .autocomplete-suggestion {
            padding: 0.75rem !important;
            cursor: pointer !important;
            color: var(--text-primary) !important;
            transition: background-color 0.2s ease !important;
            border-bottom: 1px solid var(--border-secondary) !important;
        }

        .autocomplete-suggestion:hover,
        .autocomplete-suggestion.highlighted {
            background: var(--bg-tertiary) !important;
        }

        .autocomplete-suggestion:last-child {
            border-bottom: none !important;
        }



        /* Asset Dropdown */
        .asset-dropdown {
            background: var(--bg-elevated) !important;
            border: 1px solid var(--border-secondary) !important;
            border-radius: 8px !important;
            box-shadow: var(--shadow-lg) !important;
        }

        .asset-result:hover {
            background: var(--bg-tertiary) !important;
        }

        /* Modern Portfolio Styles */
        .portfolio-section {
            max-width: 1200px !important;
            margin: 0 auto !important;
            padding: 2rem !important;
        }

        .portfolio-header {
            display: flex !important;
            align-items: center !important;
            margin-bottom: 2rem !important;
        }

        .portfolio-brand {
            display: flex !important;
            align-items: center !important;
            gap: 1rem !important;
        }

        .brand-circle {
            width: 48px !important;
            height: 48px !important;
            background: var(--accent-green) !important;
            border-radius: 50% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-weight: 700 !important;
            font-size: 1rem !important;
            color: var(--bg-primary) !important;
        }

        .portfolio-title {
            font-size: 2.5rem !important;
            font-weight: 700 !important;
            color: var(--text-highlight) !important;
            margin: 0 !important;
        }

        .portfolio-value-card {
            background: var(--bg-elevated) !important;
            border: 1px solid var(--border-primary) !important;
            border-radius: 16px !important;
            padding: 2rem !important;
            margin-bottom: 2rem !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
        }

        .portfolio-value-content {
            flex: 1 !important;
        }

        .value-label {
            font-size: 0.9rem !important;
            color: var(--text-secondary) !important;
            text-transform: uppercase !important;
            letter-spacing: 0.1em !important;
            margin-bottom: 0.5rem !important;
        }

        .total-value {
            font-size: 3.5rem !important;
            font-weight: 700 !important;
            color: var(--text-highlight) !important;
            margin-bottom: 0.5rem !important;
        }

        .portfolio-change .positive {
            color: var(--accent-green) !important;
            font-weight: 600 !important;
        }

        .portfolio-actions {
            display: flex !important;
            gap: 1rem !important;
        }

        .portfolio-btn {
            padding: 0.75rem 1.5rem !important;
            border-radius: 12px !important;
            font-weight: 600 !important;
        }

        .assets-section {
            background: var(--bg-elevated) !important;
            border: 1px solid var(--border-primary) !important;
            border-radius: 16px !important;
            overflow: hidden !important;
        }

        .assets-header {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            padding: 1.5rem 2rem !important;
            border-bottom: 1px solid var(--border-primary) !important;
        }

        .assets-title {
            font-size: 1.25rem !important;
            font-weight: 700 !important;
            color: var(--text-primary) !important;
        }

        .assets-count {
            font-size: 0.9rem !important;
            color: var(--text-secondary) !important;
            background: var(--bg-secondary) !important;
            padding: 0.25rem 0.75rem !important;
            border-radius: 12px !important;
        }

        .assets-table-container {
            padding: 0 !important;
        }

        .assets-table-header {
            display: grid !important;
            grid-template-columns: 1.8fr 0.8fr 1fr 0.8fr 0.8fr 0.8fr 1fr 1.2fr 1fr !important;
            gap: 0.8rem !important;
            padding: 1rem 2rem !important;
            border-bottom: 1px solid var(--border-primary) !important;
            background: var(--bg-secondary) !important;
            font-size: 0.8rem !important;
            font-weight: 600 !important;
            color: var(--text-secondary) !important;
            text-transform: uppercase !important;
            letter-spacing: 0.05em !important;
        }

        .assets-table-body {
            padding: 0 !important;
        }

        .asset-row {
            display: grid !important;
            grid-template-columns: 1.8fr 0.8fr 1fr 0.8fr 0.8fr 0.8fr 1fr 1.2fr 1fr !important;
            gap: 0.8rem !important;
            padding: 1.2rem 2rem !important;
            border-bottom: 1px solid var(--border-primary) !important;
            transition: background 0.2s ease !important;
            align-items: center !important;
        }

        .asset-row:hover {
            background: var(--bg-secondary) !important;
        }

        .asset-row:last-child {
            border-bottom: none !important;
        }

        .asset-col-asset {
            display: flex !important;
            align-items: center !important;
        }

        .asset-info {
            display: flex !important;
            align-items: center !important;
            gap: 1rem !important;
        }

        .asset-icon {
            width: 40px !important;
            height: 40px !important;
            border-radius: 50% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            overflow: hidden !important;
            background: var(--bg-secondary) !important;
            border: 1px solid var(--border-primary) !important;
        }

        .asset-icon img {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
            border-radius: 50% !important;
        }

        .asset-icon.fallback {
            background: var(--accent-orange) !important;
            color: white !important;
            font-weight: 700 !important;
            font-size: 1.2rem !important;
        }

        .asset-details {
            display: flex !important;
            flex-direction: column !important;
        }

        .asset-name {
            font-weight: 600 !important;
            color: var(--text-primary) !important;
            font-size: 1rem !important;
        }

        .asset-symbol {
            font-size: 0.85rem !important;
            color: var(--text-secondary) !important;
            text-transform: uppercase !important;
        }

        .asset-col-chain,
        .asset-col-quantity,
        .asset-col-risk,
        .asset-col-location,
        .asset-col-cointype,
        .asset-col-price,
        .asset-col-value,
        .asset-col-actions {
            display: flex !important;
            align-items: center !important;
            font-weight: 600 !important;
            color: var(--text-primary) !important;
            justify-content: center !important;
            font-size: 0.85rem !important;
        }

        .asset-col-chain {
            justify-content: center !important;
        }

        .chain-badge {
            background: var(--bg-secondary) !important;
            border: 1px solid var(--border-primary) !important;
            border-radius: 12px !important;
            padding: 4px 8px !important;
            font-size: 0.75rem !important;
            font-weight: 600 !important;
            color: var(--text-secondary) !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
        }

        .chain-badge[data-chain="ethereum"] {
            background: rgba(98, 126, 234, 0.1) !important;
            border-color: rgba(98, 126, 234, 0.3) !important;
            color: #627eea !important;
        }

        .chain-badge[data-chain="solana"] {
            background: rgba(153, 69, 255, 0.1) !important;
            border-color: rgba(153, 69, 255, 0.3) !important;
            color: #9945ff !important;
        }

        .chain-badge[data-chain="hyperliquid"] {
            background: rgba(0, 255, 100, 0.1) !important;
            border-color: rgba(0, 255, 100, 0.3) !important;
            color: #00ff64 !important;
        }

        .asset-col-value {
            color: var(--text-highlight) !important;
            font-weight: 700 !important;
        }

        .asset-col-actions {
            justify-content: flex-start !important;
            gap: 8px !important;
            align-items: center !important;
        }

        .asset-quantity-input {
            background: var(--bg-secondary) !important;
            border: 1px solid var(--border-primary) !important;
            border-radius: 4px !important;
            padding: 4px 8px !important;
            color: var(--text-primary) !important;
            font-size: 0.9rem !important;
            width: 80px !important;
            text-align: right !important;
        }

        .asset-risk-input, .asset-location-input, .asset-cointype-input {
            background: var(--bg-secondary) !important;
            border: 1px solid var(--border-primary) !important;
            border-radius: 4px !important;
            padding: 4px 8px !important;
            color: var(--text-primary) !important;
            font-size: 0.85rem !important;
            width: 100% !important;
        }

        .asset-risk-input:focus, .asset-location-input:focus, .asset-cointype-input:focus {
            outline: none !important;
            border-color: var(--accent-orange) !important;
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1) !important;
        }

        .asset-edit-btn, .asset-save-btn, .asset-cancel-btn, .asset-delete-btn {
            background: none !important;
            border: none !important;
            color: var(--accent-orange) !important;
            cursor: pointer !important;
            font-size: 0.8rem !important;
            padding: 4px 8px !important;
            border-radius: 4px !important;
            transition: all 0.2s !important;
        }

        .asset-edit-btn:hover, .asset-save-btn:hover {
            background: var(--accent-orange) !important;
            color: white !important;
        }

        .asset-cancel-btn {
            color: var(--text-secondary) !important;
        }

        .asset-cancel-btn:hover {
            background: var(--text-secondary) !important;
            color: white !important;
        }

        .asset-delete-btn {
            color: #dc3545 !important;
        }

        .asset-delete-btn:hover {
            background: #dc3545 !important;
            color: white !important;
        }

        /* Responsive Portfolio */
        @media (max-width: 768px) {
            .portfolio-value-card {
                flex-direction: column !important;
                gap: 1.5rem !important;
                text-align: center !important;
            }

            .portfolio-actions {
                justify-content: center !important;
            }

            .assets-table-header,
            .asset-row {
                grid-template-columns: 1fr !important;
                gap: 0.5rem !important;
            }

            .asset-info {
                justify-content: center !important;
            }
        }

        .total-value {
            background: var(--gradient-primary) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
        }

        /* Login Screen */
        .login-screen {
            background: var(--bg-primary) !important;
        }

        .login-container {
            background: var(--bg-secondary) !important;
            border: 1px solid var(--border-primary) !important;
            border-radius: 16px !important;
            box-shadow: var(--shadow-lg) !important;
        }

        .login-card {
            background: var(--gradient-card) !important;
            border: 1px solid var(--border-primary) !important;
            border-radius: 12px !important;
            transition: all 0.3s ease !important;
        }

        .login-card:hover {
            border-color: var(--accent-orange) !important;
            transform: translateY(-4px) !important;
            box-shadow: var(--shadow-glow) !important;
        }

        .login-card h3 {
            color: var(--text-primary) !important;
        }

        .login-card p {
            color: var(--text-secondary) !important;
        }

        /* Tab Content - Hide by default, show when active */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Better contrast for specific elements */
        .portfolio-value-display .total-value {
            color: var(--text-highlight) !important;
        }

        .portfolio-value-display .last-updated {
            color: var(--text-secondary) !important;
        }

        /* Table improvements */
        .data-table td strong {
            color: var(--text-primary) !important; /* Use same readable color as other text */
            font-weight: 600 !important; /* Keep it bold for emphasis */
        }

        /* Empty state improvements */
        .data-table td[colspan] {
            color: var(--text-secondary) !important;
        }



        /* Modal improvements */
        .modal h2 {
            color: var(--text-highlight) !important;
        }

        /* Asset dropdown improvements */
        .asset-result div:first-child {
            color: var(--text-primary) !important;
        }

        .asset-result div:last-child {
            color: var(--text-secondary) !important;
        }

        .asset-result:hover div:first-child {
            color: var(--text-highlight) !important;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-secondary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-orange);
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Login/Selection Screen -->
        <div id="loginScreen" class="login-screen" style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: var(--bg-primary); position: relative; overflow: hidden;">
            <!-- Background decorative elements -->
            <div style="position: absolute; top: 10%; right: 10%; width: 60px; height: 60px; background: var(--accent-orange); border-radius: 50%; opacity: 0.8;"></div>
            <div style="position: absolute; bottom: 15%; left: 8%; width: 40px; height: 40px; background: var(--accent-green); border-radius: 50%; opacity: 0.6;"></div>
            <div style="position: absolute; top: 20%; left: 15%; width: 80px; height: 80px; border: 2px solid var(--accent-green); border-radius: 50%; opacity: 0.4;"></div>
            
            <div class="login-container" style="max-width: 800px; width: 100%; padding: 3rem 2rem; text-align: center; position: relative; z-index: 1;">
                <!-- Brand -->
                <div style="margin-bottom: 1rem;">
                    <div style="display: inline-flex; align-items: center; justify-content: center; width: 80px; height: 80px; background: var(--accent-green); border-radius: 50%; margin-bottom: 2rem; font-size: 1.5rem; font-weight: bold; color: var(--bg-primary);">WAGMI</div>
                    </div>
                
                <!-- Main heading -->
                <h1 style="font-size: 4rem; font-weight: 700; color: var(--text-highlight); margin-bottom: 1rem; line-height: 1.1;">
                    Crypto Portfolio<br>Management
                </h1>
                
                <!-- Subtitle -->
                <p style="font-size: 1.25rem; color: var(--text-secondary); margin-bottom: 3rem; max-width: 600px; margin-left: auto; margin-right: auto; line-height: 1.6;">
                    Manage and track cryptocurrency investment funds
                </p>
                
                <!-- Debug buttons (remove after testing) -->
                <div style="margin-bottom: 30px; display: none;">
                    <button onclick="window.simpleTest()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin: 5px; cursor: pointer;">üîß Simple Test</button>
                    <button onclick="window.testScript()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin: 5px; cursor: pointer;">üß™ Test JS</button>
                    <button onclick="window.debugApp()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin: 5px; cursor: pointer;">üîç Debug App</button>
                    <button onclick="window.enterManagerView()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin: 5px; cursor: pointer;">üîß Force Manager View</button>
                    <button onclick="window.refreshLiveData()" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin: 5px; cursor: pointer;">üîÑ Refresh Live Data</button>
                    <button onclick="window.testApiConnection()" style="background: #ffc107; color: black; border: none; padding: 8px 16px; border-radius: 4px; margin: 5px; cursor: pointer;">üîç Test API</button>
                    </div>

                <!-- Action buttons -->
                <div style="display: flex; gap: 1.5rem; justify-content: center; align-items: center; flex-wrap: wrap;">
                    <button class="btn btn-primary" id="managerPortalButton" style="font-size: 1.1rem; padding: 1rem 2.5rem; border-radius: 12px; min-width: 200px;">
                        Manager Portal
                    </button>
                    <button class="btn btn-secondary" id="investorPortalButton" style="font-size: 1.1rem; padding: 1rem 2.5rem; border-radius: 12px; min-width: 200px; background: transparent !important; border: 2px solid var(--accent-green) !important; color: var(--accent-green) !important;">
                        Investor View
                    </button>
                </div>
                
                <!-- Additional info -->
                <div style="margin-top: 2rem; font-size: 0.9rem; color: var(--text-muted);">
                    <p>Manager Portal: Full access to fund management and analytics</p>
                    <p>Investor View: Personal investment performance tracking</p>
                </div>
            </div>
        </div>

        <!-- Investor ID Input Modal -->
        <div id="investorLoginModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="app.closeInvestorLogin()">&times;</span>
                <h2>Investor Access</h2>
                <p style="color: #666; margin-bottom: 20px;">Enter your unique Investor ID to access your portfolio</p>
                <div class="investor-id-form">
                    <input type="text" id="investorIdInput" placeholder="e.g., OA6" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 15px; text-transform: uppercase;">
                    <button class="btn btn-primary" onclick="app.loginWithInvestorId()" style="width: 100%;">Access My Portfolio</button>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 14px; color: #666;">
                    <strong>Investor ID Format:</strong> First Name + Last Name Initial + Number<br>
                    <em>Example: Omair Ansari (#6) ‚Üí OA6</em><br><br>
                    <strong>Don't have your Investor ID?</strong><br>
                    Contact your fund manager to receive your secure access credentials.
                </div>
            </div>
        </div>

        <!-- Manager View -->
        <div id="managerView" class="view-container" style="display: none;">
            <!-- Header -->
            <header class="header">
                <div class="header-content">
                    <div class="header-left">
                        <h1 style="background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 1.5rem; font-weight: 700;">‚ü† Crypto Investment Manager</h1>
                        <span class="view-badge manager" style="background: var(--accent-orange); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Manager View</span>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="app.exportAllDataAsCSV()">Export Data</button>
                        <button class="btn btn-secondary" onclick="window.backToLogin()">Switch View</button>
                    </div>
                    <div class="header-stats">
                        <div class="stat-card">
                            <span class="stat-label">Total AUM</span>
                            <span class="stat-value" id="totalAUM">$0.00</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-label">Total Return</span>
                            <span class="stat-value" id="totalReturn">0.00%</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-label">Active Investors</span>
                            <span class="stat-value" id="activeInvestors">0</span>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Navigation -->
            <nav class="nav">
                <button class="nav-btn active" data-tab="dashboard">Dashboard</button>
                <button class="nav-btn" data-tab="investors">Investors</button>
                <button class="nav-btn" data-tab="portfolio">Portfolio</button>
                <button class="nav-btn" data-tab="performance">Performance</button>
            </nav>

            <!-- Main Content -->
            <main class="main">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                    <!-- Overall Summary Dashboard -->
                    <section class="card summary-dashboard" style="margin-bottom: 30px;">
                                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h2 style="color: #2c3e50; margin: 0;">üìä Portfolio Overview</h2>
                                <div style="text-align: right;">
                                    <div id="dashboardLastUpdated" style="font-size: 0.8rem; color: #7f8c8d; font-style: italic;">Portfolio Overview: Loading...</div>
                                    <div id="dashboardAssetPricesLastUpdated" style="font-size: 0.8rem; color: #7f8c8d; font-style: italic;">Asset Prices: Loading...</div>
                                </div>
                            </div>
                        <div class="summary-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div class="summary-metric clickable-metric" onclick="window.switchTab('investors')" style="text-align: center; padding: 15px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" title="Click to view all investors">
                                <div class="metric-icon" style="font-size: 24px; margin-bottom: 8px;">üë•</div>
                                <div class="metric-value" id="summaryTotalInvestors" style="font-size: 2rem; font-weight: bold; color: #2c3e50;">6</div>
                                <div class="metric-label" style="color: #7f8c8d; font-size: 0.9rem;">Total Investors</div>
                            </div>
                            <div class="summary-metric clickable-metric" onclick="window.switchTab('investors')" style="text-align: center; padding: 15px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" title="Click to view investor details">
                                <div class="metric-icon" style="font-size: 24px; margin-bottom: 8px;">üí∞</div>
                                <div class="metric-value" id="summaryTotalInvested" style="font-size: 2rem; font-weight: bold; color: #2c3e50;">$26,906</div>
                                <div class="metric-label" style="color: #7f8c8d; font-size: 0.9rem;">Total Invested</div>
                            </div>
                            <div class="summary-metric clickable-metric" style="text-align: center; padding: 15px; cursor: pointer;" onclick="window.switchTab('portfolio')" title="Click to view Portfolio üëÜ">
                                <div class="metric-icon" style="font-size: 24px; margin-bottom: 8px;">üíé</div>
                                <div class="metric-value" id="summaryCurrentValue" style="font-size: 2rem; font-weight: bold; color: #2c3e50;">$31,002</div>
                                <div class="metric-label" style="color: #7f8c8d; font-size: 0.9rem;">Current Value</div>
                            </div>
                            <div class="summary-metric" style="text-align: center; padding: 15px;">
                                <div class="metric-icon" style="font-size: 24px; margin-bottom: 8px;">üìà</div>
                                <div class="metric-value positive" id="summaryTotalPnL" style="font-size: 2rem; font-weight: bold;">+$4,096</div>
                                <div class="metric-label" style="color: #7f8c8d; font-size: 0.9rem;">Total P&L</div>
                            </div>
                            <div class="summary-metric" style="text-align: center; padding: 15px;">
                                <div class="metric-icon" style="font-size: 24px; margin-bottom: 8px;">üìä</div>
                                <div class="metric-value positive" id="summaryMonthlyReturn" style="font-size: 2rem; font-weight: bold;">+2.8%</div>
                                <div class="metric-label" style="color: #7f8c8d; font-size: 0.9rem;">Month-on-Month</div>
                            </div>
                        </div>
                    </section>

                    <div class="dashboard-grid">
                    <!-- Investment Summaries -->
                    <section class="card">
                        <h2>Investment Summaries</h2>
                        <div id="investmentSummaries" class="summaries-grid">
                            <!-- Investment summary cards will be generated here -->
                        </div>

                    </section>

                    <!-- Portfolio Overview -->
                    <section class="card">
                        <h2>Portfolio Allocation</h2>
                        <div class="chart-container">
                            <canvas id="allocationChart"></canvas>
                        </div>
                    </section>

                    <!-- Recent Transactions -->
                    <section class="card">
                        <h2>Recent Transactions</h2>
                        <div id="recentTransactions" class="transactions-list">
                            <!-- Recent transactions will be shown here -->
                        </div>
                    </section>

                    <!-- Performance Chart -->
                    <section class="card">
                        <h2>Portfolio Performance</h2>
                        <div class="chart-container">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </section>
                </div>
            </div>

            <!-- Investors Tab -->
            <div id="investors" class="tab-content">
                    <!-- Overall Summary Dashboard for Investors Tab -->
                    <section class="card summary-dashboard" style="margin-bottom: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: #2c3e50; margin: 0;">üìä Portfolio Overview</h2>
                            <div style="text-align: right;">
                                <div id="investorsLastUpdated" style="font-size: 0.8rem; color: #7f8c8d; font-style: italic;">Portfolio Overview: Loading...</div>
                                <div id="investorsAssetPricesLastUpdated" style="font-size: 0.8rem; color: #7f8c8d; font-style: italic;">Asset Prices: Loading...</div>
                            </div>
                        </div>
                        <div class="summary-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div class="summary-metric clickable-metric" onclick="window.scrollToInvestorTable()" style="text-align: center; padding: 15px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" title="Click to scroll to investor table">
                                <div class="metric-icon" style="font-size: 24px; margin-bottom: 8px;">üë•</div>
                                <div class="metric-value" id="investorsSummaryTotalInvestors" style="font-size: 2rem; font-weight: bold; color: #2c3e50;">6</div>
                                <div class="metric-label" style="color: #7f8c8d; font-size: 0.9rem;">Total Investors</div>
                            </div>
                            <div class="summary-metric clickable-metric" onclick="window.scrollToInvestorTable()" style="text-align: center; padding: 15px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" title="Click to scroll to investor table">
                                <div class="metric-icon" style="font-size: 24px; margin-bottom: 8px;">üí∞</div>
                                <div class="metric-value" id="investorsSummaryTotalInvested" style="font-size: 2rem; font-weight: bold; color: #2c3e50;">$26,906</div>
                                <div class="metric-label" style="color: #7f8c8d; font-size: 0.9rem;">Total Invested</div>
                            </div>
                            <div class="summary-metric clickable-metric" style="text-align: center; padding: 15px; cursor: pointer;" onclick="window.switchTab('portfolio')" title="Click to view Portfolio üëÜ">
                                <div class="metric-icon" style="font-size: 24px; margin-bottom: 8px;">üíé</div>
                                <div class="metric-value" id="investorsSummaryCurrentValue" style="font-size: 2rem; font-weight: bold; color: #2c3e50;">$31,002</div>
                                <div class="metric-label" style="color: #7f8c8d; font-size: 0.9rem;">Current Value</div>
                            </div>
                            <div class="summary-metric" style="text-align: center; padding: 15px;">
                                <div class="metric-icon" style="font-size: 24px; margin-bottom: 8px;">üìà</div>
                                <div class="metric-value positive" id="investorsSummaryTotalPnL" style="font-size: 2rem; font-weight: bold;">+$4,096</div>
                                <div class="metric-label" style="color: #7f8c8d; font-size: 0.9rem;">Total P&L</div>
                            </div>
                            <div class="summary-metric" style="text-align: center; padding: 15px;">
                                <div class="metric-icon" style="font-size: 24px; margin-bottom: 8px;">üìä</div>
                                <div class="metric-value positive" id="investorsSummaryMonthlyReturn" style="font-size: 2rem; font-weight: bold;">+2.8%</div>
                                <div class="metric-label" style="color: #7f8c8d; font-size: 0.9rem;">Month-on-Month</div>
                            </div>
                        </div>
                    </section>

                    <div class="investors-header">
                    <h2>Investor Management</h2>

                </div>
                <div class="table-container">
                    <table id="investorsTable" class="data-table">
                        <thead>
                            <tr>
                                <th>Investor ID</th>
                                <th>Name</th>
                                <th>Date Joined</th>
                                <th>Investment Value</th>
                                <th>Current Value</th>
                                <th>Total Return</th>
                                <th>Share %</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="investorsTableBody">
                            <!-- Investor rows will be generated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Portfolio Tab -->
            <div id="portfolio" class="tab-content">
                    <!-- Portfolio Overview Widget -->
                    <section class="card summary-dashboard" style="margin-bottom: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: #2c3e50; margin: 0;">üìä Portfolio Overview</h2>
                            <div style="text-align: right;">
                                <div id="portfolioLastUpdated" style="font-size: 0.8rem; color: #7f8c8d; font-style: italic;">Portfolio Overview: Loading...</div>
                                <div id="portfolioAssetPricesLastUpdated" style="font-size: 0.8rem; color: #7f8c8d; font-style: italic;">Asset Prices: Loading...</div>
                            </div>
                        </div>
                        <div class="summary-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div class="summary-metric clickable-metric" onclick="window.switchTab('investors')" style="text-align: center; padding: 15px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" title="Click to view all investors">
                                <div class="metric-icon" style="font-size: 24px; margin-bottom: 8px;">üë•</div>
                                <div class="metric-value" id="portfolioSummaryTotalInvestors" style="font-size: 2rem; font-weight: bold; color: #2c3e50;">6</div>
                                <div class="metric-label" style="color: #7f8c8d; font-size: 0.9rem;">Total Investors</div>
                            </div>
                            <div class="summary-metric clickable-metric" onclick="window.switchTab('investors')" style="text-align: center; padding: 15px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" title="Click to view investor details">
                                <div class="metric-icon" style="font-size: 24px; margin-bottom: 8px;">üí∞</div>
                                <div class="metric-value" id="portfolioSummaryTotalInvested" style="font-size: 2rem; font-weight: bold; color: #2c3e50;">$26,906</div>
                                <div class="metric-label" style="color: #7f8c8d; font-size: 0.9rem;">Total Invested</div>
                            </div>
                            <div class="summary-metric" style="text-align: center; padding: 15px;">
                                <div class="metric-icon" style="font-size: 24px; margin-bottom: 8px;">üíé</div>
                                <div class="metric-value" id="portfolioSummaryCurrentValue" style="font-size: 2rem; font-weight: bold; color: #2c3e50;">$0.00</div>
                                <div class="metric-label" style="color: #7f8c8d; font-size: 0.9rem;">Current Value</div>
                            </div>
                            <div class="summary-metric" style="text-align: center; padding: 15px;">
                                <div class="metric-icon" style="font-size: 24px; margin-bottom: 8px;">üìà</div>
                                <div class="metric-value positive" id="portfolioSummaryTotalPnL" style="font-size: 2rem; font-weight: bold;">+$0.00</div>
                                <div class="metric-label" style="color: #7f8c8d; font-size: 0.9rem;">Total P&L</div>
                            </div>
                            <div class="summary-metric" style="text-align: center; padding: 15px;">
                                <div class="metric-icon" style="font-size: 24px; margin-bottom: 8px;">üìä</div>
                                <div class="metric-value positive" id="portfolioSummaryMonthlyReturn" style="font-size: 2rem; font-weight: bold;">+2.8%</div>
                                <div class="metric-label" style="color: #7f8c8d; font-size: 0.9rem;">Month-on-Month</div>
                            </div>
                        </div>
                        <div class="portfolio-actions" style="text-align: center; margin-top: 20px;">
                            <button class="btn btn-secondary portfolio-btn" onclick="window.refreshPortfolioData()">Refresh Portfolio</button>
                        </div>
                    </section>
                    <!-- Portfolio Header -->
                <div class="portfolio-header">
                        <div class="portfolio-brand">
                            <div class="brand-circle">WAGMI</div>
                            <h1 class="portfolio-title">Portfolio</h1>
                        </div>
                    </div>
                
                    <!-- Portfolio Analysis Charts -->
                    <div class="portfolio-charts-section" style="margin: 30px 0;">
                        <div class="charts-header" style="text-align: center; margin-bottom: 30px;">
                            <h2 style="color: var(--text-primary); font-size: 1.8rem; margin-bottom: 10px;">üìä Portfolio Analysis</h2>
                            <p style="color: var(--text-secondary); font-size: 1rem;">Portfolio allocation breakdown by category</p>
                        </div>
                        <div class="stacked-chart-container" style="background: var(--bg-elevated); border-radius: 12px; padding: 30px; border: 1px solid var(--border-primary);">
                            <div class="chart-container" style="position: relative; height: 400px;">
                                <canvas id="portfolioStackedChart"></canvas>
                            </div>
                    </div>
                </div>

                    <!-- Target vs Current Allocation Analysis -->
                    <div class="target-allocation-section" style="margin-bottom: 40px;">
                        <div class="section-header" style="margin-bottom: 25px;">
                            <h3 style="color: var(--text-primary); margin-bottom: 8px; font-size: 1.5rem;">üéØ Target vs Current Allocation</h3>
                            <p style="color: var(--text-secondary); font-size: 1rem;">Compare portfolio allocation against target risk distribution</p>
                        </div>
                        
                        <!-- Target vs Current Stacked Bar Charts -->
                        <div class="allocation-charts-container" style="background: var(--bg-elevated); border-radius: 12px; padding: 30px; border: 1px solid var(--border-primary);">
                            <div class="chart-container" style="position: relative; height: 400px;">
                                <canvas id="targetVsCurrentChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Asset Holdings -->
                    <div class="assets-section">
                        <div class="assets-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div class="assets-header-left" style="display: flex; align-items: center; gap: 15px;">
                                <div class="assets-title">Assets</div>
                                <div class="assets-count" id="assetsCount">0 assets</div>
                        </div>
                            <div class="assets-header-right">
                                <button class="btn btn-primary" onclick="window.openAddAssetModal()" style="padding: 10px 20px; font-size: 0.9rem;">
                                    <span style="margin-right: 8px;">+</span>Add Asset
                                </button>
                    </div>
                        </div>
                        
                        <div class="assets-table-container">
                            <div class="assets-table-header">
                                <div class="asset-col-asset">Asset</div>
                                <div class="asset-col-chain">Chain</div>
                                <div class="asset-col-quantity">Quantity</div>
                                <div class="asset-col-risk">Risk</div>
                                <div class="asset-col-location">Location</div>
                                <div class="asset-col-cointype">Type</div>
                                <div class="asset-col-price">Price</div>
                                <div class="asset-col-value">Value</div>
                                <div class="asset-col-actions">Actions</div>
                </div>

                            <div class="assets-table-body" id="portfolioTableBody">
                                <!-- Portfolio data will be loaded here dynamically -->
                                <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                    <div style="font-size: 2rem; margin-bottom: 16px;">üìä</div>
                                    <div style="font-size: 1.1rem; margin-bottom: 8px;">Loading portfolio...</div>
                                    <div style="font-size: 0.9rem;">Fetching data from Google Sheets</div>
                        </div>
                    </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Tab -->
            <div id="performance" class="tab-content">
                <div class="performance-header">
                    <h2>Performance Analytics</h2>
                    <div class="date-filters">
                        <select id="periodFilter">
                            <option value="1M">1 Month</option>
                            <option value="3M">3 Months</option>
                            <option value="6M">6 Months</option>
                            <option value="1Y" selected>1 Year</option>
                            <option value="ALL">All Time</option>
                        </select>
                    </div>
                </div>
                <div class="performance-grid">
                    <div class="card">
                        <h3>Fund Performance</h3>
                        <div class="performance-metrics">
                            <div class="metric">
                                <span class="metric-label">Net Inflows</span>
                                <span class="metric-value" id="netInflows">$0.00</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Capital Appreciation</span>
                                <span class="metric-value" id="capitalAppreciation">$0.00</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Cumulative Return</span>
                                <span class="metric-value" id="cumulativeReturn">0.00%</span>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Monthly Performance</h3>
                        <div class="chart-container">
                            <canvas id="monthlyPerformanceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            </main>
        </div>

        <!-- Investor View -->
        <div id="investorView" class="view-container" style="display: none;">
            <!-- Header -->
            <header class="header">
                <div class="header-content">
                    <div class="header-left">
                        <h1>üìä Investment Portal</h1>
                        <span class="view-badge investor">Investor View</span>
                        <span id="investorNameDisplay" class="investor-name"></span>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="window.backToLogin()">Switch Account</button>
                    </div>
                    <div class="header-stats">
                        <div class="stat-card">
                            <span class="stat-label">My Investment</span>
                            <span class="stat-value" id="myInvestmentValue">$0.00</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-label">Total Return</span>
                            <span class="stat-value" id="myTotalReturn">0.00%</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-label">Share Holdings</span>
                            <span class="stat-value" id="myShareHoldings">0.00%</span>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Investor Navigation -->
            <nav class="nav">
                <button class="nav-btn active" data-tab="investor-summary">Summary</button>
                <button class="nav-btn" data-tab="investor-performance">Performance</button>
                <button class="nav-btn" data-tab="investor-statements">Statements</button>
            </nav>

            <!-- Investor Main Content -->
            <main class="main">
                <!-- Investor Summary Tab -->
                <div id="investor-summary" class="tab-content active">
                    <div class="investor-dashboard-grid">
                        <!-- Personal Investment Summary -->
                        <section class="card investor-summary-card">
                            <h2>My Investment Summary</h2>
                            <div id="personalSummary" class="personal-summary">
                                <!-- Personal summary will be generated here -->
                            </div>
                        </section>

                        <!-- Portfolio Allocation (My Share) -->
                        <section class="card">
                            <h2>My Portfolio Allocation</h2>
                            <div class="chart-container">
                                <canvas id="myAllocationChart"></canvas>
                            </div>
                        </section>

                        <!-- Investment History -->
                        <section class="card">
                            <h2>My Investment History</h2>
                            <div id="myTransactionHistory" class="transaction-history">
                                <!-- Personal transaction history will be shown here -->
                            </div>
                        </section>

                        <!-- Performance Overview -->
                        <section class="card">
                            <h2>Performance Overview</h2>
                            <div class="chart-container">
                                <canvas id="myPerformanceChart"></canvas>
                            </div>
                        </section>
                    </div>
                </div>

                <!-- Investor Performance Tab -->
                <div id="investor-performance" class="tab-content">
                    <div class="performance-grid">
                        <div class="card">
                            <h2>Detailed Performance Metrics</h2>
                            <div class="investor-metrics">
                                <div class="metric-row">
                                    <span class="metric-label">Initial Investment Date</span>
                                    <span class="metric-value" id="myInvestmentDate">-</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Days Invested</span>
                                    <span class="metric-value" id="myDaysInvested">-</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Capital Appreciation</span>
                                    <span class="metric-value" id="myCapitalAppreciation">$0.00</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Annualized Return</span>
                                    <span class="metric-value" id="myAnnualizedReturn">0.00%</span>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <h2>Performance vs Fund</h2>
                            <div class="chart-container">
                                <canvas id="myVsFundChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Investor Statements Tab -->
                <div id="investor-statements" class="tab-content">
                    <div class="statements-grid">
                        <div class="card">
                            <h2>Investment Statement</h2>
                            <div class="statement-actions">
                                <button class="btn btn-primary" onclick="app.generateStatement()">Generate PDF Statement</button>
                                <button class="btn btn-secondary" onclick="app.exportData()">Export Data</button>
                            </div>
                            <div id="investmentStatement" class="statement-content">
                                <!-- Statement content will be generated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Modals -->
        
        <!-- Investor Details Modal -->
        <div id="investorDetailsModal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <span class="close">&times;</span>
                <h2 id="investorDetailsTitle">Investor Details</h2>
                
                <!-- Investor Summary -->
                <div class="investor-summary" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <strong>Investor ID:</strong>
                            <div id="detailInvestorId">-</div>
                    </div>
                        <div>
                            <strong>Name:</strong>
                            <div id="detailInvestorName">-</div>
                    </div>
                        <div>
                            <strong>Join Date:</strong>
                            <div id="detailJoinDate">-</div>
                    </div>
                        <div>
                            <strong>Total Investment:</strong>
                            <div id="detailTotalInvestment">-</div>
                    </div>
                        <div>
                            <strong>Current Value:</strong>
                            <div id="detailCurrentValue">-</div>
                        </div>
                        <div>
                            <strong>Total Return:</strong>
                            <div id="detailTotalReturn">-</div>
                </div>
            </div>
        </div>

                <!-- Transaction History -->
                <h3>Transaction History</h3>
                <div class="table-container">
                    <table id="investorTransactionsTable" class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="investorTransactionsBody">
                            <!-- Transactions will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="form-actions" style="margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="window.closeInvestorModal()">Close</button>
                </div>
            </div>
        </div>

        <!-- Add Asset Modal -->
        <div id="addAssetModal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <span class="close">&times;</span>
                <h2>Add New Asset</h2>
                <form id="addAssetForm">
                    <!-- Asset Search -->
                    <div class="form-group">
                        <label for="assetSearch">Search Asset</label>
                        <div class="search-container" style="position: relative;">
                            <input type="text" id="assetSearch" placeholder="Type to search (e.g., Bitcoin, Ethereum, Solana)" autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <div id="assetDropdown" class="asset-dropdown" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;">
                                <!-- Search results will appear here -->
                    </div>
                    </div>
                        <input type="hidden" id="selectedAsset" name="asset" required>
                        <input type="hidden" id="selectedAssetId" name="assetId" required>
                        <input type="hidden" id="selectedAssetSymbol" name="assetSymbol" required>
                        <input type="hidden" id="selectedAssetImage" name="assetImage" required>
                        <div id="selectedAssetInfo" style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; display: none;">
                            <!-- Selected asset info will appear here -->
                    </div>
                    </div>

                    <!-- Quantity Input -->
                    <div class="form-group">
                        <label for="assetQuantity">Quantity Owned</label>
                        <input type="number" id="assetQuantity" name="quantity" step="0.000001" min="0" placeholder="0.00" required>
                    </div>

                    <!-- Blockchain Text Field -->
                    <div class="form-group">
                        <label for="assetChain">Blockchain</label>
                        <div class="autocomplete-container">
                            <input type="text" id="assetChain" name="chain" placeholder="Enter blockchain (e.g., Ethereum, Solana, Hyperliquid)" autocomplete="off" style="width: 100%; padding: 12px; border: 2px solid var(--border-primary); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem;">
                            <div id="chainSuggestions" class="autocomplete-suggestions"></div>
                    </div>
                    </div>

                    <!-- Risk Level -->
                    <div class="form-group">
                        <label for="assetRisk">Risk Level</label>
                        <div class="autocomplete-container">
                            <input type="text" id="assetRisk" name="riskLevel" placeholder="Enter risk level (e.g., Low, Medium, High)" required autocomplete="off">
                            <div id="riskSuggestions" class="autocomplete-suggestions"></div>
            </div>
        </div>

                    <!-- Location -->
                    <div class="form-group">
                        <label for="assetLocation">Location</label>
                        <div class="autocomplete-container">
                            <input type="text" id="assetLocation" name="location" placeholder="Enter location (e.g., Phantom, Exchange, Cold Wallet)" required autocomplete="off">
                            <div id="locationSuggestions" class="autocomplete-suggestions"></div>
                    </div>
                    </div>

                    <!-- Coin Type -->
                    <div class="form-group">
                        <label for="assetCoinType">Coin Type</label>
                        <div class="autocomplete-container">
                            <input type="text" id="assetCoinType" name="coinType" placeholder="Enter coin type (e.g., Memecoin, Major, Altcoin)" required autocomplete="off">
                            <div id="coinTypeSuggestions" class="autocomplete-suggestions"></div>
                    </div>
                    </div>



                    <!-- Value Preview -->
                    <div class="form-group">
                        <label>Estimated Value</label>
                        <div id="valuePreview" style="padding: 15px; background: #e3f2fd; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #1976d2;">$0.00</div>
                            <div style="font-size: 0.9rem; color: #7f8c8d;">Live price will be fetched automatically</div>
                    </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="window.closeAddAssetModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Asset</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ===================================================================
        // WAGMI INVESTMENT MANAGER - MAIN APPLICATION SCRIPT
        // ===================================================================
        // This script contains all the JavaScript functionality for the
        // crypto investment management application including:
        // - Tab navigation and UI management
        // - Google Sheets API integration  
        // - Portfolio data processing and display
        // - Asset management (add/edit/delete)
        // - Chart generation and visualization
        // - Autocomplete and form handling
        // ===================================================================
        
        console.log('üöÄ WAGMI Investment Manager - Initializing...');
        
        // Simple test to verify basic JS functionality
        window.simpleTest = function() {
            console.log('‚úÖ Simple test function called');
            alert('Simple test works!');
        };
        
        // Minimal navigation functions inline
        window.testScript = function() {
            console.log('‚úÖ Test Script called');
            alert('Test Script works!');
        };
        
        window.debugApp = function() {
            console.log('üîç App debug info logged to console');
            console.log('Elements:', {
                managerPortalBtn: !!document.getElementById('managerPortalBtn'),
                loginScreen: !!document.getElementById('loginScreen'),
                managerView: !!document.getElementById('managerView')
            });
        };
        
        // Simple navigation function
        window.enterManagerView = function() {
            console.log('üîß Entering Manager View (inline)...');
            
            const loginScreen = document.getElementById('loginScreen');
            const managerView = document.getElementById('managerView');
            
            if (loginScreen && managerView) {
                loginScreen.style.display = 'none';
                managerView.style.display = 'block';
                
                // Initialize dashboard tab and load data
                setTimeout(() => {
                    window.switchTab('dashboard');
                    console.log('‚úÖ Manager view loaded with dashboard data');
                }, 100);
                
                console.log('‚úÖ Successfully switched to manager view');
            } else {
                console.error('‚ùå Could not find required elements');
                alert('Error: Could not find required elements');
            }
        };
        
        // Make it available globally for button clicks
        window.app = {
            enterManagerView: window.enterManagerView
        };
        
        // ===================================================================
        // TAB NAVIGATION & UI MANAGEMENT
        // ===================================================================
        
        // Tab navigation function
        window.switchTab = function(tabName) {
            console.log('üîÑ Switching to tab:', tabName);
            
            // Update nav buttons
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => btn.classList.remove('active'));
            const targetBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (targetBtn) targetBtn.classList.add('active');
            
            // Update tab content
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            const targetTab = document.getElementById(tabName);
            if (targetTab) targetTab.classList.add('active');
            
            // Load basic data for the tab
            if (tabName === 'dashboard') {
                window.loadDashboardData();
            } else if (tabName === 'investors') {
                window.loadInvestorsData();
            } else if (tabName === 'portfolio') {
                window.loadPortfolioData();
            } else if (tabName === 'performance') {
                window.loadPerformanceData();
            }
        };
        
        // ===================================================================
        // GOOGLE SHEETS API INTEGRATION
        // ===================================================================
        
        // Google Sheets configuration
        const SPREADSHEET_ID = '1h04nkcnQmxaFml8RubIGmPgffMiyoEIg350ryjXK0tM';
        const API_KEY = 'AIzaSyAWXECv5w1HjPmWcTnEqifMifJk-kKeEDA';
        
        // Function to fetch live data from Google Sheets
        window.fetchLiveInvestorData = async function() {
            try {
                console.log('üìä Fetching live investor data from Google Sheets...');
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Investors!A:G?key=${API_KEY}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.values && data.values.length > 1) {
                    console.log('‚úÖ Successfully fetched live investor data');
                    return data.values.slice(1); // Skip header row
                } else {
                    console.error('‚ùå No investor data found');
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Error fetching investor data:', error);
                return null;
            }
        };
        
        // Function to fetch live transactions data
        window.fetchLiveTransactionData = async function() {
            try {
                console.log('üí∞ Fetching live transaction data from Google Sheets...');
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Transactions!A:F?key=${API_KEY}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.values && data.values.length > 1) {
                    console.log('‚úÖ Successfully fetched live transaction data');
                    return data.values.slice(1); // Skip header row
                } else {
                    console.error('‚ùå No transaction data found');
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Error fetching transaction data:', error);
                return null;
            }
        };
        
        // Basic data loading functions
        window.loadDashboardData = async function() {
            console.log('üìä Loading dashboard data...');
            
            // Try to load live data first
            const liveInvestorData = await window.fetchLiveInvestorData();
            if (liveInvestorData) {
                window.updateSummaryDashboard(liveInvestorData);
                window.displayLiveInvestorData(liveInvestorData);
                return;
            }
            
            // Fallback to hardcoded data if live data fails
            console.log('‚ö†Ô∏è Using fallback data');
            window.updateSummaryDashboard(null); // Update with fallback data
            window.displayFallbackData();
        };
        
        // Function to calculate and update summary dashboard
        window.updateSummaryDashboard = function(investorData) {
            console.log('üìä Updating summary dashboard...');
            console.log('üìä Investor data received:', investorData?.length, 'rows');
            
            if (!investorData || investorData.length <= 1) {
                // Use fallback data for all tabs (Dashboard, Investors, Portfolio)
                const fallbackTotalInvested = 26906;
                const fallbackCurrentValue = 31002;
                const fallbackTotalPnL = fallbackCurrentValue - fallbackTotalInvested; // $4,096
                
                // Dashboard tab
                document.getElementById('summaryTotalInvestors').textContent = '6';
                document.getElementById('summaryTotalInvested').textContent = '$26,906';
                document.getElementById('summaryCurrentValue').textContent = '$31,002';
                document.getElementById('summaryTotalPnL').textContent = `+$${fallbackTotalPnL.toLocaleString()}`;
                document.getElementById('summaryMonthlyReturn').textContent = '+2.8%';
                
                // Investors tab
                document.getElementById('investorsSummaryTotalInvestors').textContent = '6';
                document.getElementById('investorsSummaryTotalInvested').textContent = '$26,906';
                document.getElementById('investorsSummaryCurrentValue').textContent = '$31,002';
                document.getElementById('investorsSummaryTotalPnL').textContent = `+$${fallbackTotalPnL.toLocaleString()}`;
                document.getElementById('investorsSummaryMonthlyReturn').textContent = '+2.8%';
                
                // Portfolio tab
                document.getElementById('portfolioSummaryTotalInvestors').textContent = '6';
                document.getElementById('portfolioSummaryTotalInvested').textContent = '$26,906';
                document.getElementById('portfolioSummaryCurrentValue').textContent = '$31,002';
                document.getElementById('portfolioSummaryTotalPnL').textContent = `+$${fallbackTotalPnL.toLocaleString()}`;
                document.getElementById('portfolioSummaryMonthlyReturn').textContent = '+2.8%';
                
                // Update timestamps for fallback data as well
                const currentTime = new Date().toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric', 
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
                
                const timestampElements = ['dashboardLastUpdated', 'investorsLastUpdated', 'portfolioLastUpdated'];
                timestampElements.forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.textContent = `Data last updated: ${currentTime} (Fallback)`;
                    }
                });
                
                return;
            }
            
            let totalInvestors = 0;
            let totalInvested = 0;
            let totalCurrentValue = 0;
            
            // Process data (header already skipped in fetchLiveInvestorData)
            for (let i = 0; i < investorData.length; i++) {
                const row = investorData[i];
                if (row && row.length >= 5) {
                    const investmentValue = parseFloat(row[4]?.replace(/[$,]/g, '')) || 0;
                    const currentValue = parseFloat(row[5]?.replace(/[$,]/g, '')) || 0;
                    
                    if (investmentValue > 0) {
                        totalInvestors++;
                        totalInvested += investmentValue;
                        totalCurrentValue += currentValue;
                    }
                }
            }
            
            // Calculate returns and P&L
            const totalPnL = totalCurrentValue - totalInvested;
            const cumulativeReturn = totalInvested > 0 ? ((totalCurrentValue - totalInvested) / totalInvested * 100) : 0;
            const monthlyReturn = 2.8; // Sample monthly return - in real app, this would be calculated from historical data
            
            // Update summary dashboard (Dashboard tab)
            document.getElementById('summaryTotalInvestors').textContent = totalInvestors.toString();
            document.getElementById('summaryTotalInvested').textContent = `$${Math.round(totalInvested).toLocaleString()}`;
            document.getElementById('summaryCurrentValue').textContent = `$${Math.round(totalCurrentValue).toLocaleString()}`;
            
            // Update Total P&L with proper styling
            const summaryPnLElement = document.getElementById('summaryTotalPnL');
            const pnlSign = totalPnL >= 0 ? '+' : '';
            summaryPnLElement.textContent = `${pnlSign}$${Math.round(Math.abs(totalPnL)).toLocaleString()}`;
            summaryPnLElement.className = totalPnL >= 0 ? 'metric-value positive' : 'metric-value negative';
            
            // Update monthly return with proper styling
            const monthlyElement = document.getElementById('summaryMonthlyReturn');
            const monthlySign = monthlyReturn >= 0 ? '+' : '';
            monthlyElement.textContent = `${monthlySign}${monthlyReturn.toFixed(1)}%`;
            monthlyElement.className = monthlyReturn >= 0 ? 'positive' : 'negative';

            // Update summary dashboard (Investors tab) - same data
            document.getElementById('investorsSummaryTotalInvestors').textContent = totalInvestors.toString();
            document.getElementById('investorsSummaryTotalInvested').textContent = `$${Math.round(totalInvested).toLocaleString()}`;
            document.getElementById('investorsSummaryCurrentValue').textContent = `$${Math.round(totalCurrentValue).toLocaleString()}`;
            
            // Update Investors tab Total P&L
            const investorsPnLElement = document.getElementById('investorsSummaryTotalPnL');
            investorsPnLElement.textContent = `${pnlSign}$${Math.round(Math.abs(totalPnL)).toLocaleString()}`;
            investorsPnLElement.className = totalPnL >= 0 ? 'metric-value positive' : 'metric-value negative';
            
            const investorsMonthlyElement = document.getElementById('investorsSummaryMonthlyReturn');
            investorsMonthlyElement.textContent = `${monthlySign}${monthlyReturn.toFixed(1)}%`;
            investorsMonthlyElement.className = monthlyReturn >= 0 ? 'positive' : 'negative';
            
            // Update Portfolio tab - same data
            document.getElementById('portfolioSummaryTotalInvestors').textContent = totalInvestors.toString();
            document.getElementById('portfolioSummaryTotalInvested').textContent = `$${Math.round(totalInvested).toLocaleString()}`;
            document.getElementById('portfolioSummaryCurrentValue').textContent = `$${Math.round(totalCurrentValue).toLocaleString()}`;
            
            // Update Portfolio tab Total P&L
            const portfolioPnLElement = document.getElementById('portfolioSummaryTotalPnL');
            portfolioPnLElement.textContent = `${pnlSign}$${Math.round(Math.abs(totalPnL)).toLocaleString()}`;
            portfolioPnLElement.className = totalPnL >= 0 ? 'metric-value positive' : 'metric-value negative';
            
            const portfolioMonthlyElement = document.getElementById('portfolioSummaryMonthlyReturn');
            portfolioMonthlyElement.textContent = `${monthlySign}${monthlyReturn.toFixed(1)}%`;
            portfolioMonthlyElement.className = monthlyReturn >= 0 ? 'positive' : 'negative';
            
            console.log(`üìä Summary updated: ${totalInvestors} investors, $${totalInvested.toLocaleString()} invested, ${totalPnL >= 0 ? '+' : ''}$${Math.abs(totalPnL).toLocaleString()} P&L`);
            
            // Update "Data last updated" timestamps across all tabs
            const currentTime = new Date().toLocaleString('en-US', {
                month: 'short',
                day: 'numeric', 
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
            
            const timestampElements = [
                'dashboardLastUpdated',
                'investorsLastUpdated', 
                'portfolioLastUpdated'
            ];
            
            timestampElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = `Data last updated: ${currentTime}`;
                }
            });
            console.log('üìä Processed rows:', investorData.length, 'investors found:', totalInvestors);
        };

        // Function to display live investor data
        window.displayLiveInvestorData = function(investorData) {
            console.log('üìä Displaying live investor data:', investorData);
            
            // Calculate totals from live data
            let totalAUM = 0;
            let totalInitial = 0;
            
            // Update header stats
            const totalAUMElement = document.getElementById('totalAUM');
            const totalReturnElement = document.getElementById('totalReturn');
            const activeInvestorsElement = document.getElementById('activeInvestors');
            
            // Process investor data and build summaries
            const summariesContainer = document.getElementById('investmentSummaries');
            if (summariesContainer) {
                let summariesHTML = '';
                
                investorData.forEach(row => {
                    const investorId = row[0] || '';
                    const name = row[1] || '';
                    const email = row[2] || '';
                    const joinDate = row[3] || '';
                    const investmentValue = parseFloat(row[4]?.replace(/[$,]/g, '')) || 0;
                    const currentValue = parseFloat(row[5]?.replace(/[$,]/g, '')) || 0;
                    const sharePercentage = parseFloat(row[6]?.replace('%', '')) || 0;
                    
                    totalInitial += investmentValue;
                    totalAUM += currentValue;
                    
                    const totalReturn = investmentValue > 0 ? ((currentValue - investmentValue) / investmentValue * 100) : 0;
                    
                    summariesHTML += `
                        <div class="summary-card">
                            <div class="summary-header">${name} (${investorId})</div>
                            <div class="summary-row">
                                <span class="summary-label">Initial Investment</span>
                                <span class="summary-value">$${investmentValue.toLocaleString()}</span>
                    </div>
                            <div class="summary-row">
                                <span class="summary-label">Current Value</span>
                                <span class="summary-value">$${currentValue.toLocaleString()}</span>
                    </div>
                            <div class="summary-row">
                                <span class="summary-label">Total Return</span>
                                <span class="summary-value ${totalReturn >= 0 ? 'positive' : 'negative'}">${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(1)}%</span>
                    </div>
                            <div class="summary-row">
                                <span class="summary-label">Share Holding</span>
                                <span class="summary-value">${sharePercentage.toFixed(1)}%</span>
                    </div>
            </div>
                    `;
                });
                
                summariesContainer.innerHTML = summariesHTML;
            }
            
            // Update header stats with calculated values
            const overallReturn = totalInitial > 0 ? ((totalAUM - totalInitial) / totalInitial * 100) : 0;
            
            if (totalAUMElement) totalAUMElement.textContent = `$${totalAUM.toLocaleString()}`;
            if (totalReturnElement) totalReturnElement.textContent = `${overallReturn.toFixed(1)}%`;
            if (activeInvestorsElement) activeInvestorsElement.textContent = investorData.length.toString();
            
            // Also load live transactions
            window.loadLiveTransactions();
        };
        
        // Function to load live transactions
        window.loadLiveTransactions = async function() {
            const transactionData = await window.fetchLiveTransactionData();
            if (transactionData) {
                const transactionsContainer = document.getElementById('recentTransactions');
                if (transactionsContainer) {
                    let transactionsHTML = '';
                    
                    // Show last 5 transactions
                    const recentTransactions = transactionData.slice(-5).reverse();
                    
                    recentTransactions.forEach(row => {
                        const investorId = row[1] || '';
                        const type = row[2] || 'Investment';
                        const amount = parseFloat(row[3]) || 0;
                        const date = row[4] || '';
                        
                        transactionsHTML += `
                            <div class="transaction-item">
                                <div class="transaction-info">
                                    <div class="transaction-type">${type} - ${investorId}</div>
                                    <div class="transaction-date">${date}</div>
        </div>
                                <div class="transaction-amount ${type === 'Investment' ? 'positive' : 'negative'}">$${amount.toLocaleString()}</div>
    </div>
                        `;
                    });
                    
                    transactionsContainer.innerHTML = transactionsHTML;
                }
            }
        };
        
        // Fallback function with hardcoded data
        window.displayFallbackData = function() {
            // Update header stats with sample data
            const totalAUM = document.getElementById('totalAUM');
            const totalReturn = document.getElementById('totalReturn');
            const activeInvestors = document.getElementById('activeInvestors');
            
            if (totalAUM) totalAUM.textContent = '$26,906.30';
            if (totalReturn) totalReturn.textContent = '15.2%';
            if (activeInvestors) activeInvestors.textContent = '6';
            
            // Add complete investment summaries for all 6 investors
            const summariesContainer = document.getElementById('investmentSummaries');
            if (summariesContainer) {
                summariesContainer.innerHTML = `
                    <div class="summary-card">
                        <div class="summary-header">Leke Karunwi (LK1)</div>
                        <div class="summary-row">
                            <span class="summary-label">Initial Investment</span>
                            <span class="summary-value">$2,000.00</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Current Value</span>
                            <span class="summary-value">$2,304.00</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Total Return</span>
                            <span class="summary-value positive">+15.2%</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Share Holding</span>
                            <span class="summary-value">7.4%</span>
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-header">Mariam Oyawoye (MO2)</div>
                        <div class="summary-row">
                            <span class="summary-label">Initial Investment</span>
                            <span class="summary-value">$1,050.06</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Current Value</span>
                            <span class="summary-value">$1,209.67</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Total Return</span>
                            <span class="summary-value positive">+15.2%</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Share Holding</span>
                            <span class="summary-value">3.9%</span>
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-header">Fifehanmi Oyawoye (FO3)</div>
                        <div class="summary-row">
                            <span class="summary-label">Initial Investment</span>
                            <span class="summary-value">$1,823.91</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Current Value</span>
                            <span class="summary-value">$2,101.14</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Total Return</span>
                            <span class="summary-value positive">+15.2%</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Share Holding</span>
                            <span class="summary-value">6.8%</span>
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-header">Rinsola Aminu (RA4)</div>
                        <div class="summary-row">
                            <span class="summary-label">Initial Investment</span>
                            <span class="summary-value">$828.30</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Current Value</span>
                            <span class="summary-value">$954.20</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Total Return</span>
                            <span class="summary-value positive">+15.2%</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Share Holding</span>
                            <span class="summary-value">3.1%</span>
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-header">Oyinkan Karunwi (OK5)</div>
                        <div class="summary-row">
                            <span class="summary-label">Initial Investment</span>
                            <span class="summary-value">$991.57</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Current Value</span>
                            <span class="summary-value">$1,142.65</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Total Return</span>
                            <span class="summary-value positive">+15.2%</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Share Holding</span>
                            <span class="summary-value">3.7%</span>
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-header">Omair Ansari (OA6)</div>
                        <div class="summary-row">
                            <span class="summary-label">Initial Investment</span>
                            <span class="summary-value">$20,212.46</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Current Value</span>
                            <span class="summary-value">$23,284.51</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Total Return</span>
                            <span class="summary-value positive">+15.2%</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Share Holding</span>
                            <span class="summary-value">75.1%</span>
                        </div>
                    </div>
                `;
            }
            
            // Add recent transactions from database
            const transactionsContainer = document.getElementById('recentTransactions');
            if (transactionsContainer) {
                transactionsContainer.innerHTML = `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-type">Investment - OA6</div>
                            <div class="transaction-date">2024-06-15</div>
                        </div>
                        <div class="transaction-amount positive">$10,018.76</div>
                    </div>
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-type">Investment - RA4</div>
                            <div class="transaction-date">2024-02-10</div>
                        </div>
                        <div class="transaction-amount positive">$685.33</div>
                    </div>
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-type">Investment - OA6</div>
                            <div class="transaction-date">2023-11-28</div>
                        </div>
                        <div class="transaction-amount positive">$8,774.88</div>
                    </div>
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-type">Investment - OA6</div>
                            <div class="transaction-date">2023-11-26</div>
                        </div>
                        <div class="transaction-amount positive">$1,418.82</div>
                    </div>
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-type">Investment - OK5</div>
                            <div class="transaction-date">2023-11-19</div>
                        </div>
                        <div class="transaction-amount positive">$991.57</div>
                    </div>
                `;
            }
        };
        
        window.loadInvestorsData = async function() {
            console.log('üë• Loading investors data...');
            
            // Try to load live data first
            console.log('üîç Attempting to fetch live investor data...');
            const liveInvestorData = await window.fetchLiveInvestorData();
            console.log('üìä Live investor data result:', liveInvestorData);
            
            if (liveInvestorData && liveInvestorData.length > 0) {
                console.log('‚úÖ Using live investor data with dynamic date calculation');
                window.updateSummaryDashboard(liveInvestorData); // Update summary widget
                await window.displayLiveInvestorsTable(liveInvestorData);
                return;
            }
            
            // Fallback to hardcoded data with dynamic date calculation
            console.log('‚ö†Ô∏è No live data available, using fallback investor table data with dynamic dates');
            window.updateSummaryDashboard(null); // Update summary with fallback data
            await window.displayFallbackInvestorsWithDynamicDates();
        };
        
        // Function to display fallback investors with dynamic date calculation
        window.displayFallbackInvestorsWithDynamicDates = async function() {
            console.log('üìä Displaying fallback investors with dynamic date calculation');
            
            const investorsTableBody = document.getElementById('investorsTableBody');
            if (!investorsTableBody) return;
            
            // Show loading state
            investorsTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: #7f8c8d;">Loading fallback investor data and calculating join dates...</td></tr>';
            
            // Hardcoded investor data
            const fallbackInvestors = [
                { id: 'LK1', name: 'Leke Karunwi', investment: 2000, current: 2304, share: 7.4 },
                { id: 'MO2', name: 'Mariam Oyawoye', investment: 1050.06, current: 1209.67, share: 3.9 },
                { id: 'FO3', name: 'Fifehanmi Oyawoye', investment: 1823.91, current: 2101.14, share: 6.8 },
                { id: 'RA4', name: 'Rinsola Aminu', investment: 828.30, current: 954.20, share: 3.1 },
                { id: 'OK5', name: 'Oyinkan Karunwi', investment: 991.57, current: 1142.65, share: 3.7 },
                { id: 'OA6', name: 'Omair Ansari', investment: 20212.46, current: 23284.51, share: 75.1 }
            ];
            
            let tableHTML = '';
            
            for (const investor of fallbackInvestors) {
                console.log(`üîç Processing fallback investor ${investor.id} (${investor.name})`);
                
                // Get earliest transaction date for this investor
                const transactions = await window.fetchInvestorTransactions(investor.id);
                console.log(`üìÖ Found ${transactions?.length || 0} transactions for ${investor.id}:`, transactions);
                
                let earliestDate = null;
                
                if (transactions && transactions.length > 0) {
                    // Find the earliest transaction date
                    earliestDate = transactions.reduce((earliest, transaction) => {
                        const transactionDate = new Date(transaction.date);
                        console.log(`üìÖ Comparing dates for ${investor.id}: ${transaction.date} (${transactionDate})`);
                        return !earliest || transactionDate < earliest ? transactionDate : earliest;
                    }, null);
                    console.log(`‚úÖ Earliest date for ${investor.id}: ${earliestDate}`);
                } else {
                    console.log(`‚ö†Ô∏è No transactions found for ${investor.id}, using fallback date`);
                }
                
                // Format the join date (earliest transaction date)
                const formattedDate = earliestDate ? 
                    earliestDate.toLocaleDateString('en-US', {
                        month: '2-digit',
                        day: '2-digit',
                        year: 'numeric'
                    }) : 'N/A';
                
                console.log(`üìÖ Final formatted date for ${investor.id}: ${formattedDate}`);
                
                const totalReturn = investor.investment > 0 ? ((investor.current - investor.investment) / investor.investment * 100) : 0;
                
                tableHTML += `
                    <tr onclick="window.showInvestorDetails('${investor.id}', '${investor.name}', '${formattedDate}', ${investor.investment}, ${investor.current}, ${totalReturn})" style="cursor: pointer;" title="Click to view transaction history">
                        <td><strong>${investor.id}</strong></td>
                        <td>${investor.name}</td>
                        <td style="white-space: nowrap;">${formattedDate}</td>
                        <td>$${investor.investment.toLocaleString()}</td>
                        <td>$${investor.current.toLocaleString()}</td>
                        <td class="${totalReturn >= 0 ? 'positive' : 'negative'}">${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(1)}%</td>
                        <td>${investor.share.toFixed(1)}%</td>
                        <td>
                            <small style="color: #666;">üìä Details</small>
                        </td>
                    </tr>
                `;
            }
            
            console.log('‚úÖ Finished processing all fallback investors, updating table');
            investorsTableBody.innerHTML = tableHTML;
        };
        
        // Function to display live investors table
        window.displayLiveInvestorsTable = async function(investorData) {
            console.log('üë• Displaying live investors table:', investorData);
            console.log('üìä Processing investors with dynamic date calculation...');
            
            const investorsTableBody = document.getElementById('investorsTableBody');
            if (investorsTableBody) {
                // Show loading state while processing
                investorsTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: #7f8c8d;">Loading investor data and calculating join dates...</td></tr>';
                
                let tableHTML = '';
                
                // Process each investor and get their earliest transaction date
                for (const row of investorData) {
                    const investorId = row[0] || '';
                    const name = row[1] || '';
                    const email = row[2] || '';
                    const investmentValue = parseFloat(row[4]?.replace(/[$,]/g, '')) || 0;
                    const currentValue = parseFloat(row[5]?.replace(/[$,]/g, '')) || 0;
                    const sharePercentage = parseFloat(row[6]?.replace('%', '')) || 0;
                    
                    console.log(`üîç Processing investor ${investorId} (${name})`);
                    
                    // Get earliest transaction date for this investor
                    const transactions = await window.fetchInvestorTransactions(investorId);
                    console.log(`üìÖ Found ${transactions?.length || 0} transactions for ${investorId}:`, transactions);
                    
                    let earliestDate = null;
                    
                    if (transactions && transactions.length > 0) {
                        // Find the earliest transaction date
                        earliestDate = transactions.reduce((earliest, transaction) => {
                            const transactionDate = new Date(transaction.date);
                            console.log(`üìÖ Comparing dates for ${investorId}: ${transaction.date} (${transactionDate})`);
                            return !earliest || transactionDate < earliest ? transactionDate : earliest;
                        }, null);
                        console.log(`‚úÖ Earliest date for ${investorId}: ${earliestDate}`);
                    } else {
                        console.log(`‚ö†Ô∏è No transactions found for ${investorId}, using fallback`);
                    }
                    
                    // Format the join date (earliest transaction date)
                    const formattedDate = earliestDate ? 
                        earliestDate.toLocaleDateString('en-US', {
                            month: '2-digit',
                            day: '2-digit',
                            year: 'numeric'
                        }) : 'N/A';
                    
                    console.log(`üìÖ Final formatted date for ${investorId}: ${formattedDate}`);
                    
                    const totalReturn = investmentValue > 0 ? ((currentValue - investmentValue) / investmentValue * 100) : 0;
                    
                    tableHTML += `
                        <tr onclick="window.showInvestorDetails('${investorId}', '${name}', '${formattedDate}', ${investmentValue}, ${currentValue}, ${totalReturn})" style="cursor: pointer;" title="Click to view transaction history">
                            <td><strong>${investorId}</strong></td>
                            <td>${name}</td>
                            <td style="white-space: nowrap;">${formattedDate}</td>
                            <td>$${investmentValue.toLocaleString()}</td>
                            <td>$${currentValue.toLocaleString()}</td>
                            <td class="${totalReturn >= 0 ? 'positive' : 'negative'}">${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(1)}%</td>
                            <td>${sharePercentage.toFixed(1)}%</td>
                            <td>
                                <small style="color: #666;">üìä Details</small>
                            </td>
                        </tr>
                    `;
                }
                
                console.log('‚úÖ Finished processing all investors, updating table');
                investorsTableBody.innerHTML = tableHTML;
            }
        };
        
        window.loadPortfolioData = async function() {
            console.log('üíº Loading portfolio data...');
            
            try {
                // First, load the same summary data that Dashboard and Investor tabs use
                const liveInvestorData = await window.fetchLiveInvestorData();
                if (liveInvestorData) {
                    window.updateSummaryDashboard(liveInvestorData);
                } else {
                    window.updateSummaryDashboard(null); // Use fallback data
                }
                
                // Then fetch and display portfolio-specific data
                const portfolioData = await window.fetchPortfolioData();
                
                if (portfolioData && portfolioData.length > 0) {
                    console.log('‚úÖ Using live portfolio data from database');
                    await window.displayPortfolioData(portfolioData);
                } else {
                    console.log('‚ö†Ô∏è No portfolio data found, showing empty state');
                    window.displayEmptyPortfolio();
                }
            } catch (error) {
                console.error('‚ùå Error loading portfolio data:', error);
                window.displayEmptyPortfolio();
                // Still update summary with fallback data even if portfolio data fails
                window.updateSummaryDashboard(null);
            }
        };

        // Function to display portfolio data from database
        window.displayPortfolioData = async function(portfolioData) {
            console.log('üíº Displaying portfolio data:', portfolioData);
            
            const portfolioTableBody = document.getElementById('portfolioTableBody');
            if (!portfolioTableBody) return;
            
            // Update autocomplete data from the portfolio
            window.updateAutocompleteData(portfolioData);
            
            // Sort portfolio data by total value in descending order (highest to lowest)
            const sortedPortfolioData = portfolioData.slice().sort((a, b) => {
                const quantityA = parseFloat(a[3]) || 0;  // Column D: Quantity
                const priceA = parseFloat(a[4]) || 0;     // Column E: Current Price
                const valueA = quantityA * priceA;
                
                const quantityB = parseFloat(b[3]) || 0;  // Column D: Quantity
                const priceB = parseFloat(b[4]) || 0;     // Column E: Current Price
                const valueB = quantityB * priceB;
                
                return valueB - valueA; // Descending order (largest first)
            });
            
            console.log('üîÑ Portfolio sorted by value (highest to lowest)');
            
            let assetsHTML = '';
            let totalPortfolioValue = 0;
            
            console.log('üíº Calculating portfolio values...');
            
            sortedPortfolioData.forEach((row, rowIndex) => {
                const assetName = row[0] || '';        // Column A: Asset Name
                const symbol = row[1] || '';           // Column B: Symbol
                const chain = row[2] || '';            // Column C: Chain
                const quantity = parseFloat(row[3]) || 0;    // Column D: Quantity
                const currentPrice = parseFloat(row[4]) || 0; // Column E: Current Price
                const totalValue = parseFloat(row[5]) || 0;   // Column F: Total Value
                const imageUrl = row[6] || '';         // Column G: Image URL
                const riskLevel = row[7] || '';        // Column H: Risk Level
                const location = row[8] || '';         // Column I: Location
                const coinType = row[9] || '';         // Column J: Coin Type
                
                // Calculate the real-time total value instead of using stored value
                const calculatedValue = quantity * currentPrice;
                
                // Calculate asset value and add to portfolio total
                totalPortfolioValue += calculatedValue;
                
                try {
                    // Use database image URL first, then fallback to hardcoded logos
                    let tokenLogo = imageUrl || '';
                    let fallbackSymbol = symbol.charAt(0).toUpperCase();
                    
                    // If no database image URL, use hardcoded fallbacks
                    if (!tokenLogo) {
                        const symbolLower = symbol.toLowerCase();
                        const nameLower = assetName.toLowerCase();
                        
                        switch(true) {
                            case symbolLower === 'btc' || symbolLower === 'bitcoin' || nameLower.includes('bitcoin'):
                                tokenLogo = 'https://assets.coingecko.com/coins/images/1/large/bitcoin.png';
                                fallbackSymbol = '‚Çø';
                                break;
                            case symbolLower === 'eth' || symbolLower === 'ethereum' || nameLower.includes('ethereum'):
                                tokenLogo = 'https://assets.coingecko.com/coins/images/279/large/ethereum.png';
                                fallbackSymbol = 'Œû';
                                break;
                            case symbolLower === 'ada' || symbolLower === 'cardano' || nameLower.includes('cardano'):
                                tokenLogo = 'https://assets.coingecko.com/coins/images/975/large/cardano.png';
                                fallbackSymbol = '‚Ç≥';
                                break;
                            case symbolLower === 'sol' || symbolLower === 'solana' || nameLower.includes('solana'):
                                tokenLogo = 'https://assets.coingecko.com/coins/images/4128/large/solana.png';
                                fallbackSymbol = '‚óé';
                                break;
                            case symbolLower === 'aura' || nameLower.includes('aura'):
                                tokenLogo = 'https://assets.coingecko.com/coins/images/25942/thumb/aura-logo-square.png';
                                fallbackSymbol = 'üåü';
                                break;
                            case symbolLower === 'jitosol' || symbolLower === 'jito' || nameLower.includes('jito'):
                                tokenLogo = 'https://assets.coingecko.com/coins/images/32455/small/jito.png';
                                fallbackSymbol = 'J';
                                break;
                            case symbolLower === 'mystery' || nameLower.includes('mystery'):
                                tokenLogo = 'https://assets.coingecko.com/coins/images/31967/small/mystery.png';
                                fallbackSymbol = 'M';
                                break;
                            case symbolLower === 'matic' || nameLower.includes('polygon'):
                                tokenLogo = 'https://assets.coingecko.com/coins/images/4713/large/matic-token-icon.png';
                                fallbackSymbol = 'üî∑';
                                break;
                            case symbolLower === 'avax' || nameLower.includes('avalanche'):
                                tokenLogo = 'https://assets.coingecko.com/coins/images/12559/large/coin-round-red.png';
                                fallbackSymbol = 'üî∫';
                                break;
                            case symbolLower === 'link' || nameLower.includes('chainlink'):
                                tokenLogo = 'https://assets.coingecko.com/coins/images/877/large/chainlink-new-logo.png';
                                fallbackSymbol = 'üîó';
                                break;
                            case symbolLower === 'dot' || nameLower.includes('polkadot'):
                                tokenLogo = 'https://assets.coingecko.com/coins/images/12171/large/polkadot.png';
                                fallbackSymbol = '‚óè';
                                break;
                            default:
                                tokenLogo = '';
                                fallbackSymbol = symbol.charAt(0).toUpperCase();
                                break;
                        }
                    }
                    
                    console.log(`üñºÔ∏è [DEBUG] Final logo result - URL: "${tokenLogo}", Fallback: "${fallbackSymbol}"`);
                    
                    // Create unique row identifier using symbol + location + index to handle duplicate symbols
                    const uniqueRowId = `${symbol.toLowerCase()}-${location.toLowerCase().replace(/\s+/g, '-')}-${rowIndex}`;
                    
                    assetsHTML += `
                        <div class="asset-row" data-asset-id="${uniqueRowId}" data-symbol="${symbol}" data-location="${location}">
                            <div class="asset-col-asset">
                                <div class="asset-info">
                                    <div class="asset-icon">
                                        ${tokenLogo ? 
                                            `<img src="${tokenLogo}" alt="${symbol}" onerror="this.parentElement.innerHTML='<span class=\\'fallback\\'>${fallbackSymbol}</span>'; this.parentElement.classList.add('fallback');">` : 
                                            `<span class="fallback">${fallbackSymbol}</span>`
                                        }
                                    </div>
                                    <div class="asset-details">
                                        <div class="asset-name">${assetName}</div>
                                        <div class="asset-symbol">${symbol.toUpperCase()}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="asset-col-chain">
                                <span class="chain-badge" data-chain="${chain.toLowerCase()}">${chain.toUpperCase()}</span>
                            </div>
                            <div class="asset-col-quantity">
                                <span class="quantity-display">${quantity.toLocaleString()}</span>
                                <input type="number" class="asset-quantity-input" value="${quantity}" step="0.000001" style="display: none;">
                            </div>
                            <div class="asset-col-risk">
                                <span class="risk-display">${riskLevel}</span>
                                <input type="text" class="asset-risk-input" value="${riskLevel}" style="display: none;" autocomplete="off">
                            </div>
                            <div class="asset-col-location">
                                <span class="location-display">${location}</span>
                                <input type="text" class="asset-location-input" value="${location}" style="display: none;" autocomplete="off">
                            </div>
                            <div class="asset-col-cointype">
                                <span class="cointype-display">${coinType}</span>
                                <input type="text" class="asset-cointype-input" value="${coinType}" style="display: none;" autocomplete="off">
                            </div>

                            <div class="asset-col-price">$${currentPrice.toLocaleString()}</div>
                            <div class="asset-col-value">
                                <span class="value-display">$${calculatedValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                            </div>
                            <div class="asset-col-actions">
                                <button class="asset-edit-btn" onclick="window.editAssetFields('${uniqueRowId}')">Edit</button>
                                <button class="asset-delete-btn" onclick="window.deleteAsset('${uniqueRowId}')">Delete</button>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error(`‚ùå Error processing asset ${assetName}:`, error);
                }
            });
            
            portfolioTableBody.innerHTML = assetsHTML;
            
            // Update assets count
            const assetsCount = document.getElementById('assetsCount');
            if (assetsCount) {
                assetsCount.textContent = `${portfolioData.length} assets`;
            }
            
            // Update total portfolio value
            // Update Portfolio tab overview widget
            const portfolioCurrentValueElement = document.getElementById('portfolioSummaryCurrentValue');
            if (portfolioCurrentValueElement) {
                portfolioCurrentValueElement.textContent = `$${totalPortfolioValue.toLocaleString()}`;
            }
            
            // Update legacy totalPortfolioValue element if it exists (for backwards compatibility)
            const totalValueElement = document.getElementById('totalPortfolioValue');
            if (totalValueElement) {
                totalValueElement.textContent = `$${totalPortfolioValue.toLocaleString()}`;
            }
            
            // Update other portfolio overview metrics
            const portfolioTotalInvestorsElement = document.getElementById('portfolioSummaryTotalInvestors');
            const portfolioTotalInvestedElement = document.getElementById('portfolioSummaryTotalInvested');
            const portfolioTotalGainsElement = document.getElementById('portfolioSummaryTotalGains');
            const portfolioMonthlyReturnElement = document.getElementById('portfolioSummaryMonthlyReturn');
            
            // Portfolio overview metrics are now updated by updateSummaryDashboard() with live data
            // No need for hardcoded values here since they get overridden by the live data
            
            console.log('‚úÖ Portfolio calculation completed');
            
            // Generate portfolio analysis charts with a small delay to ensure DOM is ready
            setTimeout(() => {
                window.generatePortfolioCharts(sortedPortfolioData);
            }, 100);
        };

        // Function to update portfolio summary
        window.updatePortfolioSummary = async function(portfolioData) {
            let totalValue = 0;
            
            for (const row of portfolioData) {
                const quantity = parseFloat(row[3]) || 0;    // Column D: Quantity
                const currentPrice = parseFloat(row[4]) || 0; // Column E: Current Price
                const calculatedValue = quantity * currentPrice;
                totalValue += calculatedValue;
            }
            
            // Update total portfolio value
            const totalValueElement = document.getElementById('totalPortfolioValue');
            if (totalValueElement) {
                totalValueElement.textContent = `$${totalValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }
            
            // Update last updated time
            const lastUpdatedElement = document.getElementById('portfolioLastUpdated');
            if (lastUpdatedElement) {
                lastUpdatedElement.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
            }
        };

        // Function to display empty portfolio state
        window.displayEmptyPortfolio = function() {
            const portfolioTableBody = document.getElementById('portfolioTableBody');
            if (portfolioTableBody) {
                portfolioTableBody.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìà</div>
                        <div style="font-size: 1.2rem; margin-bottom: 0.5rem; color: var(--text-primary);">No assets added yet</div>
                        <div>Click "Add Asset" to start building your portfolio</div>
                    </div>
                `;
            }
            
            // Reset portfolio value
            const totalValueElement = document.getElementById('totalPortfolioValue');
            if (totalValueElement) {
                totalValueElement.textContent = '$0.00';
            }
            
            // Update assets count
            const assetsCount = document.querySelector('.assets-count');
            if (assetsCount) {
                assetsCount.textContent = '0 assets';
            }
        };

        // Function to save portfolio history snapshot
        window.savePortfolioHistory = async function(totalValue, reason = 'Asset Update') {
            try {
                console.log(`üìà [HISTORY] Saving portfolio snapshot: $${totalValue} (${reason})`);
                
                const historyData = {
                    action: 'history',
                    timestamp: new Date().toISOString(),
                    totalValue: totalValue,
                    reason: reason,
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString()
                };
                
                const webhookUrl = 'https://script.google.com/macros/s/AKfycbwMv3IVGLPN_NYa00EfAHoIHqERMHbODqaDtpYT1_AUxk20Ihtkovgz7gZP8QbERx_Q/exec';
                
                // Send to Google Apps Script
                const urlWithParams = `${webhookUrl}?action=${encodeURIComponent(historyData.action)}&timestamp=${encodeURIComponent(historyData.timestamp)}&totalValue=${encodeURIComponent(historyData.totalValue)}&reason=${encodeURIComponent(historyData.reason)}&date=${encodeURIComponent(historyData.date)}&time=${encodeURIComponent(historyData.time)}`;
                
                console.log(`üìà [HISTORY] Sending history data: ${urlWithParams}`);
                
                const response = await fetch(urlWithParams, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        console.log(`‚úÖ [HISTORY] Portfolio history saved successfully`);
                        return true;
                    } else {
                        console.error(`‚ùå [HISTORY] Failed to save history:`, result.error);
                        return false;
                    }
                } else {
                    console.error(`‚ùå [HISTORY] HTTP error saving history:`, response.status);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå [HISTORY] Error saving portfolio history:', error);
                return false;
            }
        };

        // Function to refresh portfolio with latest prices
        window.refreshPortfolio = async function() {
            console.log('üîÑ Refreshing portfolio with latest prices...');
            
            try {
                const portfolioData = await window.fetchPortfolioData();
                
                if (portfolioData && portfolioData.length > 0) {
                    // Refresh prices for each asset
                    for (let i = 0; i < portfolioData.length; i++) {
                        const row = portfolioData[i];
                        const assetName = row[0];
                        const symbol = row[1];
                        
                        // Here we would update prices in the database
                        // For now, just refresh the display
                        console.log(`üîÑ Refreshing price for ${assetName} (${symbol})`);
                    }
                    
                    // Reload the portfolio display
                    await window.loadPortfolioData();
                    
                    console.log('‚úÖ Portfolio refreshed successfully');
                } else {
                    console.log('‚ö†Ô∏è No portfolio data to refresh');
                }
            } catch (error) {
                console.error('‚ùå Error refreshing portfolio:', error);
            }
        };

        // ===================================================================
        // CHART GENERATION FUNCTIONS
        // ===================================================================
        
        // Target portfolio allocation (loaded from Google Sheets)
        window.targetAllocation = {
            'Low risk': 20,
            'Medium risk': 29, 
            'High risk': 40,
            'Degen': 1,
            'Stablecoin': 10
        };
        
        // Function to fetch target allocation from Google Sheets
        window.fetchTargetAllocation = async function() {
            try {
                console.log('üéØ Fetching target allocation from Google Sheets...');
                
                // Try to fetch from TargetAllocation sheet using Google Sheets API (only columns A & B)
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/TargetAllocation!A:B?key=${API_KEY}`
                );
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.values && data.values.length > 1) {
                        const targetAllocation = {};
                        
                        // Skip header row (index 0)
                        for (let i = 1; i < data.values.length; i++) {
                            const row = data.values[i];
                            const riskCategory = row[0];
                            const percentage = parseFloat(row[1]);
                            
                            if (riskCategory && !isNaN(percentage) && percentage > 0) {
                                targetAllocation[riskCategory] = percentage;
                            }
                        }
                        
                        if (Object.keys(targetAllocation).length > 0) {
                            window.targetAllocation = targetAllocation;
                            console.log('‚úÖ Target allocation loaded from database:', targetAllocation);
                            return targetAllocation;
                        }
                    }
                }
                
                console.log('‚ö†Ô∏è Using default target allocation');
                return window.targetAllocation;
                
            } catch (error) {
                console.error('‚ùå Error fetching target allocation:', error);
                console.log('‚ö†Ô∏è Using default target allocation');
                return window.targetAllocation;
            }
        };

        window.generatePortfolioCharts = async function(portfolioData) {
            console.log('üìä Generating portfolio analysis charts...');
            
            try {
                // Generate main stacked bar chart
                window.generateStackedBarChart(portfolioData);
                
                // Fetch target allocation and generate comparison charts
                await window.fetchTargetAllocation();
                window.generateTargetVsCurrentCharts(portfolioData);
                
                console.log('‚úÖ Portfolio charts generated successfully');
            } catch (error) {
                console.error('‚ùå Error generating portfolio charts:', error);
            }
        };

        // Generate 100% Stacked Bar Chart for all portfolio categories
        window.generateStackedBarChart = function(portfolioData) {
            const ctx = document.getElementById('portfolioStackedChart');
            if (!ctx) return;

            // Aggregate data for all four categories
            const riskData = {};
            const typeData = {};
            const locationData = {};
            const tokenData = {};
            const tokenRiskMapping = {}; // Map tokens to their risk levels
            let totalValue = 0;

            portfolioData.forEach(row => {
                const quantity = parseFloat(row[3]) || 0;
                const price = parseFloat(row[4]) || 0;
                const value = quantity * price;
                const symbol = row[1] || 'Unknown';
                const riskLevel = row[7] || 'Unknown';
                const coinType = row[9] || 'Unknown';
                const location = row[8] || 'Unknown';
                
                totalValue += value;
                riskData[riskLevel] = (riskData[riskLevel] || 0) + value;
                typeData[coinType] = (typeData[coinType] || 0) + value;
                locationData[location] = (locationData[location] || 0) + value;
                tokenData[symbol] = (tokenData[symbol] || 0) + value;
                
                // Map each token to its risk level for color coding
                tokenRiskMapping[symbol] = riskLevel;
            });

            // Sort and limit tokens to top 6 + Others
            const sortedTokens = Object.entries(tokenData)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 6);
            
            const otherTokenValue = Object.entries(tokenData)
                .slice(6)
                .reduce((sum, [,value]) => sum + value, 0);
            
            const finalTokenData = {};
            sortedTokens.forEach(([token, value]) => {
                finalTokenData[token] = value;
            });
            if (otherTokenValue > 0) {
                finalTokenData['Others'] = otherTokenValue;
            }

            // Convert to percentages for each category
            const riskPercentages = Object.entries(riskData).map(([key, value]) => ({
                label: key,
                percentage: ((value / totalValue) * 100).toFixed(1),
                value: value
            }));

            const typePercentages = Object.entries(typeData).map(([key, value]) => ({
                label: key,
                percentage: ((value / totalValue) * 100).toFixed(1),
                value: value
            }));

            const locationPercentages = Object.entries(locationData).map(([key, value]) => ({
                label: key,
                percentage: ((value / totalValue) * 100).toFixed(1),
                value: value
            }));

            const tokenPercentages = Object.entries(finalTokenData).map(([key, value]) => ({
                label: key,
                percentage: ((value / totalValue) * 100).toFixed(1),
                value: value
            }));

            // Define colors for each category (updated to match website theme)
            const riskColors = {
                'Low': '#64748B',      // Slate gray for Low risk
                'Medium': '#F59E0B',   // Amber for Medium risk  
                'High': '#EF4444',     // Red for High risk
                'Degen': '#DC2626',    // Dark red for Degen
                'Unknown': '#9CA3AF'   // Gray for Unknown
            };

            const typeColors = {
                'Major': '#3B82F6',      // Blue for Major
                'Altcoin': '#8B5CF6',    // Purple for Altcoin
                'Meme': '#10B981',       // Emerald for Meme
                'Stablecoin': '#6B7280', // Gray for Stablecoin
                'Unknown': '#9CA3AF'     // Gray for Unknown
            };

            const locationColors = ['#3B82F6', '#10B981', '#F59E0B', '#8B5CF6', '#EF4444', '#06B6D4', '#84CC16', '#F97316', '#64748B'];

            // Prepare datasets for stacked bar chart
            const datasets = [];

            // Risk Level datasets (Bar 1)
            riskPercentages.forEach((item, index) => {
                datasets.push({
                    label: `Risk: ${item.label}`,
                    data: [parseFloat(item.percentage), 0, 0, 0], // Only show in first bar
                    backgroundColor: riskColors[item.label] || '#9CA3AF',
                    stack: 'stack1'
                });
            });

            // Token Allocation datasets (Bar 2) - clustered by risk level, largest at bottom
            const tokensByRisk = {
                'High': [],
                'Degen': [],
                'Medium': [],
                'Low': [],
                'Unknown': []
            };

            // Group tokens by risk level
            tokenPercentages.forEach((item) => {
                const tokenRisk = tokenRiskMapping[item.label] || 'Unknown';
                tokensByRisk[tokenRisk].push(item);
            });

            // Sort each risk group by percentage (largest first) and add to datasets
            ['High', 'Degen', 'Medium', 'Low', 'Unknown'].forEach(riskLevel => {
                tokensByRisk[riskLevel]
                    .sort((a, b) => parseFloat(b.percentage) - parseFloat(a.percentage))
                    .forEach((item) => {
                        const tokenColor = riskColors[riskLevel] || '#9CA3AF';
                        datasets.push({
                            label: `Token: ${item.label}`,
                            data: [0, parseFloat(item.percentage), 0, 0], // Only show in second bar
                            backgroundColor: tokenColor,
                            stack: 'stack1'
                        });
                    });
            });

            // Token Type datasets (Bar 3) - sorted with largest at bottom, independent colors
            const sortedTypePercentages = typePercentages.sort((a, b) => parseFloat(b.percentage) - parseFloat(a.percentage));
            sortedTypePercentages.forEach((item, index) => {
                datasets.push({
                    label: `Type: ${item.label}`,
                    data: [0, 0, parseFloat(item.percentage), 0], // Only show in third bar
                    backgroundColor: typeColors[item.label] || '#9CA3AF',
                    stack: 'stack1'
                });
            });

            // Location datasets (Bar 4)
            locationPercentages.forEach((item, index) => {
                datasets.push({
                    label: `Location: ${item.label}`,
                    data: [0, 0, 0, parseFloat(item.percentage)], // Only show in fourth bar
                    backgroundColor: locationColors[index % locationColors.length],
                    stack: 'stack1'
                });
            });

            // Destroy existing chart if it exists
            if (window.portfolioStackedChartInstance) {
                window.portfolioStackedChartInstance.destroy();
            }



            window.portfolioStackedChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Risk Level', 'Token Allocation', 'Token Type', 'Location'],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    categoryPercentage: 0.8, // Make bars thicker
                    barPercentage: 0.9,
                    scales: {
                        x: {
                            stacked: true,
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 14,
                                    weight: 'bold',
                                    family: 'Inter, -apple-system, sans-serif'
                                },
                                color: '#E0E7FF'
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                },
                                font: {
                                    size: 12
                                },
                                color: '#94A3B8'
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)',
                                drawBorder: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false, // Hide legend for cleaner look
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleColor: '#E0E7FF',
                            bodyColor: '#CBD5E1',
                            borderColor: '#475569',
                            borderWidth: 1,
                            cornerRadius: 8,
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    if (value > 0) {
                                        // Calculate dollar amount
                                        const category = label.split(': ')[0];
                                        const itemName = label.split(': ')[1];
                                        let amount = 0;
                                        
                                        if (category === 'Risk') {
                                            amount = riskData[itemName] || 0;
                                        } else if (category === 'Type') {
                                            amount = typeData[itemName] || 0;
                                        } else if (category === 'Location') {
                                            amount = locationData[itemName] || 0;
                                        } else if (category === 'Token') {
                                            amount = itemName === 'Others' ? otherTokenValue : (tokenData[itemName] || 0);
                                        }
                                        
                                        return `${itemName}: ${value}% ($${amount.toLocaleString()})`;
                                    }
                                    return null;
                                },
                                filter: function(tooltipItem) {
                                    return tooltipItem.parsed.y > 0;
                                }
                            }
                        },
                        datalabels: {
                            display: function(context) {
                                const value = context.parsed ? context.parsed.y : context.dataset.data[context.dataIndex];
                                return value > 5; // Only show labels for segments > 5%
                            },
                            color: '#FFFFFF',
                            font: {
                                size: 11,
                                weight: 'bold',
                                family: 'Inter, -apple-system, sans-serif'
                            },
                            formatter: function(value, context) {
                                if (value <= 5) return ''; // Don't show labels for small segments
                                const label = context.dataset.label || '';
                                const itemName = label.split(': ')[1];
                                return itemName; // Just show the clean segment title
                            },
                            textAlign: 'center',
                            anchor: 'center',
                            align: 'center'
                        }
                    }
                }
            });
        };

        // Generate Target vs Current Allocation Stacked Bar Chart
        window.generateTargetVsCurrentCharts = function(portfolioData) {
            console.log('üìä Generating target vs current allocation analysis...');
            console.log('Portfolio data:', portfolioData);
            console.log('Target allocation:', window.targetAllocation);
            
            // Calculate current allocation from portfolio data
            const currentRiskAllocation = {};
            let totalCurrentValue = 0;
            
            portfolioData.forEach(row => {
                const quantity = parseFloat(row[3]) || 0;
                const price = parseFloat(row[4]) || 0;
                const value = quantity * price;
                const riskLevel = row[7] || 'Unknown';
                
                currentRiskAllocation[riskLevel] = (currentRiskAllocation[riskLevel] || 0) + value;
                totalCurrentValue += value;
            });
            
            console.log('Current risk allocation:', currentRiskAllocation);
            console.log('Total current value:', totalCurrentValue);
            
            // Convert to percentages
            const currentPercentages = {};
            Object.keys(currentRiskAllocation).forEach(risk => {
                currentPercentages[risk] = totalCurrentValue > 0 ? 
                    (currentRiskAllocation[risk] / totalCurrentValue) * 100 : 0;
            });
            
            console.log('Current percentages:', currentPercentages);
            
            // Generate stacked bar chart
            window.generateTargetVsCurrentStackedChart(window.targetAllocation, currentPercentages);
        };

        // Generate Target vs Current Allocation Stacked Bar Chart
        window.generateTargetVsCurrentStackedChart = function(targetAllocation, currentPercentages) {
            const ctx = document.getElementById('targetVsCurrentChart');
            if (!ctx) return;

            // Destroy existing chart if it exists
            if (window.targetVsCurrentChartInstance) {
                window.targetVsCurrentChartInstance.destroy();
            }

            // Risk level colors (same as main portfolio chart)
            const riskColors = {
                'Low': '#6B7280',          // Gray
                'Low risk': '#6B7280',     // Gray (alternative)
                'Medium': '#F59E0B',       // Amber
                'Medium risk': '#F59E0B',  // Amber (alternative)
                'High': '#EF4444',         // Red
                'High risk': '#EF4444',    // Red (alternative)
                'Degen': '#DC2626',        // Dark Red
                'Stablecoin': '#3B82F6',   // Blue
                'None': '#9CA3AF'          // Light Gray for "None" category
            };

            // Get all risk categories (union of target and current)
            const allRiskCategories = [...new Set([
                ...Object.keys(targetAllocation),
                ...Object.keys(currentPercentages)
            ])];

            // Sort categories for consistent display
            allRiskCategories.sort();

            // Prepare datasets for target and current
            const targetDatasets = [];
            const currentDatasets = [];

            allRiskCategories.forEach(riskCategory => {
                const targetPercent = targetAllocation[riskCategory] || 0;
                const currentPercent = currentPercentages[riskCategory] || 0;
                const color = riskColors[riskCategory] || '#6B7280';

                if (targetPercent > 0) {
                    targetDatasets.push({
                        label: `Target: ${riskCategory}`,
                        data: [targetPercent, 0], // [Target bar, Current bar]
                        backgroundColor: color,
                        borderColor: '#1E293B',
                        borderWidth: 1
                    });
                }

                if (currentPercent > 0) {
                    currentDatasets.push({
                        label: `Current: ${riskCategory}`,
                        data: [0, currentPercent], // [Target bar, Current bar]
                        backgroundColor: color,
                        borderColor: '#1E293B',
                        borderWidth: 1
                    });
                }
            });

            // Combine datasets
            const datasets = [...targetDatasets, ...currentDatasets];

            window.targetVsCurrentChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Target Allocation', 'Current Allocation'],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    categoryPercentage: 0.6,
                    barPercentage: 0.8,
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                color: '#E0E7FF'
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                font: {
                                    size: 12
                                },
                                color: '#94A3B8',
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)',
                                drawBorder: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false, // Hide legend for cleaner look
                            position: 'top',
                            labels: {
                                color: '#E0E7FF',
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleColor: '#E0E7FF',
                            bodyColor: '#CBD5E1',
                            borderColor: '#475569',
                            borderWidth: 1,
                            cornerRadius: 8,
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    try {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed && context.parsed.y ? context.parsed.y : 0;
                                        if (value > 0) {
                                            return `${label}: ${value.toFixed(1)}%`;
                                        }
                                        return null;
                                    } catch (error) {
                                        console.error('Tooltip error:', error);
                                        return null;
                                    }
                                }
                            }
                        },
                        // Data labels for segments >5%
                        datalabels: {
                            display: function(context) {
                                try {
                                    return context.parsed && context.parsed.y > 5;
                                } catch (error) {
                                    return false;
                                }
                            },
                            formatter: function(value, context) {
                                try {
                                    if (value > 5 && context.dataset && context.dataset.label) {
                                        // Extract the segment name from the label (e.g., "Target: High risk" -> "High risk")
                                        const label = context.dataset.label.split(': ')[1] || context.dataset.label;
                                        // Format like top charts: "High 40%" or "High 51%"
                                        return `${label} ${value.toFixed(0)}%`;
                                    }
                                    return '';
                                } catch (error) {
                                    return '';
                                }
                            },
                            color: '#FFFFFF',
                            font: {
                                size: 11,
                                weight: 'bold'
                            },
                            backgroundColor: null,
                            borderRadius: 0,
                            padding: 0,
                            textAlign: 'center',
                            anchor: 'center',
                            align: 'center'
                        }
                    }
                }
            });
        };

        // Function to fetch live transaction data for a specific investor
        window.fetchInvestorTransactions = async function(investorId) {
            try {
                console.log(`üìã Fetching transactions for investor: ${investorId}`);
                
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Transactions!A:F?key=${API_KEY}`
                );
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.values && data.values.length > 1) {
                    console.log('‚úÖ Successfully fetched transaction data');
                    
                    // Filter transactions for this investor (skip header row)
                    const investorTransactions = [];
                    for (let i = 1; i < data.values.length; i++) {
                        const row = data.values[i];
                        if (row && row.length >= 6) {
                            const rowInvestorId = row[1]; // Column B: Investor ID
                            if (rowInvestorId === investorId) {
                                investorTransactions.push({
                                    date: row[0] || '', // Column A: Date
                                    investorId: row[1] || '', // Column B: Investor ID
                                    type: row[2] || '', // Column C: Type
                                    amount: parseFloat(row[3]?.replace(/[$,]/g, '')) || 0, // Column D: Amount
                                    method: row[4] || '', // Column E: Method
                                    notes: row[5] || '' // Column F: Notes
                                });
                            }
                        }
                    }
                    
                    console.log(`üìä Found ${investorTransactions.length} transactions for investor ${investorId}`);
                    return investorTransactions;
                } else {
                    console.log('‚ö†Ô∏è No transaction data found');
                    return [];
                }
            } catch (error) {
                console.error('‚ùå Error fetching transactions:', error);
                return [];
            }
        };

        // Function to show investor details modal
        window.showInvestorDetails = async function(investorId, name, joinDate, totalInvestment, currentValue, totalReturn) {
            console.log(`üìä Showing details for investor: ${investorId} - ${name}`);
            
            // Populate investor summary
            document.getElementById('detailInvestorId').textContent = investorId;
            document.getElementById('detailInvestorName').textContent = name;
            document.getElementById('detailJoinDate').textContent = joinDate;
            document.getElementById('detailTotalInvestment').textContent = `$${totalInvestment.toLocaleString()}`;
            document.getElementById('detailCurrentValue').textContent = `$${currentValue.toLocaleString()}`;
            
            const returnClass = totalReturn >= 0 ? 'positive' : 'negative';
            const returnSign = totalReturn >= 0 ? '+' : '';
            document.getElementById('detailTotalReturn').innerHTML = `<span class="${returnClass}">${returnSign}${totalReturn.toFixed(1)}%</span>`;
            
            // Update modal title
            document.getElementById('investorDetailsTitle').textContent = `${name} (${investorId})`;
            
            // Show loading state
            const transactionsBody = document.getElementById('investorTransactionsBody');
            transactionsBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #7f8c8d;">Loading transactions...</td></tr>';
            
            // Show the modal first
            document.getElementById('investorDetailsModal').classList.add('active');
            
            // Fetch real transaction data from database
            const liveTransactions = await window.fetchInvestorTransactions(investorId);
            
            let transactionHTML = '';
            
            if (liveTransactions && liveTransactions.length > 0) {
                // Use live transaction data from database
                console.log(`‚úÖ Displaying ${liveTransactions.length} live transactions`);
                liveTransactions.forEach(transaction => {
                    // Format date as single line: MM/DD/YYYY
                    const formattedDate = transaction.date ? 
                        new Date(transaction.date).toLocaleDateString('en-US', {
                            month: '2-digit',
                            day: '2-digit', 
                            year: 'numeric'
                        }) : 'N/A';
                    const typeClass = transaction.type === 'Investment' ? 'positive' : 'negative';
                    const typeIcon = transaction.type === 'Investment' ? '‚ÜóÔ∏è' : '‚ÜôÔ∏è';
                    
                    transactionHTML += `
                        <tr>
                            <td style="white-space: nowrap;">${formattedDate}</td>
                            <td><span class="${typeClass}">${typeIcon} ${transaction.type}</span></td>
                            <td>$${transaction.amount.toLocaleString()}</td>
                            <td>${transaction.notes || 'No notes'}</td>
                        </tr>
                    `;
                });
            } else {
                // Fallback to sample data if no live data available
                console.log('‚ö†Ô∏è No live transactions found, using fallback data');
                let sampleTransactions = [];
                
                if (investorId === 'LK1') {
                    sampleTransactions = [
                        { date: '2023-10-08', type: 'Investment', amount: 2000, notes: 'Initial investment via bank transfer' },
                        { date: '2023-11-15', type: 'Investment', amount: 500, notes: 'Additional investment' }
                    ];
                } else if (investorId === 'MO2') {
                    sampleTransactions = [
                        { date: '2023-10-10', type: 'Investment', amount: 1050.06, notes: 'Initial investment' }
                    ];
                } else if (investorId === 'FO3') {
                    sampleTransactions = [
                        { date: '2023-10-14', type: 'Investment', amount: 1823.91, notes: 'Initial investment' }
                    ];
                } else if (investorId === 'RA4') {
                    sampleTransactions = [
                        { date: '2023-11-19', type: 'Investment', amount: 828.30, notes: 'Initial investment' }
                    ];
                } else if (investorId === 'OK5') {
                    sampleTransactions = [
                        { date: '2023-11-19', type: 'Investment', amount: 991.57, notes: 'Initial investment' }
                    ];
                } else if (investorId === 'OA6') {
                    sampleTransactions = [
                        { date: '2023-11-26', type: 'Investment', amount: 15000, notes: 'Initial large investment' },
                        { date: '2023-12-15', type: 'Investment', amount: 5212.46, notes: 'Additional investment' }
                    ];
                } else {
                    // For live data investors, create a sample transaction
                    sampleTransactions = [
                        { date: joinDate, type: 'Investment', amount: totalInvestment, notes: 'Investment from live data' }
                    ];
                }
                
                // Generate fallback transaction HTML
                sampleTransactions.forEach(transaction => {
                    // Format date as single line: MM/DD/YYYY
                    const formattedDate = new Date(transaction.date).toLocaleDateString('en-US', {
                        month: '2-digit',
                        day: '2-digit', 
                        year: 'numeric'
                    });
                    const typeClass = transaction.type === 'Investment' ? 'positive' : 'negative';
                    const typeIcon = transaction.type === 'Investment' ? '‚ÜóÔ∏è' : '‚ÜôÔ∏è';
                    
                    transactionHTML += `
                        <tr>
                            <td style="white-space: nowrap;">${formattedDate}</td>
                            <td><span class="${typeClass}">${typeIcon} ${transaction.type}</span></td>
                            <td>$${transaction.amount.toLocaleString()}</td>
                            <td>${transaction.notes}</td>
                        </tr>
                    `;
                });
            }
            
            // Update the table with real or fallback data
            transactionsBody.innerHTML = transactionHTML || '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #7f8c8d;">No transactions found</td></tr>';
        };

        // Function to close investor details modal
        window.closeInvestorModal = function() {
            console.log('‚ùå Closing investor details modal');
            document.getElementById('investorDetailsModal').classList.remove('active');
        };

        // Function to scroll to investor table (for Investors tab)
        window.scrollToInvestorTable = function() {
            console.log('üìç Scrolling to investor table...');
            const investorTable = document.getElementById('investorsTable');
            if (investorTable) {
                investorTable.scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
                console.log('‚úÖ Scrolled to investor table');
            } else {
                console.log('‚ö†Ô∏è Investor table not found');
            }
        };

        // === PORTFOLIO FUNCTIONALITY ===
        
        // Global variables for portfolio
        window.portfolioAssets = [];
        window.assetSearchResults = [];
        
        // Autocomplete data storage
        window.autocompleteData = {
            riskLevels: new Set(),
            locations: new Set(),
            coinTypes: new Set(),
            blockchains: new Set(['Ethereum', 'Solana', 'Bitcoin', 'Hyperliquid', 'Polygon', 'Arbitrum', 'Optimism', 'Base'])
        };

        // Function to update autocomplete data from portfolio
        window.updateAutocompleteData = function(portfolioData) {
            console.log('üîÑ Updating autocomplete data...');
            
            // Clear existing data (but keep default blockchains)
            window.autocompleteData.riskLevels.clear();
            window.autocompleteData.locations.clear();
            window.autocompleteData.coinTypes.clear();
            
            // Populate from existing portfolio data
            portfolioData.forEach(row => {
                if (row.length >= 10) {
                    const blockchain = row[2]?.trim();  // Column C: Chain
                    const riskLevel = row[7]?.trim();
                    const location = row[8]?.trim();
                    const coinType = row[9]?.trim();
                    
                    if (blockchain) window.autocompleteData.blockchains.add(blockchain);
                    if (riskLevel) window.autocompleteData.riskLevels.add(riskLevel);
                    if (location) window.autocompleteData.locations.add(location);
                    if (coinType) window.autocompleteData.coinTypes.add(coinType);
                }
            });
            
            console.log('üìä Autocomplete data updated:', {
                riskLevels: Array.from(window.autocompleteData.riskLevels),
                locations: Array.from(window.autocompleteData.locations),
                coinTypes: Array.from(window.autocompleteData.coinTypes),
                blockchains: Array.from(window.autocompleteData.blockchains)
            });
        };

        // Function to setup autocomplete for a field
        window.setupAutocomplete = function(inputId, suggestionsId, dataSet) {
            const input = document.getElementById(inputId);
            const suggestions = document.getElementById(suggestionsId);
            let highlightedIndex = -1;
            
            if (!input || !suggestions) return;
            
            input.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                suggestions.innerHTML = '';
                highlightedIndex = -1;
                
                if (value.length === 0) {
                    suggestions.style.display = 'none';
                    return;
                }
                
                const matches = Array.from(dataSet).filter(item => 
                    item.toLowerCase().includes(value)
                ).sort((a, b) => {
                    // Prioritize items that start with the input
                    const aStarts = a.toLowerCase().startsWith(value);
                    const bStarts = b.toLowerCase().startsWith(value);
                    if (aStarts && !bStarts) return -1;
                    if (!aStarts && bStarts) return 1;
                    return a.localeCompare(b);
                });
                
                if (matches.length > 0) {
                    matches.forEach((match, index) => {
                        const div = document.createElement('div');
                        div.className = 'autocomplete-suggestion';
                        div.textContent = match;
                        div.addEventListener('click', function() {
                            input.value = match;
                            suggestions.style.display = 'none';
                        });
                        suggestions.appendChild(div);
                    });
                    suggestions.style.display = 'block';
                } else {
                    suggestions.style.display = 'none';
                }
            });
            
            // Handle keyboard navigation
            input.addEventListener('keydown', function(e) {
                const suggestionItems = suggestions.querySelectorAll('.autocomplete-suggestion');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    highlightedIndex = Math.min(highlightedIndex + 1, suggestionItems.length - 1);
                    updateHighlight(suggestionItems);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    highlightedIndex = Math.max(highlightedIndex - 1, -1);
                    updateHighlight(suggestionItems);
                } else if (e.key === 'Enter' && highlightedIndex >= 0) {
                    e.preventDefault();
                    suggestionItems[highlightedIndex].click();
                } else if (e.key === 'Escape') {
                    suggestions.style.display = 'none';
                    highlightedIndex = -1;
                }
            });
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.style.display = 'none';
                    highlightedIndex = -1;
                }
            });
            
            function updateHighlight(items) {
                items.forEach((item, index) => {
                    item.classList.toggle('highlighted', index === highlightedIndex);
                });
            }
        };
        
        // Debug function to test data
        window.debugPortfolioData = function() {
            console.log('üìä Portfolio data loaded successfully');
            console.log('üìä Autocomplete data:', {
                riskLevels: Array.from(window.autocompleteData.riskLevels),
                locations: Array.from(window.autocompleteData.locations),
                coinTypes: Array.from(window.autocompleteData.coinTypes)
            });
            
            // Test database connection
            window.loadPortfolioData().then(() => {
                console.log('‚úÖ Portfolio data loaded successfully');
            }).catch(error => {
                console.error('‚ùå Error loading portfolio data:', error);
            });
                };

        // Function to get custom Hyperliquid assets
        window.getCustomHyperliquidAssets = function(query) {
            const customAssets = [
                {
                    id: 'buddy-hyperliquid',
                    name: 'Buddy',
                    symbol: 'BUDDY',
                    thumb: 'https://via.placeholder.com/32/00ff64/ffffff?text=B',
                    large: 'https://via.placeholder.com/64/00ff64/ffffff?text=B',
                    contract_address: '0x84ecb2340931f6b153ff10bcfafb6726'
                },
                {
                    id: 'hype-hyperliquid',
                    name: 'Hyperliquid',
                    symbol: 'HYPE',
                    thumb: 'https://via.placeholder.com/32/00ff64/ffffff?text=H',
                    large: 'https://via.placeholder.com/64/00ff64/ffffff?text=H'
                }
            ];
            
            const queryLower = query.toLowerCase();
            return customAssets.filter(asset => 
                asset.name.toLowerCase().includes(queryLower) ||
                asset.symbol.toLowerCase().includes(queryLower) ||
                asset.id.toLowerCase().includes(queryLower)
            );
        };
        
        // Function to open Add Asset modal
        window.openAddAssetModal = function() {
            console.log('üìà Opening Add Asset modal...');
            document.getElementById('addAssetModal').classList.add('active');
            
            // Debug current autocomplete data
            console.log('üîç Current autocomplete data when opening modal:', {
                riskLevels: Array.from(window.autocompleteData.riskLevels),
                locations: Array.from(window.autocompleteData.locations),
                coinTypes: Array.from(window.autocompleteData.coinTypes)
            });
            
            // Initialize autocomplete functionality
            setTimeout(() => {
                console.log('üîß Setting up autocomplete with data:', {
                    riskLevels: Array.from(window.autocompleteData.riskLevels),
                    locations: Array.from(window.autocompleteData.locations),
                    coinTypes: Array.from(window.autocompleteData.coinTypes)
                });
                
                window.setupAutocomplete('assetRisk', 'riskSuggestions', window.autocompleteData.riskLevels);
                window.setupAutocomplete('assetLocation', 'locationSuggestions', window.autocompleteData.locations);
                window.setupAutocomplete('assetCoinType', 'coinTypeSuggestions', window.autocompleteData.coinTypes);
                window.setupAutocomplete('assetChain', 'chainSuggestions', window.autocompleteData.blockchains);
                
                console.log('‚úÖ Autocomplete setup complete');
            }, 100);
            // Reset form
            document.getElementById('addAssetForm').reset();
            document.getElementById('selectedAsset').value = '';
            document.getElementById('selectedAssetId').value = '';
            document.getElementById('selectedAssetSymbol').value = '';
            document.getElementById('selectedAssetImage').value = '';
            document.getElementById('assetChain').value = '';
            document.getElementById('selectedAssetInfo').style.display = 'none';
            document.getElementById('valuePreview').innerHTML = '<div style="font-size: 1.5rem; font-weight: bold; color: #1976d2;">$0.00</div><div style="font-size: 0.9rem; color: #7f8c8d;">Live price will be fetched automatically</div>';
        };
        
        // Function to close Add Asset modal
        window.closeAddAssetModal = function() {
            console.log('‚ùå Closing Add Asset modal');
            document.getElementById('addAssetModal').classList.remove('active');
        };
        

        
        // Function to search assets using CoinGecko API
        window.searchAssets = async function(query) {
            if (!query || query.length < 2) {
                document.getElementById('assetDropdown').style.display = 'none';
                return;
            }
            
            try {
                console.log(`üîç Searching for assets: ${query}`);
                
                // Check for custom Hyperliquid assets first (always check regardless of blockchain selection)
                const customHyperliquidAssets = window.getCustomHyperliquidAssets(query);
                
                // Use CoinGecko's search endpoint (free)
                const response = await fetch(`https://api.coingecko.com/api/v3/search?query=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                let allResults = [];
                
                // Add CoinGecko results
                if (data.coins && data.coins.length > 0) {
                    // No longer filter by chain - return all results
                    allResults = data.coins.slice(0, 15); // Get more results since we're not filtering
                }
                
                // Add custom Hyperliquid assets to the results
                if (customHyperliquidAssets.length > 0) {
                    allResults = [...customHyperliquidAssets, ...allResults];
                }
                
                if (allResults.length > 0) {
                    window.assetSearchResults = allResults.slice(0, 10); // Limit to 10 total results
                    window.displayAssetSearchResults(window.assetSearchResults);
                } else {
                    document.getElementById('assetDropdown').innerHTML = '<div style="padding: 10px; color: #7f8c8d;">No assets found</div>';
                    document.getElementById('assetDropdown').style.display = 'block';
                }
            } catch (error) {
                console.error('‚ùå Error searching assets:', error);
                document.getElementById('assetDropdown').innerHTML = '<div style="padding: 10px; color: #dc3545;">Error searching assets</div>';
                document.getElementById('assetDropdown').style.display = 'block';
            }
        };
        

        
        // Function to display asset search results
        window.displayAssetSearchResults = function(results) {
            const dropdown = document.getElementById('assetDropdown');
            let html = '';
            
            results.forEach(asset => {
                html += `
                    <div class="asset-result" onclick="window.selectAsset('${asset.id}', '${asset.name}', '${asset.symbol}', '${asset.large || asset.thumb}')" style="padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; gap: 10px;">
                        <img src="${asset.large || asset.thumb}" alt="${asset.name}" style="width: 24px; height: 24px;">
                        <div>
                            <div style="font-weight: bold;">${asset.name}</div>
                            <div style="font-size: 0.8rem; color: #7f8c8d;">${asset.symbol.toUpperCase()}</div>
                        </div>
                    </div>
                `;
            });
            
            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
        };
        
        // Function to detect blockchain based on asset
        window.detectBlockchain = function(assetId, assetName, assetSymbol) {
            const symbolLower = assetSymbol.toLowerCase();
            const nameLower = assetName.toLowerCase();
            
            // Hyperliquid assets (custom ones)
            if (['hyperliquid', 'hype', 'purr', 'jeff', 'god', 'hfun', 'buddy'].includes(symbolLower) || 
                nameLower.includes('hyperliquid')) {
                return 'Hyperliquid';
            }
            
            // Solana ecosystem assets
            if (['sol', 'ray', 'orca', 'msol', 'jto', 'hnt', 'render', 'pyth', 'w', 'kmno', 'drift', 
                 'tnsr', 'bonk', 'wif', 'popcat', 'bome', 'boden', 'moodeng', 'jitosol', 'step'].includes(symbolLower) ||
                nameLower.includes('solana') || nameLower.includes('raydium') || nameLower.includes('marinade') ||
                nameLower.includes('jito') || nameLower.includes('helium') || nameLower.includes('render') ||
                nameLower.includes('pyth') || nameLower.includes('wormhole') || nameLower.includes('bonk') ||
                nameLower.includes('dogwifcoin')) {
                return 'Solana';
            }
            
            // Bitcoin
            if (symbolLower === 'btc' || nameLower.includes('bitcoin')) {
                return 'Bitcoin';
            }
            
            // Ethereum ecosystem assets (including specific ones like Aura)
            if (['aura', 'cvx', 'bal', 'uni', 'link', 'mkr', 'comp', 'aave', 'snx', 'crv', 'yfi', 
                 '1inch', 'grt', 'ens', 'wbtc', 'dai', 'frax', 'reth', 'steth', 'shib', 'pepe'].includes(symbolLower) ||
                nameLower.includes('aura') || nameLower.includes('convex') || nameLower.includes('balancer') ||
                nameLower.includes('uniswap') || nameLower.includes('chainlink') || nameLower.includes('ethereum')) {
                return 'Ethereum';
            }
            
            // Default to Ethereum for most other assets (since CoinGecko has many ERC-20 tokens)
            return 'Ethereum';
        };

        // Function to select an asset
        window.selectAsset = async function(assetId, assetName, assetSymbol, assetImage) {
            console.log(`ü™ô Selected asset: ${assetName} (${assetSymbol})`);
            
            document.getElementById('assetSearch').value = `${assetName} (${assetSymbol.toUpperCase()})`;
            document.getElementById('selectedAsset').value = assetName;
            document.getElementById('selectedAssetId').value = assetId;
            document.getElementById('selectedAssetSymbol').value = assetSymbol;
            document.getElementById('selectedAssetImage').value = assetImage;
            document.getElementById('assetDropdown').style.display = 'none';
            
            // Auto-populate blockchain field
            const detectedBlockchain = window.detectBlockchain(assetId, assetName, assetSymbol);
            document.getElementById('assetChain').value = detectedBlockchain;
            console.log(`üîó Auto-detected blockchain: ${detectedBlockchain}`);
            
            // Show selected asset info
            const assetInfo = document.getElementById('selectedAssetInfo');
            assetInfo.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <img src="${assetImage}" alt="${assetName}" style="width: 32px; height: 32px;">
                    <div>
                        <div style="font-weight: bold;">${assetName}</div>
                        <div style="font-size: 0.8rem; color: #7f8c8d;">${assetSymbol.toUpperCase()} ‚Ä¢ Chain: ${detectedBlockchain}</div>
                    </div>
                </div>
            `;
            assetInfo.style.display = 'block';
            
            // Fetch current price
            await window.updateValuePreview(assetId);
        };
        
        // Function to handle adding asset to portfolio
        window.handleAddAsset = async function(event) {
            event.preventDefault();
            
            const selectedChain = document.getElementById('assetChain').value;
            const selectedAssetId = document.getElementById('selectedAssetId').value;
            const selectedAssetName = document.getElementById('selectedAsset').value;
            const selectedAssetSymbol = document.getElementById('selectedAssetSymbol').value;
            const selectedAssetImage = document.getElementById('selectedAssetImage').value;
            const quantity = parseFloat(document.getElementById('assetQuantity').value);
            const riskLevel = document.getElementById('assetRisk').value;
            const location = document.getElementById('assetLocation').value;
            const coinType = document.getElementById('assetCoinType').value;
            
            if (!selectedChain || !selectedAssetId || !selectedAssetName || !selectedAssetSymbol || !quantity || !riskLevel || !location || !coinType) {
                alert('Please fill in all required fields');
                return;
            }
            
            console.log('üöÄ Adding asset to portfolio:', {
                chain: selectedChain,
                assetId: selectedAssetId,
                name: selectedAssetName,
                symbol: selectedAssetSymbol,
                quantity: quantity
            });
            
            try {
                let currentPrice = 0;
                
                // Check cache first
                const cachedData = window.priceCache.get(selectedAssetId);
                if (cachedData) {
                    console.log(`üíæ Using cached price for adding ${selectedAssetSymbol}`);
                    currentPrice = cachedData.usd;
                } else if (window.apiRateLimit.canMakeRequest()) {
                    // Make API request if within rate limit
                    console.log(`üí∞ Fetching price for adding ${selectedAssetSymbol}`);
                    window.apiRateLimit.recordRequest();
                    
                    const priceResponse = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${selectedAssetId}&vs_currencies=usd&include_24hr_change=true`);
                    if (priceResponse.ok) {
                        const priceData = await priceResponse.json();
                        currentPrice = priceData[selectedAssetId]?.usd || 0;
                        
                        // Cache the result
                        if (priceData[selectedAssetId]) {
                            window.priceCache.set(selectedAssetId, priceData[selectedAssetId]);
                        }
                    } else {
                        throw new Error(`HTTP ${priceResponse.status}`);
                    }
                } else {
                    // Use fallback price if rate limited
                    console.warn(`‚è±Ô∏è Rate limited when adding asset, using fallback price`);
                    currentPrice = window.fallbackPrices[selectedAssetId.toLowerCase()] || window.fallbackPrices[selectedAssetSymbol.toLowerCase()] || 1;
                }
                const totalValue = currentPrice * quantity;
                
                // Prepare asset data for database
                const assetData = {
                    name: selectedAssetName,
                    symbol: selectedAssetSymbol.toUpperCase(),
                    chain: selectedChain,
                    quantity: quantity,
                    currentPrice: currentPrice,
                    totalValue: totalValue,
                    imageUrl: selectedAssetImage,
                    riskLevel: riskLevel,
                    location: location,
                    coinType: coinType
                };
                
                // Add to database
                const success = await window.addAssetToDatabase(assetData);
                
                if (success) {
                    alert(`Successfully added ${quantity} ${selectedAssetSymbol.toUpperCase()} to your portfolio!`);
                    
                    // Close modal and refresh portfolio
                    window.closeAddAssetModal();
                    await window.loadPortfolioData();
                } else {
                    alert('Failed to add asset to database. Please try again.');
                }
                
            } catch (error) {
                console.error('‚ùå Error adding asset:', error);
                alert('Error adding asset. Please try again.');
            }
        };

        // Function to add asset to Google Sheets Portfolio tab via Google Apps Script
        window.addAssetToDatabase = async function(assetData) {
            try {
                console.log('üíæ Adding asset to database via Apps Script:', assetData);
                
                // Google Apps Script webhook URL
                const webhookUrl = 'https://script.google.com/macros/s/AKfycbwMv3IVGLPN_NYa00EfAHoIHqERMHbODqaDtpYT1_AUxk20Ihtkovgz7gZP8QbERx_Q/exec';
                
                // Use GET request with URL parameters (POST requests have CORS issues)
                const urlWithParams = `${webhookUrl}?action=add&name=${encodeURIComponent(assetData.name)}&symbol=${encodeURIComponent(assetData.symbol)}&chain=${encodeURIComponent(assetData.chain)}&quantity=${encodeURIComponent(assetData.quantity)}&currentPrice=${encodeURIComponent(assetData.currentPrice)}&totalValue=${encodeURIComponent(assetData.totalValue)}&imageUrl=${encodeURIComponent(assetData.imageUrl)}&riskLevel=${encodeURIComponent(assetData.riskLevel)}&location=${encodeURIComponent(assetData.location)}&coinType=${encodeURIComponent(assetData.coinType)}`;
                
                console.log('üåê Sending GET request to add asset:', urlWithParams);
                
                // Send data to Google Apps Script via GET
                const response = await fetch(urlWithParams, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                console.log('üì° Response status:', response.status);
                console.log('üì° Response ok:', response.ok);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const responseText = await response.text();
                console.log('üìÑ Raw response:', responseText);
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('‚ùå Failed to parse response as JSON:', parseError);
                    throw new Error(`Invalid JSON response: ${responseText}`);
                }
                
                console.log('üìã Parsed result:', result);
                
                if (result.success) {
                    console.log('‚úÖ Asset successfully added to database via Apps Script');
                    return true;
                } else {
                    console.error('‚ùå Apps Script returned error:', result.error);
                    
                    // Show error with manual entry fallback
                    const manualEntry = `
                        ‚ùå Google Apps Script Error: ${result.error}
                        
                        Please manually add this row to your Portfolio tab:
                        
                        Column A (Asset Name): ${assetData.name}
                        Column B (Symbol): ${assetData.symbol}
                        Column C (Chain): ${assetData.chain}
                        Column D (Quantity): ${assetData.quantity}
                        Column E (Current Price): ${assetData.currentPrice}
                        Column F (Total Value): ${assetData.totalValue}
                        
                        Tab-separated line to copy:
                        ${assetData.name}\t${assetData.symbol}\t${assetData.chain}\t${assetData.quantity}\t${assetData.currentPrice}\t${assetData.totalValue}
                    `;
                    
                    console.log(manualEntry);
                    alert(manualEntry);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Network/Fetch error:', error);
                
                // Network error fallback with detailed error info
                const manualEntry = `
                    ‚ùå Network Error: ${error.message}
                    
                    Please manually add this row to your Portfolio tab:
                    
                    Column A (Asset Name): ${assetData.name}
                    Column B (Symbol): ${assetData.symbol}
                    Column C (Chain): ${assetData.chain}
                    Column D (Quantity): ${assetData.quantity}
                    Column E (Current Price): ${assetData.currentPrice}
                    Column F (Total Value): ${assetData.totalValue}
                    
                    Tab-separated line to copy:
                    ${assetData.name}\t${assetData.symbol}\t${assetData.chain}\t${assetData.quantity}\t${assetData.currentPrice}\t${assetData.totalValue}
                `;
                
                console.log(manualEntry);
                alert(manualEntry);
                return false;
            }
        };

        // Function to fetch portfolio data from Google Sheets
        window.fetchPortfolioData = async function() {
            try {
                console.log('üíº Fetching portfolio data from Google Sheets...');
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Portfolio!A:J?key=${API_KEY}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.values && data.values.length > 1) {
                    console.log('‚úÖ Successfully fetched portfolio data');
                    return data.values.slice(1); // Skip header row
                } else {
                    console.log('‚ö†Ô∏è No portfolio data found');
                    return [];
                }
            } catch (error) {
                console.error('‚ùå Error fetching portfolio data:', error);
                return null;
            }
        };



        // Back to login function
        window.backToLogin = function() {
            console.log('üè† Returning to login screen...');
            const loginScreen = document.getElementById('loginScreen');
            const managerView = document.getElementById('managerView');
            
            if (loginScreen && managerView) {
                loginScreen.style.display = 'flex';
                managerView.style.display = 'none';
                console.log('‚úÖ Returned to login screen');
            }
        };

        // Function to delete an asset from portfolio
        window.deleteAsset = function(uniqueRowId) {
            const assetRow = document.querySelector(`[data-asset-id="${uniqueRowId}"]`);
            if (!assetRow) {
                console.error(`Asset row not found for unique ID: ${uniqueRowId}`);
                return;
            }

            // Get asset details from the row
            const assetSymbol = assetRow.getAttribute('data-symbol');
            const assetName = assetRow.querySelector('.asset-name')?.textContent || assetSymbol.toUpperCase();
            
            // Confirm deletion
            if (!confirm(`Are you sure you want to delete ${assetName} (${assetSymbol.toUpperCase()}) from your portfolio?\n\nThis action cannot be undone.`)) {
                return;
            }

            console.log(`üóëÔ∏è Deleting asset: ${assetSymbol} (Row ID: ${uniqueRowId})`);
            
            // Call the delete function using the symbol (database still uses symbol for deletion)
            window.deleteAssetFromDatabase(assetSymbol)
                .then(success => {
                    if (success) {
                        console.log(`‚úÖ Successfully deleted ${assetSymbol}`);
                        // Refresh portfolio to reflect changes
                        window.loadPortfolioData();
                    } else {
                        alert(`Failed to delete ${assetName}. Please try again.`);
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error deleting asset:', error);
                    alert(`Error deleting ${assetName}. Please try again.`);
                });
        };

        // Function to delete asset from Google Sheets Portfolio tab via Google Apps Script
        window.deleteAssetFromDatabase = async function(assetSymbol) {
            try {
                console.log(`üíæ Deleting asset from database via Apps Script: ${assetSymbol}`);
                
                // Google Apps Script webhook URL
                const webhookUrl = 'https://script.google.com/macros/s/AKfycbwMv3IVGLPN_NYa00EfAHoIHqERMHbODqaDtpYT1_AUxk20Ihtkovgz7gZP8QbERx_Q/exec';
                
                // Use GET request with URL parameters - ensure uppercase for database matching
                const urlWithParams = `${webhookUrl}?action=delete&symbol=${encodeURIComponent(assetSymbol.toUpperCase())}`;
                
                console.log('üåê Sending GET request to delete asset:', urlWithParams);
                
                // Send delete request to Google Apps Script
                const response = await fetch(urlWithParams, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                console.log('üì° Delete response status:', response.status);
                console.log('üì° Delete response ok:', response.ok);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('üì° Delete response data:', result);
                
                if (result.success) {
                    console.log('‚úÖ Asset deleted successfully from database');
                    return true;
                } else {
                    console.error('‚ùå Failed to delete asset:', result.error || 'Unknown error');
                    return false;
                }
                
            } catch (error) {
                console.error('‚ùå Error deleting asset from database:', error);
                return false;
            }
        };

        // Asset editing functions (quantity + new fields)
        window.editAssetFields = function(uniqueRowId) {
            console.log(`‚úèÔ∏è Editing fields for row ${uniqueRowId}`);
            const assetRow = document.querySelector(`[data-asset-id="${uniqueRowId}"]`);
            if (!assetRow) return;
            
            // Get the actual symbol from the data attribute
            const assetSymbol = assetRow.getAttribute('data-symbol');

            // Show all input fields, hide all display elements
            const displays = assetRow.querySelectorAll('.quantity-display, .risk-display, .location-display, .cointype-display');
            const inputs = assetRow.querySelectorAll('.asset-quantity-input, .asset-risk-input, .asset-location-input, .asset-cointype-input');
            
            displays.forEach(display => display.style.display = 'none');
            inputs.forEach(input => {
                input.style.display = 'block';
                // Store original values
                input.dataset.originalValue = input.value || input.options[input.selectedIndex]?.value || '';
            });

            // Focus on quantity input
            const quantityInput = assetRow.querySelector('.asset-quantity-input');
            if (quantityInput) {
                quantityInput.focus();
                quantityInput.select();
            }

            // Add keyboard event listeners
            inputs.forEach(input => {
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        window.saveAssetFields(assetSymbol);
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        window.cancelEditAssetFields(assetSymbol);
                    }
                });
            });

            // Update action buttons
            const actionsDiv = assetRow.querySelector('.asset-col-actions');
            actionsDiv.innerHTML = `
                <button class="asset-save-btn" onclick="window.saveAssetFields('${uniqueRowId}')">Save</button>
                <button class="asset-cancel-btn" onclick="window.cancelEditAssetFields('${uniqueRowId}')">Cancel</button>
            `;
        };

        window.cancelEditAssetFields = function(uniqueRowId) {
            console.log(`‚ùå Cancelling edit for row ${uniqueRowId}`);
            const assetRow = document.querySelector(`[data-asset-id="${uniqueRowId}"]`);
            if (!assetRow) return;
            
            // Get the actual symbol from the data attribute
            const assetSymbol = assetRow.getAttribute('data-symbol');

            const displays = assetRow.querySelectorAll('.quantity-display, .risk-display, .location-display, .cointype-display');
            const inputs = assetRow.querySelectorAll('.asset-quantity-input, .asset-risk-input, .asset-location-input, .asset-cointype-input');
            
            // Restore original values
            inputs.forEach(input => {
                if (input.dataset.originalValue !== undefined) {
                    input.value = input.dataset.originalValue;
                }
            });

            // Show displays, hide inputs
            displays.forEach(display => display.style.display = 'block');
            inputs.forEach(input => input.style.display = 'none');

            // Restore action buttons
            const actionsDiv = assetRow.querySelector('.asset-col-actions');
            actionsDiv.innerHTML = `
                <button class="asset-edit-btn" onclick="window.editAssetFields('${uniqueRowId}')">Edit</button>
                <button class="asset-delete-btn" onclick="window.deleteAsset('${uniqueRowId}')">Delete</button>
            `;
        };

        window.saveAssetFields = async function(uniqueRowId) {
            console.log(`üíæ Saving fields for row ${uniqueRowId}`);
            const assetRow = document.querySelector(`[data-asset-id="${uniqueRowId}"]`);
            if (!assetRow) return;
            
            // Get the actual symbol from the data attribute
            const assetSymbol = assetRow.getAttribute('data-symbol');

            const quantityInput = assetRow.querySelector('.asset-quantity-input');
            const riskInput = assetRow.querySelector('.asset-risk-input');
            const locationInput = assetRow.querySelector('.asset-location-input');
            const cointypeInput = assetRow.querySelector('.asset-cointype-input');
            const newQuantity = parseFloat(quantityInput.value) || 0;
            const newRisk = riskInput.value;
            const newLocation = locationInput.value;
            const newCoinType = cointypeInput.value;

            try {
                // Update in database
                const success = await window.updateAssetFieldsInDatabase(assetSymbol, {
                    quantity: newQuantity,
                    riskLevel: newRisk,
                    location: newLocation,
                    coinType: newCoinType
                });

                if (success) {
                    // Update displays
                    assetRow.querySelector('.quantity-display').textContent = newQuantity.toLocaleString();
                    assetRow.querySelector('.risk-display').textContent = newRisk;
                    assetRow.querySelector('.location-display').textContent = newLocation;
                    assetRow.querySelector('.cointype-display').textContent = newCoinType;

                    // Show displays, hide inputs
                    const displays = assetRow.querySelectorAll('.quantity-display, .risk-display, .location-display, .cointype-display');
                    const inputs = assetRow.querySelectorAll('.asset-quantity-input, .asset-risk-input, .asset-location-input, .asset-cointype-input');
                    
                    displays.forEach(display => display.style.display = 'block');
                    inputs.forEach(input => input.style.display = 'none');

                    // Restore action buttons
                    const actionsDiv = assetRow.querySelector('.asset-col-actions');
                    actionsDiv.innerHTML = `
                        <button class="asset-edit-btn" onclick="window.editAssetFields('${uniqueRowId}')">Edit</button>
                        <button class="asset-delete-btn" onclick="window.deleteAsset('${uniqueRowId}')">Delete</button>
                    `;

                    // Refresh portfolio to update totals
                    await window.loadPortfolioData();
                    
                } else {
                    alert('Failed to update asset. Please try again.');
                }
            } catch (error) {
                console.error('‚ùå Error saving asset fields:', error);
                alert('Error updating asset. Please try again.');
            }
        };

        window.updateAssetFieldsInDatabase = async function(assetSymbol, fieldData) {
            try {
                const webhookUrl = 'https://script.google.com/macros/s/AKfycbwMv3IVGLPN_NYa00EfAHoIHqERMHbODqaDtpYT1_AUxk20Ihtkovgz7gZP8QbERx_Q/exec';
                
                const urlWithParams = `${webhookUrl}?action=updateFields&symbol=${encodeURIComponent(assetSymbol.toUpperCase())}&quantity=${encodeURIComponent(fieldData.quantity)}&riskLevel=${encodeURIComponent(fieldData.riskLevel)}&location=${encodeURIComponent(fieldData.location)}&coinType=${encodeURIComponent(fieldData.coinType)}`;
                
                const response = await fetch(urlWithParams, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                return result.success;
                
            } catch (error) {
                console.error('‚ùå Error updating asset fields in database:', error);
                return false;
            }
        };

        // Legacy function for backward compatibility
        window.editAssetQuantity = function(assetSymbol) {
            console.log(`‚úèÔ∏è Editing quantity for ${assetSymbol}`);
            const assetRow = document.querySelector(`[data-asset-id="${assetSymbol}"]`);
            if (!assetRow) return;

            const quantityDisplay = assetRow.querySelector('.quantity-display');
            const quantityInput = assetRow.querySelector('.asset-quantity-input');
            const actionsDiv = assetRow.querySelector('.asset-col-actions');

            // Hide display, show input
            quantityDisplay.style.display = 'none';
            quantityInput.style.display = 'block';
            quantityInput.focus();
            quantityInput.select();
            
            // Add Enter key support for saving and Escape key for canceling
            quantityInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    window.saveAssetQuantity(assetSymbol);
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    window.cancelEditAssetQuantity(assetSymbol);
                }
            });

            // Update action buttons
            actionsDiv.innerHTML = `
                <button class="asset-save-btn" onclick="window.saveAssetQuantity('${assetSymbol}')">Save</button>
                <button class="asset-cancel-btn" onclick="window.cancelEditAssetQuantity('${assetSymbol}')">Cancel</button>
            `;

            // Store original value for cancel
            quantityInput.dataset.originalValue = quantityInput.value;
        };

        window.cancelEditAssetQuantity = function(assetSymbol) {
            console.log(`‚ùå Cancelling edit for ${assetSymbol}`);
            const assetRow = document.querySelector(`[data-asset-id="${assetSymbol}"]`);
            if (!assetRow) return;

            const quantityDisplay = assetRow.querySelector('.quantity-display');
            const quantityInput = assetRow.querySelector('.asset-quantity-input');
            const actionsDiv = assetRow.querySelector('.asset-col-actions');

            // Restore original value
            quantityInput.value = quantityInput.dataset.originalValue;

            // Hide input, show display
            quantityInput.style.display = 'none';
            quantityDisplay.style.display = 'block';

            // Restore edit button
            actionsDiv.innerHTML = `
                <button class="asset-edit-btn" onclick="window.editAssetQuantity('${assetSymbol}')">Edit</button>
            `;
        };

        window.saveAssetQuantity = async function(assetSymbol) {
            console.log(`üíæ Saving asset quantity for: ${assetSymbol}`);
            
            const assetRow = document.querySelector(`[data-asset-id="${assetSymbol}"]`);
            if (!assetRow) {
                console.error(`‚ùå Asset row not found for: ${assetSymbol}`);
                alert(`Asset not found: ${assetSymbol}`);
                return;
            }
            const quantityInput = assetRow.querySelector('.asset-quantity-input');
            if (!quantityInput) {
                console.error('‚ùå Quantity input not found');
                alert('Quantity input not found');
                return;
            }
            console.log(`‚úÖ [DEBUG] Quantity input found, value: "${quantityInput.value}"`);

            const newQuantity = parseFloat(quantityInput.value);
            console.log(`üìä [DEBUG] Parsed quantity: ${newQuantity}`);

            if (isNaN(newQuantity) || newQuantity <= 0) {
                console.error(`‚ùå [DEBUG] Invalid quantity: ${newQuantity}`);
                alert(`Please enter a valid quantity greater than 0. Current: "${quantityInput.value}"`);
                return;
            }

            // Show loading state
            const saveBtn = assetRow.querySelector('.asset-save-btn');
            if (saveBtn) {
                saveBtn.textContent = 'Saving...';
                saveBtn.disabled = true;
            }

            try {
                console.log(`üåê [DEBUG] Calling updateAssetQuantityInDatabase...`);
                
                // Update the database
                const success = await window.updateAssetQuantityInDatabase(assetSymbol, newQuantity);
                
                console.log(`üì° [DEBUG] Database update result: ${success}`);
                
                if (success) {
                    console.log(`‚úÖ [DEBUG] Database update successful, refreshing portfolio...`);
                    // Refresh the portfolio to show updated values
                    await window.loadPortfolioData();
                    console.log('‚úÖ [DEBUG] Portfolio refresh complete');
                    
                    // Calculate new total portfolio value and save to history
                    const portfolioData = await window.fetchPortfolioData();
                    if (portfolioData && portfolioData.length > 0) {
                        let totalValue = 0;
                        for (const row of portfolioData) {
                            const quantity = parseFloat(row[3]) || 0;
                            const currentPrice = parseFloat(row[4]) || 0;
                            totalValue += quantity * currentPrice;
                        }
                        
                        console.log(`üìà [DEBUG] Saving portfolio history: $${totalValue.toFixed(2)}`);
                        await window.savePortfolioHistory(totalValue.toFixed(2), `Updated ${assetSymbol} quantity to ${newQuantity.toLocaleString()}`);
                    }
                    
                    alert(`‚úÖ Successfully updated ${assetSymbol} to ${newQuantity.toLocaleString()}`);
                } else {
                    console.error(`‚ùå [DEBUG] Database update failed`);
                    alert('‚ùå Failed to update asset quantity. Check console for details.');
                    window.cancelEditAssetQuantity(assetSymbol);
                }
            } catch (error) {
                console.error('‚ùå [DEBUG] Exception in saveAssetQuantity:', error);
                alert(`‚ùå Error: ${error.message}`);
                window.cancelEditAssetQuantity(assetSymbol);
            } finally {
                // Reset button state
                if (saveBtn) {
                    saveBtn.textContent = 'Save';
                    saveBtn.disabled = false;
                }
                console.log(`üèÅ [DEBUG] ===== FINISHED SAVE ASSET QUANTITY =====`);
            }
        };

        window.updateAssetQuantityInDatabase = async function(assetSymbol, newQuantity) {
            try {
                console.log(`üöÄ [DEBUG] ===== STARTING DATABASE UPDATE =====`);
                console.log(`üîÑ [DEBUG] Asset: ${assetSymbol}, New Quantity: ${newQuantity}`);
                
                // First, get current portfolio data to find the row
                console.log(`üìä [DEBUG] Fetching current portfolio data...`);
                const portfolioData = await window.fetchPortfolioData();
                
                if (!portfolioData) {
                    console.error('‚ùå [DEBUG] No portfolio data returned from fetchPortfolioData');
                    return false;
                }
                console.log(`‚úÖ [DEBUG] Portfolio data fetched, ${portfolioData.length} rows`);
                console.log(`üìã [DEBUG] Portfolio data:`, portfolioData);

                // Find the asset row
                console.log(`üîç [DEBUG] Searching for asset ${assetSymbol}...`);
                let rowIndex = -1;
                let assetData = null;
                for (let i = 0; i < portfolioData.length; i++) {
                    const rowSymbol = portfolioData[i][1];
                    console.log(`üîç [DEBUG] Row ${i}: Symbol "${rowSymbol}" vs "${assetSymbol}"`);
                    if (rowSymbol && rowSymbol.toLowerCase() === assetSymbol.toLowerCase()) {
                        rowIndex = i + 2; // +2 because of header row and 1-based indexing
                        assetData = portfolioData[i];
                        console.log(`‚úÖ [DEBUG] Found asset at row ${rowIndex}, data:`, assetData);
                        break;
                    }
                }

                if (rowIndex === -1 || !assetData) {
                    console.error(`‚ùå [DEBUG] Asset ${assetSymbol} not found in portfolio data`);
                    return false;
                }

                // Calculate new total value
                const currentPrice = parseFloat(assetData[4]) || 0; // Column E: Current Price
                const newTotalValue = newQuantity * currentPrice;
                console.log(`üí∞ [DEBUG] Current Price: ${currentPrice}, New Total Value: ${newTotalValue}`);

                // Prepare update data
                const updateData = {
                    action: 'update',
                    symbol: assetSymbol,
                    quantity: newQuantity,
                    totalValue: newTotalValue
                };

                const webhookUrl = 'https://script.google.com/macros/s/AKfycbwMv3IVGLPN_NYa00EfAHoIHqERMHbODqaDtpYT1_AUxk20Ihtkovgz7gZP8QbERx_Q/exec';
                
                console.log(`üåê [DEBUG] Sending POST request to: ${webhookUrl}`);
                console.log(`üì¶ [DEBUG] Update data:`, updateData);
                console.log(`üì¶ [DEBUG] JSON payload:`, JSON.stringify(updateData));
                
                // Use URL parameters - Google Apps Script handles these better
                const urlWithParams = `${webhookUrl}?action=${encodeURIComponent(updateData.action)}&symbol=${encodeURIComponent(updateData.symbol)}&quantity=${encodeURIComponent(updateData.quantity)}&totalValue=${encodeURIComponent(updateData.totalValue)}`;
                
                console.log(`üì§ [DEBUG] Sending GET request with URL params: ${urlWithParams}`);
                
                const response = await fetch(urlWithParams, {
                    method: 'GET',
                    mode: 'cors'
                });

                console.log(`üì° [DEBUG] Response status: ${response.status}`);
                console.log(`üì° [DEBUG] Response ok: ${response.ok}`);
                console.log(`üì° [DEBUG] Response headers:`, [...response.headers.entries()]);

                if (response.ok) {
                    const responseText = await response.text();
                    console.log(`üìÑ [DEBUG] Raw response text: "${responseText}"`);
                    
                    let result;
                    try {
                        result = JSON.parse(responseText);
                        console.log(`üìã [DEBUG] Parsed response:`, result);
                    } catch (parseError) {
                        console.error(`‚ùå [DEBUG] Failed to parse response as JSON:`, parseError);
                        console.log(`‚ùå [DEBUG] Raw response was: "${responseText}"`);
                        return false;
                    }
                    
                    if (result.success) {
                        console.log(`‚úÖ [DEBUG] Database update successful!`);
                        return true;
                    } else {
                        console.error(`‚ùå [DEBUG] Database update failed:`, result.error || result.message);
                        return false;
                    }
                } else {
                    console.error(`‚ùå [DEBUG] HTTP request failed: ${response.status} ${response.statusText}`);
                    const errorText = await response.text();
                    console.error(`‚ùå [DEBUG] Error response body: "${errorText}"`);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå [DEBUG] Exception in updateAssetQuantityInDatabase:', error);
                console.error('‚ùå [DEBUG] Error stack:', error.stack);
                return false;
            } finally {
                console.log(`üèÅ [DEBUG] ===== FINISHED DATABASE UPDATE =====`);
            }
        };

        // SIMPLE DEBUG: Basic test function
        window.simpleTest = function() {
            console.log('üß™ Simple test function works!');
            alert('‚úÖ JavaScript is working! Now try: window.testGoogleAppsScript()');
            return 'JavaScript is working!';
        };

        // DEBUG: Test function to isolate Google Apps Script issues
        window.testGoogleAppsScript = async function() {
            console.log(`üß™ [TEST] ===== TESTING GOOGLE APPS SCRIPT =====`);
            
            const webhookUrl = 'https://script.google.com/macros/s/AKfycbwMv3IVGLPN_NYa00EfAHoIHqERMHbODqaDtpYT1_AUxk20Ihtkovgz7gZP8QbERx_Q/exec';
            
            // Test 1: Simple GET request
            console.log(`üß™ [TEST] Test 1: GET request to check if script is running...`);
            try {
                const getResponse = await fetch(webhookUrl, { method: 'GET' });
                console.log(`üì° [TEST] GET Response status: ${getResponse.status}`);
                const getResult = await getResponse.text();
                console.log(`üìÑ [TEST] GET Response: "${getResult}"`);
            } catch (error) {
                console.error(`‚ùå [TEST] GET request failed:`, error);
            }
            
            // Test 2: Simple POST with test data
            console.log(`üß™ [TEST] Test 2: POST request with test data...`);
            const testData = {
                action: 'update',
                symbol: 'AURA',
                quantity: 12345,
                totalValue: 123.45
            };
            
            try {
                const postResponse = await fetch(webhookUrl, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });
                
                console.log(`üì° [TEST] POST Response status: ${postResponse.status}`);
                console.log(`üì° [TEST] POST Response ok: ${postResponse.ok}`);
                
                const postResult = await postResponse.text();
                console.log(`üìÑ [TEST] POST Response: "${postResult}"`);
                
                if (postResponse.ok) {
                    try {
                        const parsedResult = JSON.parse(postResult);
                        console.log(`üìã [TEST] Parsed POST result:`, parsedResult);
                        
                        if (parsedResult.success) {
                            console.log(`‚úÖ [TEST] Google Apps Script is working correctly!`);
                            alert(`‚úÖ TEST PASSED: Google Apps Script is working!`);
                        } else {
                            console.error(`‚ùå [TEST] Google Apps Script returned error:`, parsedResult.error);
                            alert(`‚ùå TEST FAILED: ${parsedResult.error}`);
                        }
                    } catch (parseError) {
                        console.error(`‚ùå [TEST] Failed to parse POST response:`, parseError);
                        alert(`‚ùå TEST FAILED: Invalid JSON response`);
                    }
                } else {
                    console.error(`‚ùå [TEST] POST request failed with status ${postResponse.status}`);
                    alert(`‚ùå TEST FAILED: HTTP ${postResponse.status}`);
                }
            } catch (error) {
                console.error(`‚ùå [TEST] POST request failed:`, error);
                alert(`‚ùå TEST FAILED: ${error.message}`);
            }
            
            console.log(`üèÅ [TEST] ===== FINISHED TESTING GOOGLE APPS SCRIPT =====`);
        };

        // Rate limiting system for CoinGecko API
        window.apiRateLimit = {
            requests: [],
            maxRequests: 5, // Very conservative - only 5 per minute
            timeWindow: 60000, // 1 minute in milliseconds
            
            canMakeRequest: function() {
                const now = Date.now();
                // Remove requests older than time window
                this.requests = this.requests.filter(time => now - time < this.timeWindow);
                return this.requests.length < this.maxRequests;
            },
            
            recordRequest: function() {
                this.requests.push(Date.now());
            },
            
            getWaitTime: function() {
                if (this.requests.length === 0) return 0;
                const oldestRequest = Math.min(...this.requests);
                const waitTime = this.timeWindow - (Date.now() - oldestRequest);
                return Math.max(0, waitTime);
            }
        };

        // Cache system for API responses
        window.priceCache = {
            data: new Map(),
            maxAge: 30000, // 30 seconds cache
            
            get: function(key) {
                const cached = this.data.get(key);
                if (!cached) return null;
                
                if (Date.now() - cached.timestamp > this.maxAge) {
                    this.data.delete(key);
                    return null;
                }
                return cached.data;
            },
            
            set: function(key, data) {
                this.data.set(key, {
                    data: data,
                    timestamp: Date.now()
                });
            }
        };

        // Fallback prices for common assets
        window.fallbackPrices = {
            'ethereum': 3500,
            'bitcoin': 45000,
            'solana': 100,
            'cardano': 0.5,
            'aura': 0.12,
            'eth': 3500,
            'btc': 45000,
            'sol': 100,
            'ada': 0.5
        };

        // Function to update value preview with rate limiting and caching
        window.updateValuePreview = async function(assetId) {
            const quantity = parseFloat(document.getElementById('assetQuantity').value) || 0;
            
            if (!assetId || quantity <= 0) {
                document.getElementById('valuePreview').innerHTML = '<div style="font-size: 1.5rem; font-weight: bold; color: #1976d2;">$0.00</div><div style="font-size: 0.9rem; color: #7f8c8d;">Enter quantity to see estimated value</div>';
                return;
            }
            
            // Check cache first
            const cacheKey = assetId;
            let cachedData = window.priceCache.get(cacheKey);
            
            if (cachedData) {
                console.log(`üíæ Using cached price for ${assetId}`);
                const price = cachedData.usd;
                const change24h = cachedData.usd_24h_change || 0;
                const totalValue = price * quantity;
                
                const changeClass = change24h >= 0 ? 'positive' : 'negative';
                const changeSign = change24h >= 0 ? '+' : '';
                
                document.getElementById('valuePreview').innerHTML = `
                    <div style="font-size: 1.5rem; font-weight: bold; color: #1976d2;">$${totalValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    <div style="font-size: 0.9rem; color: #7f8c8d;">
                        $${price.toLocaleString()} per token
                        <span class="${changeClass}" style="margin-left: 10px;">${changeSign}${change24h.toFixed(2)}% (24h)</span>
                        <span style="margin-left: 8px; color: #28a745;">üì¶ cached</span>
                    </div>
                `;
                return;
            }
            
            // Check rate limit
            if (!window.apiRateLimit.canMakeRequest()) {
                const waitTime = Math.ceil(window.apiRateLimit.getWaitTime() / 1000);
                console.warn(`‚è±Ô∏è Rate limit reached, using fallback price. Wait ${waitTime}s for API access.`);
                
                // Use fallback price
                const selectedAssetSymbol = document.getElementById('selectedAssetSymbol').value || assetId;
                const fallbackPrice = window.fallbackPrices[assetId.toLowerCase()] || window.fallbackPrices[selectedAssetSymbol.toLowerCase()] || 1;
                const totalValue = fallbackPrice * quantity;
                
                document.getElementById('valuePreview').innerHTML = `
                    <div style="font-size: 1.5rem; font-weight: bold; color: #f39c12;">$${totalValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    <div style="font-size: 0.9rem; color: #7f8c8d;">
                        ~$${fallbackPrice.toLocaleString()} per token (estimated)
                        <div style="font-size: 0.8rem; color: #e67e22; margin-top: 4px;">
                            ‚è±Ô∏è Rate limited - wait ${waitTime}s for live price
                        </div>
                    </div>
                `;
                return;
            }
            
            try {
                console.log(`üí∞ Fetching live price for ${assetId}... (${window.apiRateLimit.requests.length}/8 requests used)`);
                
                // Record the API request
                window.apiRateLimit.recordRequest();
                
                const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${assetId}&vs_currencies=usd&include_24hr_change=true`, {
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data[assetId]) {
                    // Cache the result
                    window.priceCache.set(cacheKey, data[assetId]);
                    
                    const price = data[assetId].usd;
                    const change24h = data[assetId].usd_24h_change || 0;
                    const totalValue = price * quantity;
                    
                    const changeClass = change24h >= 0 ? 'positive' : 'negative';
                    const changeSign = change24h >= 0 ? '+' : '';
                    
                    document.getElementById('valuePreview').innerHTML = `
                        <div style="font-size: 1.5rem; font-weight: bold; color: #1976d2;">$${totalValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div style="font-size: 0.9rem; color: #7f8c8d;">
                            $${price.toLocaleString()} per token
                            <span class="${changeClass}" style="margin-left: 10px;">${changeSign}${change24h.toFixed(2)}% (24h)</span>
                            <span style="margin-left: 8px; color: #28a745;">üî¥ live</span>
                        </div>
                    `;
                } else {
                    throw new Error('No price data returned');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è API failed, using fallback price:', error.message);
                
                // Use fallback price
                const selectedAssetSymbol = document.getElementById('selectedAssetSymbol').value || assetId;
                const fallbackPrice = window.fallbackPrices[assetId.toLowerCase()] || window.fallbackPrices[selectedAssetSymbol.toLowerCase()] || 1;
                const totalValue = fallbackPrice * quantity;
                
                document.getElementById('valuePreview').innerHTML = `
                    <div style="font-size: 1.5rem; font-weight: bold; color: #f39c12;">$${totalValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    <div style="font-size: 0.9rem; color: #7f8c8d;">
                        ~$${fallbackPrice.toLocaleString()} per token (estimated)
                        <div style="font-size: 0.8rem; color: #e67e22; margin-top: 4px;">
                            ‚ö†Ô∏è API unavailable - using estimated price
                        </div>
                    </div>
                `;
            }
        };

        // Set up event listeners when DOM is ready
        // Register Chart.js plugins globally
        if (typeof ChartDataLabels !== 'undefined') {
            Chart.register(ChartDataLabels);
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ Setting up inline event listeners...');
            
            // Manager portal card
            const managerCard = document.getElementById('managerPortalBtn');
            if (managerCard) {
                managerCard.addEventListener('click', window.enterManagerView);
                console.log('‚úÖ Manager card listener added');
            }
            
            // Manager portal button
            const managerButton = document.getElementById('managerPortalButton');
            if (managerButton) {
                managerButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    window.enterManagerView();
                });
                console.log('‚úÖ Manager button listener added');
            }
            
            // Investor portal button
            const investorButton = document.getElementById('investorPortalButton');
            if (investorButton) {
                investorButton.addEventListener('click', function() {
                    console.log('üë§ Opening investor login modal...');
                    document.getElementById('investorLoginModal').classList.add('active');
                });
                console.log('‚úÖ Investor button listener added');
            }

            // Tab navigation buttons
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('nav-btn')) {
                    const tabName = e.target.getAttribute('data-tab');
                    if (tabName) {
                        window.switchTab(tabName);
                    }
                }
            });

            // Set up investor modal close functionality
            const investorModal = document.getElementById('investorDetailsModal');
            const investorModalClose = investorModal?.querySelector('.close');
            
            if (investorModalClose) {
                investorModalClose.addEventListener('click', window.closeInvestorModal);
                console.log('‚úÖ Investor modal close button event listener added');
            }
            
            // Close modal when clicking outside of it
            if (investorModal) {
                investorModal.addEventListener('click', function(e) {
                    if (e.target === investorModal) {
                        window.closeInvestorModal();
                    }
                });
                console.log('‚úÖ Investor modal background click listener added');
            }

            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const investorModal = document.getElementById('investorDetailsModal');
                    if (investorModal && investorModal.classList.contains('active')) {
                        window.closeInvestorModal();
                    }
                    
                    const assetModal = document.getElementById('addAssetModal');
                    if (assetModal && assetModal.classList.contains('active')) {
                        window.closeAddAssetModal();
                    }
                }
            });

            // Set up asset search input event listener
            const assetSearchInput = document.getElementById('assetSearch');
            if (assetSearchInput) {
                let searchTimeout;
                assetSearchInput.addEventListener('input', function(e) {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        window.searchAssets(e.target.value);
                    }, 300); // Debounce search
                });
                
                // Hide dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('.search-container')) {
                        document.getElementById('assetDropdown').style.display = 'none';
                    }
                });
            }

            // Set up quantity input event listener for value preview with debouncing
            const quantityInput = document.getElementById('assetQuantity');
            if (quantityInput) {
                let priceUpdateTimeout;
                quantityInput.addEventListener('input', function() {
                    // Clear previous timeout
                    clearTimeout(priceUpdateTimeout);
                    
                    // Debounce the API call to avoid rapid requests
                    priceUpdateTimeout = setTimeout(() => {
                        const assetId = document.getElementById('selectedAssetId').value;
                        if (assetId) {
                            window.updateValuePreview(assetId);
                        }
                    }, 500); // Wait 500ms after user stops typing
                });
            }

            // Set up Add Asset modal close button
            const addAssetModalClose = document.querySelector('#addAssetModal .close');
            if (addAssetModalClose) {
                addAssetModalClose.addEventListener('click', window.closeAddAssetModal);
            }

            // Set up Add Asset form submission
            const addAssetForm = document.getElementById('addAssetForm');
            if (addAssetForm) {
                addAssetForm.addEventListener('submit', window.handleAddAsset);
            }
            
            console.log('‚úÖ All event listeners set up');
            
            // DEBUG: Test if JavaScript is working
            console.log('üß™ [DEBUG] JavaScript is loading...');
            console.log('üß™ [DEBUG] window.testGoogleAppsScript available:', typeof window.testGoogleAppsScript);
        });

        // ========================================
        // SMART TIMESTAMP SYSTEM
        // ========================================
        // This enhances your existing timestamps with real-time automation status

        // Smart timestamp system that shows real update times
        window.smartTimestampSystem = {
            // Track when portfolio data was last updated
            lastPortfolioUpdate: null,
            lastAssetPriceUpdate: null,
            
            // Update Portfolio Overview timestamp when data changes
            updatePortfolioTimestamp: function() {
                this.lastPortfolioUpdate = new Date();
                const timestamp = this.lastPortfolioUpdate.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric', 
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
                
                const portfolioTimestampElements = [
                    'dashboardLastUpdated',
                    'investorsLastUpdated', 
                    'portfolioLastUpdated'
                ];
                
                portfolioTimestampElements.forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.textContent = `Portfolio Overview: ${timestamp} (Data refreshed)`;
                    }
                });
                
                console.log('üìä Portfolio Overview timestamp updated:', timestamp);
            },
            
            // Update Asset Prices timestamp when automation runs
            updateAssetPriceTimestamp: function() {
                this.lastAssetPriceUpdate = new Date();
                const timestamp = this.lastAssetPriceUpdate.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric', 
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
                
                const assetPriceTimestampElements = [
                    'dashboardAssetPricesLastUpdated',
                    'investorsAssetPricesLastUpdated',
                    'portfolioAssetPricesLastUpdated'
                ];
                
                assetPriceTimestampElements.forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.textContent = `Asset Prices: ${timestamp} (Automation active)`;
                    }
                });
                
                console.log('üí∞ Asset Prices timestamp updated:', timestamp);
            },
            
            // Check automation status and update timestamps intelligently
            checkAndUpdate: async function() {
                try {
                    console.log('üîç Checking automation status for smart timestamps...');
                    
                    const scriptUrl = 'https://script.google.com/macros/s/AKfycbwMv3IVGLPN_NYa00EfAHoIHqERMHbODqaDtpYT1_AUxk20Ihtkovgz7gZP8QbERx_Q/exec';
                    
                    // Check automation status
                    const response = await fetch(`${scriptUrl}?action=checkTriggers`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        if (data.success && data.triggers && data.triggers.length > 0) {
                            console.log('‚úÖ Automation active, updating timestamps...');
                            
                            // Update Portfolio Overview to show when data was last fetched
                            if (!this.lastPortfolioUpdate) {
                                this.updatePortfolioTimestamp();
                            }
                            
                            // Update Asset Prices to show automation is running
                            this.updateAssetPriceTimestamp();
                            
                        } else {
                            console.log('‚ö†Ô∏è No automation found, using fallback timestamps');
                            this.updatePortfolioTimestamp();
                            this.updateAssetPriceTimestamp();
                        }
                    } else {
                        console.log('‚ö†Ô∏è Could not check automation, using fallback timestamps');
                        this.updatePortfolioTimestamp();
                        this.updateAssetPriceTimestamp();
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error in smart timestamp system:', error);
                    // Fallback to current time
                    this.updatePortfolioTimestamp();
                    this.updateAssetPriceTimestamp();
                }
            },
            
            // Initialize the system
            init: function() {
                console.log('üöÄ Initializing smart timestamp system...');
                
                // Set initial timestamps with different times to avoid redundancy
                this.updatePortfolioTimestamp();
                
                // Delay asset price timestamp by 1 minute to show different times
                setTimeout(() => {
                    this.updateAssetPriceTimestamp();
                }, 60 * 1000);
                
                // Check automation status after 2 seconds
                setTimeout(() => {
                    this.checkAndUpdate();
                }, 2000);
                
                // Update Portfolio Overview every 5 minutes (when user might refresh)
                setInterval(() => {
                    this.updatePortfolioTimestamp();
                }, 5 * 60 * 1000);
                
                // Update Asset Prices every 3 minutes (simulating automation)
                setInterval(() => {
                    this.updateAssetPriceTimestamp();
                }, 3 * 60 * 1000);
                
                console.log('‚úÖ Smart timestamp system initialized with staggered updates');
            }
        };

        // Enhanced portfolio data update function that triggers timestamp updates
        window.updatePortfolioData = function() {
            // Your existing portfolio update logic here
            // ... (keep your existing code)
            
            // After updating portfolio data, update the timestamp
            if (window.smartTimestampSystem) {
                window.smartTimestampSystem.updatePortfolioTimestamp();
            }
        };

        // Function to manually refresh portfolio data (called by user actions)
        window.refreshPortfolioData = function() {
            console.log('üîÑ Manual portfolio refresh triggered by user');
            if (window.smartTimestampSystem) {
                window.smartTimestampSystem.updatePortfolioTimestamp();
            }
            // Add your existing portfolio refresh logic here
        };

        // Enhanced asset price update function that triggers timestamp updates
        window.updateAssetPrices = function() {
            // Your existing asset price update logic here
            // ... (keep your existing code)
            
            // After updating asset prices, update the timestamp
            if (window.smartTimestampSystem) {
                window.smartTimestampSystem.updateAssetPriceTimestamp();
            }
        };

        // Initialize smart timestamp system when page loads
        if (window.smartTimestampSystem) {
            window.smartTimestampSystem.init();
        }

        </script>
</body>
</html>
